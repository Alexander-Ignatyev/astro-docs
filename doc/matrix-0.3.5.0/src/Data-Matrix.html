<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>Data/Matrix.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a>
<a name="line-2"></a><span class='hs-comment'>-- | Matrix datatype and operations.</span>
<a name="line-3"></a><span class='hs-comment'>--</span>
<a name="line-4"></a><span class='hs-comment'>--   Every provided example has been tested.</span>
<a name="line-5"></a><span class='hs-comment'>--   Run @cabal test@ for further tests.</span>
<a name="line-6"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Matrix</span> <span class='hs-layout'>(</span>
<a name="line-7"></a>    <span class='hs-comment'>-- * Matrix type</span>
<a name="line-8"></a>    <span class='hs-conid'>Matrix</span> <span class='hs-layout'>,</span> <span class='hs-varid'>prettyMatrix</span>
<a name="line-9"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>nrows</span> <span class='hs-layout'>,</span> <span class='hs-varid'>ncols</span>
<a name="line-10"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>forceMatrix</span>
<a name="line-11"></a>    <span class='hs-comment'>-- * Builders</span>
<a name="line-12"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>matrix</span>
<a name="line-13"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>rowVector</span>
<a name="line-14"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>colVector</span>
<a name="line-15"></a>    <span class='hs-comment'>-- ** Special matrices</span>
<a name="line-16"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>zero</span>
<a name="line-17"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>identity</span>
<a name="line-18"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>diagonalList</span>
<a name="line-19"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>diagonal</span>
<a name="line-20"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>permMatrix</span>
<a name="line-21"></a>    <span class='hs-comment'>-- * List conversions</span>
<a name="line-22"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>fromList</span> <span class='hs-layout'>,</span> <span class='hs-varid'>fromLists</span>
<a name="line-23"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>toList</span>   <span class='hs-layout'>,</span> <span class='hs-varid'>toLists</span>
<a name="line-24"></a>    <span class='hs-comment'>-- * Accessing</span>
<a name="line-25"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>getElem</span> <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varop'>!</span><span class='hs-layout'>)</span> <span class='hs-layout'>,</span> <span class='hs-varid'>unsafeGet</span> <span class='hs-layout'>,</span> <span class='hs-varid'>safeGet</span><span class='hs-layout'>,</span> <span class='hs-varid'>safeSet</span>
<a name="line-26"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>getRow</span>  <span class='hs-layout'>,</span> <span class='hs-varid'>getCol</span>
<a name="line-27"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>getDiag</span>
<a name="line-28"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>getMatrixAsVector</span>
<a name="line-29"></a>    <span class='hs-comment'>-- * Manipulating matrices</span>
<a name="line-30"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>setElem</span>
<a name="line-31"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>unsafeSet</span>
<a name="line-32"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>transpose</span> <span class='hs-layout'>,</span> <span class='hs-varid'>setSize</span> <span class='hs-layout'>,</span> <span class='hs-varid'>extendTo</span>
<a name="line-33"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>inverse</span><span class='hs-layout'>,</span> <span class='hs-varid'>rref</span>
<a name="line-34"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>mapRow</span> <span class='hs-layout'>,</span> <span class='hs-varid'>mapCol</span>
<a name="line-35"></a>    <span class='hs-comment'>-- * Submatrices</span>
<a name="line-36"></a>    <span class='hs-comment'>-- ** Splitting blocks</span>
<a name="line-37"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>submatrix</span>
<a name="line-38"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>minorMatrix</span>
<a name="line-39"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>splitBlocks</span>
<a name="line-40"></a>   <span class='hs-comment'>-- ** Joining blocks</span>
<a name="line-41"></a>  <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varop'>&lt;|&gt;</span><span class='hs-layout'>)</span> <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varop'>&lt;-&gt;</span><span class='hs-layout'>)</span>
<a name="line-42"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>joinBlocks</span>
<a name="line-43"></a>    <span class='hs-comment'>-- * Matrix operations</span>
<a name="line-44"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>elementwise</span><span class='hs-layout'>,</span> <span class='hs-varid'>elementwiseUnsafe</span>
<a name="line-45"></a>    <span class='hs-comment'>-- * Matrix multiplication</span>
<a name="line-46"></a>    <span class='hs-comment'>-- ** About matrix multiplication</span>
<a name="line-47"></a>    <span class='hs-comment'>-- $mult</span>
<a name="line-48"></a>
<a name="line-49"></a>    <span class='hs-comment'>-- ** Functions</span>
<a name="line-50"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>multStd</span>
<a name="line-51"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>multStd2</span>
<a name="line-52"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>multStrassen</span>
<a name="line-53"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>multStrassenMixed</span>
<a name="line-54"></a>    <span class='hs-comment'>-- * Linear transformations</span>
<a name="line-55"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>scaleMatrix</span>
<a name="line-56"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>scaleRow</span>
<a name="line-57"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>combineRows</span>
<a name="line-58"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>switchRows</span>
<a name="line-59"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>switchCols</span>
<a name="line-60"></a>    <span class='hs-comment'>-- * Decompositions</span>
<a name="line-61"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>luDecomp</span> <span class='hs-layout'>,</span> <span class='hs-varid'>luDecompUnsafe</span>
<a name="line-62"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>luDecomp'</span><span class='hs-layout'>,</span> <span class='hs-varid'>luDecompUnsafe'</span>
<a name="line-63"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>cholDecomp</span>
<a name="line-64"></a>    <span class='hs-comment'>-- * Properties</span>
<a name="line-65"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>trace</span> <span class='hs-layout'>,</span> <span class='hs-varid'>diagProd</span>
<a name="line-66"></a>    <span class='hs-comment'>-- ** Determinants</span>
<a name="line-67"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>detLaplace</span>
<a name="line-68"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>detLU</span>
<a name="line-69"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>flatten</span>
<a name="line-70"></a>  <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-71"></a>
<a name="line-72"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Prelude</span> <span class='hs-varid'>hiding</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldl1</span><span class='hs-layout'>)</span>
<a name="line-73"></a><span class='hs-comment'>-- Classes</span>
<a name="line-74"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>DeepSeq</span>
<a name="line-75"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span> <span class='hs-layout'>(</span><span class='hs-varid'>forM_</span><span class='hs-layout'>)</span>
<a name="line-76"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Loop</span> <span class='hs-layout'>(</span><span class='hs-varid'>numLoop</span><span class='hs-layout'>,</span><span class='hs-varid'>numLoopFold</span><span class='hs-layout'>)</span>
<a name="line-77"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Foldable</span> <span class='hs-layout'>(</span><span class='hs-conid'>Foldable</span><span class='hs-layout'>,</span> <span class='hs-varid'>foldMap</span><span class='hs-layout'>,</span> <span class='hs-varid'>foldl1</span><span class='hs-layout'>)</span>
<a name="line-78"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Maybe</span>
<a name="line-79"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Monoid</span>
<a name="line-80"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Traversable</span>
<a name="line-81"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Applicative</span><span class='hs-layout'>(</span><span class='hs-conid'>Applicative</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varop'>&lt;$&gt;</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varop'>&lt;*&gt;</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>pure</span><span class='hs-layout'>)</span>
<a name="line-82"></a><span class='hs-comment'>-- Data</span>
<a name="line-83"></a><span class='hs-keyword'>import</span>           <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span><span class='hs-varop'>.</span><span class='hs-conid'>Primitive</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimMonad</span><span class='hs-layout'>,</span> <span class='hs-conid'>PrimState</span><span class='hs-layout'>)</span>
<a name="line-84"></a><span class='hs-keyword'>import</span>           <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>List</span>               <span class='hs-layout'>(</span><span class='hs-varid'>maximumBy</span><span class='hs-layout'>,</span><span class='hs-varid'>foldl1'</span><span class='hs-layout'>)</span>
<a name="line-85"></a><span class='hs-keyword'>import</span>           <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Ord</span>                <span class='hs-layout'>(</span><span class='hs-varid'>comparing</span><span class='hs-layout'>)</span>
<a name="line-86"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Vector</span>             <span class='hs-keyword'>as</span> <span class='hs-conid'>V</span>
<a name="line-87"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Vector</span><span class='hs-varop'>.</span><span class='hs-conid'>Mutable</span>     <span class='hs-keyword'>as</span> <span class='hs-conid'>MV</span>
<a name="line-88"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Maybe</span>
<a name="line-89"></a>
<a name="line-90"></a><span class='hs-comment'>-------------------------------------------------------</span>
<a name="line-91"></a><span class='hs-comment'>-------------------------------------------------------</span>
<a name="line-92"></a><span class='hs-comment'>---- MATRIX TYPE</span>
<a name="line-93"></a>
<a name="line-94"></a><a name="encode"></a><span class='hs-definition'>encode</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Int</span><span class='hs-layout'>,</span><span class='hs-conid'>Int</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-95"></a><span class='hs-comment'>{-# INLINE encode #-}</span>
<a name="line-96"></a><span class='hs-definition'>encode</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span><span class='hs-varid'>j</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span><span class='hs-varop'>*</span><span class='hs-varid'>m</span> <span class='hs-varop'>+</span> <span class='hs-varid'>j</span> <span class='hs-comment'>-</span> <span class='hs-num'>1</span>
<a name="line-97"></a>
<a name="line-98"></a><a name="decode"></a><span class='hs-definition'>decode</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Int</span><span class='hs-layout'>,</span><span class='hs-conid'>Int</span><span class='hs-layout'>)</span>
<a name="line-99"></a><span class='hs-comment'>{-# INLINE decode #-}</span>
<a name="line-100"></a><span class='hs-definition'>decode</span> <span class='hs-varid'>m</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>q</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>,</span><span class='hs-varid'>r</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-101"></a> <span class='hs-keyword'>where</span>
<a name="line-102"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>q</span><span class='hs-layout'>,</span><span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>quotRem</span> <span class='hs-varid'>k</span> <span class='hs-varid'>m</span>
<a name="line-103"></a>
<a name="line-104"></a><a name="Matrix"></a><span class='hs-comment'>-- | Type of matrices.</span>
<a name="line-105"></a><a name="Matrix"></a><span class='hs-comment'>--</span>
<a name="line-106"></a><a name="Matrix"></a><span class='hs-comment'>--   Elements can be of any type. Rows and columns</span>
<a name="line-107"></a><a name="Matrix"></a><span class='hs-comment'>--   are indexed starting by 1. This means that, if @m :: Matrix a@ and</span>
<a name="line-108"></a><a name="Matrix"></a><span class='hs-comment'>--   @i,j :: Int@, then @m ! (i,j)@ is the element in the @i@-th row and</span>
<a name="line-109"></a><a name="Matrix"></a><span class='hs-comment'>--   @j@-th column of @m@.</span>
<a name="line-110"></a><a name="Matrix"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>M</span> <span class='hs-layout'>{</span>
<a name="line-111"></a>   <span class='hs-varid'>nrows</span>     <span class='hs-keyglyph'>::</span> <span class='hs-comment'>{-# UNPACK #-}</span> <span class='hs-varop'>!</span><span class='hs-conid'>Int</span> <span class='hs-comment'>-- ^ Number of rows.</span>
<a name="line-112"></a> <span class='hs-layout'>,</span> <span class='hs-varid'>ncols</span>     <span class='hs-keyglyph'>::</span> <span class='hs-comment'>{-# UNPACK #-}</span> <span class='hs-varop'>!</span><span class='hs-conid'>Int</span> <span class='hs-comment'>-- ^ Number of columns.</span>
<a name="line-113"></a> <span class='hs-layout'>,</span> <span class='hs-varid'>rowOffset</span> <span class='hs-keyglyph'>::</span> <span class='hs-comment'>{-# UNPACK #-}</span> <span class='hs-varop'>!</span><span class='hs-conid'>Int</span>
<a name="line-114"></a> <span class='hs-layout'>,</span> <span class='hs-varid'>colOffset</span> <span class='hs-keyglyph'>::</span> <span class='hs-comment'>{-# UNPACK #-}</span> <span class='hs-varop'>!</span><span class='hs-conid'>Int</span>
<a name="line-115"></a> <span class='hs-layout'>,</span> <span class='hs-varid'>vcols</span>     <span class='hs-keyglyph'>::</span> <span class='hs-comment'>{-# UNPACK #-}</span> <span class='hs-varop'>!</span><span class='hs-conid'>Int</span> <span class='hs-comment'>-- ^ Number of columns of the matrix without offset</span>
<a name="line-116"></a> <span class='hs-layout'>,</span> <span class='hs-varid'>mvect</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-conid'>Vector</span> <span class='hs-varid'>a</span>          <span class='hs-comment'>-- ^ Content of the matrix as a plain vector.</span>
<a name="line-117"></a>   <span class='hs-layout'>}</span>
<a name="line-118"></a>
<a name="line-119"></a><a name="instance%20Eq%20(Matrix%20a)"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Eq</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Eq</span> <span class='hs-layout'>(</span><span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-120"></a>  <span class='hs-varid'>m1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>m2</span> <span class='hs-keyglyph'>=</span>
<a name="line-121"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>r</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nrows</span> <span class='hs-varid'>m1</span>
<a name="line-122"></a>        <span class='hs-varid'>c</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ncols</span> <span class='hs-varid'>m1</span>
<a name="line-123"></a>    <span class='hs-keyword'>in</span>  <span class='hs-varid'>and</span> <span class='hs-varop'>$</span> <span class='hs-layout'>(</span><span class='hs-varid'>r</span> <span class='hs-varop'>==</span> <span class='hs-varid'>nrows</span> <span class='hs-varid'>m2</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-layout'>(</span><span class='hs-varid'>c</span> <span class='hs-varop'>==</span> <span class='hs-varid'>ncols</span> <span class='hs-varid'>m2</span><span class='hs-layout'>)</span>
<a name="line-124"></a>            <span class='hs-conop'>:</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>m1</span> <span class='hs-varop'>!</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span><span class='hs-varid'>j</span><span class='hs-layout'>)</span> <span class='hs-varop'>==</span> <span class='hs-varid'>m2</span> <span class='hs-varop'>!</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span><span class='hs-varid'>j</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>1</span> <span class='hs-keyglyph'>..</span> <span class='hs-varid'>r</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>,</span> <span class='hs-varid'>j</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>1</span> <span class='hs-keyglyph'>..</span> <span class='hs-varid'>c</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>]</span>
<a name="line-125"></a>
<a name="line-126"></a><a name="sizeStr"></a><span class='hs-comment'>-- | Just a cool way to output the size of a matrix.</span>
<a name="line-127"></a><span class='hs-definition'>sizeStr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span>
<a name="line-128"></a><span class='hs-definition'>sizeStr</span> <span class='hs-varid'>n</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>show</span> <span class='hs-varid'>n</span> <span class='hs-varop'>++</span> <span class='hs-str'>"x"</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>m</span>
<a name="line-129"></a>
<a name="line-130"></a><a name="prettyMatrix"></a><span class='hs-comment'>-- | Display a matrix as a 'String' using the 'Show' instance of its elements.</span>
<a name="line-131"></a><span class='hs-definition'>prettyMatrix</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Show</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span>
<a name="line-132"></a><span class='hs-definition'>prettyMatrix</span> <span class='hs-varid'>m</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>M</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unlines</span>
<a name="line-133"></a> <span class='hs-keyglyph'>[</span> <span class='hs-str'>"( "</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>unwords</span> <span class='hs-layout'>(</span><span class='hs-varid'>fmap</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>j</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>fill</span> <span class='hs-varid'>mx</span> <span class='hs-varop'>$</span> <span class='hs-varid'>show</span> <span class='hs-varop'>$</span> <span class='hs-varid'>m</span> <span class='hs-varop'>!</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span><span class='hs-varid'>j</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>1</span><span class='hs-keyglyph'>..</span><span class='hs-varid'>ncols</span> <span class='hs-varid'>m</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-str'>" )"</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>1</span><span class='hs-keyglyph'>..</span><span class='hs-varid'>nrows</span> <span class='hs-varid'>m</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>]</span>
<a name="line-134"></a> <span class='hs-keyword'>where</span>
<a name="line-135"></a>  <span class='hs-varid'>mx</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>maximum</span> <span class='hs-varop'>$</span> <span class='hs-varid'>fmap</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varop'>.</span> <span class='hs-varid'>show</span><span class='hs-layout'>)</span> <span class='hs-varid'>v</span>
<a name="line-136"></a>  <span class='hs-varid'>fill</span> <span class='hs-varid'>k</span> <span class='hs-varid'>str</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>replicate</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span> <span class='hs-comment'>-</span> <span class='hs-varid'>length</span> <span class='hs-varid'>str</span><span class='hs-layout'>)</span> <span class='hs-chr'>' '</span> <span class='hs-varop'>++</span> <span class='hs-varid'>str</span>
<a name="line-137"></a>
<a name="line-138"></a><a name="instance%20Show%20(Matrix%20a)"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Show</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Show</span> <span class='hs-layout'>(</span><span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-139"></a> <span class='hs-varid'>show</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>prettyMatrix</span>
<a name="line-140"></a>
<a name="line-141"></a><a name="instance%20NFData%20(Matrix%20a)"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>NFData</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>NFData</span> <span class='hs-layout'>(</span><span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-142"></a> <span class='hs-varid'>rnf</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rnf</span> <span class='hs-varop'>.</span> <span class='hs-varid'>mvect</span>
<a name="line-143"></a>
<a name="line-144"></a><a name="forceMatrix"></a><span class='hs-comment'>-- | /O(rows*cols)/. Similar to 'V.force'. It copies the matrix content</span>
<a name="line-145"></a><span class='hs-comment'>--   dropping any extra memory.</span>
<a name="line-146"></a><span class='hs-comment'>--</span>
<a name="line-147"></a><span class='hs-comment'>--   Useful when using 'submatrix' from a big matrix.</span>
<a name="line-148"></a><span class='hs-comment'>--</span>
<a name="line-149"></a><span class='hs-definition'>forceMatrix</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span>
<a name="line-150"></a><span class='hs-definition'>forceMatrix</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>matrix</span> <span class='hs-layout'>(</span><span class='hs-varid'>nrows</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ncols</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span><span class='hs-varid'>j</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>unsafeGet</span> <span class='hs-varid'>i</span> <span class='hs-varid'>j</span> <span class='hs-varid'>m</span>
<a name="line-151"></a>
<a name="line-152"></a><span class='hs-comment'>-------------------------------------------------------</span>
<a name="line-153"></a><span class='hs-comment'>-------------------------------------------------------</span>
<a name="line-154"></a><span class='hs-comment'>---- FUNCTOR INSTANCE</span>
<a name="line-155"></a>
<a name="line-156"></a><a name="instance%20Functor%20Matrix"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Functor</span> <span class='hs-conid'>Matrix</span> <span class='hs-keyword'>where</span>
<a name="line-157"></a> <span class='hs-comment'>{-# INLINE fmap #-}</span>
<a name="line-158"></a> <span class='hs-varid'>fmap</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-conid'>M</span> <span class='hs-varid'>n</span> <span class='hs-varid'>m</span> <span class='hs-varid'>ro</span> <span class='hs-varid'>co</span> <span class='hs-varid'>w</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>M</span> <span class='hs-varid'>n</span> <span class='hs-varid'>m</span> <span class='hs-varid'>ro</span> <span class='hs-varid'>co</span> <span class='hs-varid'>w</span> <span class='hs-varop'>$</span> <span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>map</span> <span class='hs-varid'>f</span> <span class='hs-varid'>v</span>
<a name="line-159"></a>
<a name="line-160"></a><span class='hs-comment'>-------------------------------------------------------</span>
<a name="line-161"></a><span class='hs-comment'>-------------------------------------------------------</span>
<a name="line-162"></a>
<a name="line-163"></a><span class='hs-comment'>-------------------------------------------------------</span>
<a name="line-164"></a><span class='hs-comment'>-------------------------------------------------------</span>
<a name="line-165"></a><span class='hs-comment'>---- MONOID INSTANCE</span>
<a name="line-166"></a>
<a name="line-167"></a><a name="instance%20Monoid%20(Matrix%20a)"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Monoid</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Monoid</span> <span class='hs-layout'>(</span><span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-168"></a>  <span class='hs-varid'>mempty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromList</span> <span class='hs-num'>1</span> <span class='hs-num'>1</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>mempty</span><span class='hs-keyglyph'>]</span> 
<a name="line-169"></a>  <span class='hs-varid'>mappend</span> <span class='hs-varid'>m</span> <span class='hs-varid'>m'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>matrix</span> <span class='hs-layout'>(</span><span class='hs-varid'>max</span> <span class='hs-layout'>(</span><span class='hs-varid'>nrows</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>nrows</span> <span class='hs-varid'>m'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>max</span> <span class='hs-layout'>(</span><span class='hs-varid'>ncols</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ncols</span> <span class='hs-varid'>m'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>uncurry</span> <span class='hs-varid'>zipTogether</span>
<a name="line-170"></a>    <span class='hs-keyword'>where</span> <span class='hs-varid'>zipTogether</span> <span class='hs-varid'>row</span> <span class='hs-varid'>column</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromMaybe</span> <span class='hs-varid'>mempty</span> <span class='hs-varop'>$</span> <span class='hs-varid'>safeGet</span> <span class='hs-varid'>row</span> <span class='hs-varid'>column</span> <span class='hs-varid'>m</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>safeGet</span> <span class='hs-varid'>row</span> <span class='hs-varid'>column</span> <span class='hs-varid'>m'</span>
<a name="line-171"></a>
<a name="line-172"></a>
<a name="line-173"></a><span class='hs-comment'>-------------------------------------------------------</span>
<a name="line-174"></a><span class='hs-comment'>-------------------------------------------------------</span>
<a name="line-175"></a><span class='hs-comment'>-------------------------------------------------------</span>
<a name="line-176"></a><span class='hs-comment'>-------------------------------------------------------</span>
<a name="line-177"></a>
<a name="line-178"></a><span class='hs-comment'>-------------------------------------------------------</span>
<a name="line-179"></a><span class='hs-comment'>-------------------------------------------------------</span>
<a name="line-180"></a><span class='hs-comment'>---- APPLICATIVE INSTANCE</span>
<a name="line-181"></a><span class='hs-comment'>---- Works like tensor product but applies a function </span>
<a name="line-182"></a>
<a name="line-183"></a><a name="instance%20Applicative%20Matrix"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Applicative</span> <span class='hs-conid'>Matrix</span> <span class='hs-keyword'>where</span>
<a name="line-184"></a>  <span class='hs-varid'>pure</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromList</span> <span class='hs-num'>1</span> <span class='hs-num'>1</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>x</span><span class='hs-keyglyph'>]</span> 
<a name="line-185"></a>  <span class='hs-varid'>m</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>m'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>flatten</span> <span class='hs-varop'>$</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>f</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>f</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>m'</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-186"></a>
<a name="line-187"></a>
<a name="line-188"></a><span class='hs-comment'>-------------------------------------------------------</span>
<a name="line-189"></a><span class='hs-comment'>-------------------------------------------------------</span>
<a name="line-190"></a>
<a name="line-191"></a>
<a name="line-192"></a>
<a name="line-193"></a><a name="flatten"></a><span class='hs-comment'>-- | Flatten a matrix of matrices. All sub matrices must have same dimensions</span>
<a name="line-194"></a><span class='hs-comment'>--   This criteria is not checked. </span>
<a name="line-195"></a><span class='hs-definition'>flatten</span><span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Matrix</span> <span class='hs-layout'>(</span><span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span>
<a name="line-196"></a><span class='hs-definition'>flatten</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldl1</span> <span class='hs-layout'>(</span><span class='hs-varop'>&lt;-&gt;</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldl1</span> <span class='hs-layout'>(</span><span class='hs-varop'>&lt;|&gt;</span><span class='hs-layout'>)</span> <span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>i</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>getRow</span> <span class='hs-varid'>i</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>1</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>(</span><span class='hs-varid'>nrows</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-197"></a>
<a name="line-198"></a><a name="mapRow"></a><span class='hs-comment'>-- | /O(rows*cols)/. Map a function over a row.</span>
<a name="line-199"></a><span class='hs-comment'>--   Example:</span>
<a name="line-200"></a><span class='hs-comment'>--</span>
<a name="line-201"></a><span class='hs-comment'>-- &gt;                          ( 1 2 3 )   ( 1 2 3 )</span>
<a name="line-202"></a><span class='hs-comment'>-- &gt;                          ( 4 5 6 )   ( 5 6 7 )</span>
<a name="line-203"></a><span class='hs-comment'>-- &gt; mapRow (\_ x -&gt; x + 1) 2 ( 7 8 9 ) = ( 7 8 9 )</span>
<a name="line-204"></a><span class='hs-comment'>--</span>
<a name="line-205"></a><span class='hs-definition'>mapRow</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- ^ Function takes the current column as additional argument.</span>
<a name="line-206"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>            <span class='hs-comment'>-- ^ Row to map.</span>
<a name="line-207"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span>
<a name="line-208"></a><span class='hs-definition'>mapRow</span> <span class='hs-varid'>f</span> <span class='hs-varid'>r</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span>
<a name="line-209"></a>  <span class='hs-varid'>matrix</span> <span class='hs-layout'>(</span><span class='hs-varid'>nrows</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ncols</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span><span class='hs-varid'>j</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-210"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsafeGet</span> <span class='hs-varid'>i</span> <span class='hs-varid'>j</span> <span class='hs-varid'>m</span>
<a name="line-211"></a>    <span class='hs-keyword'>in</span>  <span class='hs-keyword'>if</span> <span class='hs-varid'>i</span> <span class='hs-varop'>==</span> <span class='hs-varid'>r</span>
<a name="line-212"></a>           <span class='hs-keyword'>then</span> <span class='hs-varid'>f</span> <span class='hs-varid'>j</span> <span class='hs-varid'>a</span>
<a name="line-213"></a>           <span class='hs-keyword'>else</span> <span class='hs-varid'>a</span>
<a name="line-214"></a>
<a name="line-215"></a><a name="mapCol"></a><span class='hs-comment'>-- | /O(rows*cols)/. Map a function over a column.</span>
<a name="line-216"></a><span class='hs-comment'>--   Example:</span>
<a name="line-217"></a><span class='hs-comment'>--</span>
<a name="line-218"></a><span class='hs-comment'>-- &gt;                          ( 1 2 3 )   ( 1 3 3 )</span>
<a name="line-219"></a><span class='hs-comment'>-- &gt;                          ( 4 5 6 )   ( 4 6 6 )</span>
<a name="line-220"></a><span class='hs-comment'>-- &gt; mapCol (\_ x -&gt; x + 1) 2 ( 7 8 9 ) = ( 7 9 9 )</span>
<a name="line-221"></a><span class='hs-comment'>--</span>
<a name="line-222"></a><span class='hs-definition'>mapCol</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- ^ Function takes the current row as additional argument.</span>
<a name="line-223"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>            <span class='hs-comment'>-- ^ Column to map.</span>
<a name="line-224"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span>
<a name="line-225"></a><span class='hs-definition'>mapCol</span> <span class='hs-varid'>f</span> <span class='hs-varid'>c</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span>
<a name="line-226"></a>  <span class='hs-varid'>matrix</span> <span class='hs-layout'>(</span><span class='hs-varid'>nrows</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ncols</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span><span class='hs-varid'>j</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-227"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsafeGet</span> <span class='hs-varid'>i</span> <span class='hs-varid'>j</span> <span class='hs-varid'>m</span>
<a name="line-228"></a>    <span class='hs-keyword'>in</span>  <span class='hs-keyword'>if</span> <span class='hs-varid'>j</span> <span class='hs-varop'>==</span> <span class='hs-varid'>c</span>
<a name="line-229"></a>           <span class='hs-keyword'>then</span> <span class='hs-varid'>f</span> <span class='hs-varid'>i</span> <span class='hs-varid'>a</span>
<a name="line-230"></a>           <span class='hs-keyword'>else</span> <span class='hs-varid'>a</span>
<a name="line-231"></a>
<a name="line-232"></a><span class='hs-comment'>-------------------------------------------------------</span>
<a name="line-233"></a><span class='hs-comment'>-------------------------------------------------------</span>
<a name="line-234"></a><span class='hs-comment'>---- FOLDABLE AND TRAVERSABLE INSTANCES</span>
<a name="line-235"></a>
<a name="line-236"></a><a name="instance%20Foldable%20Matrix"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Foldable</span> <span class='hs-conid'>Matrix</span> <span class='hs-keyword'>where</span>
<a name="line-237"></a> <span class='hs-varid'>foldMap</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldMap</span> <span class='hs-varid'>f</span> <span class='hs-varop'>.</span> <span class='hs-varid'>mvect</span> <span class='hs-varop'>.</span> <span class='hs-varid'>forceMatrix</span>
<a name="line-238"></a>
<a name="line-239"></a><a name="instance%20Traversable%20Matrix"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Traversable</span> <span class='hs-conid'>Matrix</span> <span class='hs-keyword'>where</span>
<a name="line-240"></a> <span class='hs-varid'>sequenceA</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-layout'>(</span><span class='hs-conid'>M</span> <span class='hs-layout'>(</span><span class='hs-varid'>nrows</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ncols</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-num'>0</span> <span class='hs-num'>0</span> <span class='hs-layout'>(</span><span class='hs-varid'>ncols</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>.</span> <span class='hs-varid'>sequenceA</span> <span class='hs-varop'>.</span> <span class='hs-varid'>mvect</span> <span class='hs-varop'>$</span> <span class='hs-varid'>forceMatrix</span> <span class='hs-varid'>m</span>
<a name="line-241"></a>
<a name="line-242"></a><span class='hs-comment'>-------------------------------------------------------</span>
<a name="line-243"></a><span class='hs-comment'>-------------------------------------------------------</span>
<a name="line-244"></a><span class='hs-comment'>---- BUILDERS</span>
<a name="line-245"></a>
<a name="line-246"></a><a name="zero"></a><span class='hs-comment'>-- | /O(rows*cols)/. The zero matrix of the given size.</span>
<a name="line-247"></a><span class='hs-comment'>--</span>
<a name="line-248"></a><span class='hs-comment'>-- &gt; zero n m =</span>
<a name="line-249"></a><span class='hs-comment'>-- &gt;                 m</span>
<a name="line-250"></a><span class='hs-comment'>-- &gt;   1 ( 0 0 ... 0 0 )</span>
<a name="line-251"></a><span class='hs-comment'>-- &gt;   2 ( 0 0 ... 0 0 )</span>
<a name="line-252"></a><span class='hs-comment'>-- &gt;     (     ...     )</span>
<a name="line-253"></a><span class='hs-comment'>-- &gt;     ( 0 0 ... 0 0 )</span>
<a name="line-254"></a><span class='hs-comment'>-- &gt;   n ( 0 0 ... 0 0 )</span>
<a name="line-255"></a><span class='hs-definition'>zero</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Num</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span>
<a name="line-256"></a>     <span class='hs-conid'>Int</span> <span class='hs-comment'>-- ^ Rows</span>
<a name="line-257"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-comment'>-- ^ Columns</span>
<a name="line-258"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span>
<a name="line-259"></a><span class='hs-comment'>{-# INLINE zero #-}</span>
<a name="line-260"></a><span class='hs-definition'>zero</span> <span class='hs-varid'>n</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>M</span> <span class='hs-varid'>n</span> <span class='hs-varid'>m</span> <span class='hs-num'>0</span> <span class='hs-num'>0</span> <span class='hs-varid'>m</span> <span class='hs-varop'>$</span> <span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>replicate</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-varop'>*</span><span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-num'>0</span>
<a name="line-261"></a>
<a name="line-262"></a><a name="matrix"></a><span class='hs-comment'>-- | /O(rows*cols)/. Generate a matrix from a generator function.</span>
<a name="line-263"></a><span class='hs-comment'>--   Example of usage:</span>
<a name="line-264"></a><span class='hs-comment'>--</span>
<a name="line-265"></a><span class='hs-comment'>-- &gt;                                  (  1  0 -1 -2 )</span>
<a name="line-266"></a><span class='hs-comment'>-- &gt;                                  (  3  2  1  0 )</span>
<a name="line-267"></a><span class='hs-comment'>-- &gt;                                  (  5  4  3  2 )</span>
<a name="line-268"></a><span class='hs-comment'>-- &gt; matrix 4 4 $ \(i,j) -&gt; 2*i - j = (  7  6  5  4 )</span>
<a name="line-269"></a><span class='hs-definition'>matrix</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-comment'>-- ^ Rows</span>
<a name="line-270"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-comment'>-- ^ Columns</span>
<a name="line-271"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-conid'>Int</span><span class='hs-layout'>,</span><span class='hs-conid'>Int</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- ^ Generator function</span>
<a name="line-272"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span>
<a name="line-273"></a><span class='hs-comment'>{-# INLINE matrix #-}</span>
<a name="line-274"></a><span class='hs-definition'>matrix</span> <span class='hs-varid'>n</span> <span class='hs-varid'>m</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>M</span> <span class='hs-varid'>n</span> <span class='hs-varid'>m</span> <span class='hs-num'>0</span> <span class='hs-num'>0</span> <span class='hs-varid'>m</span> <span class='hs-varop'>$</span> <span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>create</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-275"></a>  <span class='hs-varid'>v</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>MV</span><span class='hs-varop'>.</span><span class='hs-varid'>new</span> <span class='hs-varop'>$</span> <span class='hs-varid'>n</span> <span class='hs-varop'>*</span> <span class='hs-varid'>m</span>
<a name="line-276"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>en</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>encode</span> <span class='hs-varid'>m</span>
<a name="line-277"></a>  <span class='hs-varid'>numLoop</span> <span class='hs-num'>1</span> <span class='hs-varid'>n</span> <span class='hs-varop'>$</span>
<a name="line-278"></a>    <span class='hs-keyglyph'>\</span><span class='hs-varid'>i</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>numLoop</span> <span class='hs-num'>1</span> <span class='hs-varid'>m</span> <span class='hs-varop'>$</span>
<a name="line-279"></a>    <span class='hs-keyglyph'>\</span><span class='hs-varid'>j</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MV</span><span class='hs-varop'>.</span><span class='hs-varid'>unsafeWrite</span> <span class='hs-varid'>v</span> <span class='hs-layout'>(</span><span class='hs-varid'>en</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span><span class='hs-varid'>j</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span><span class='hs-varid'>j</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-280"></a>  <span class='hs-varid'>return</span> <span class='hs-varid'>v</span>
<a name="line-281"></a>
<a name="line-282"></a><a name="identity"></a><span class='hs-comment'>-- | /O(rows*cols)/. Identity matrix of the given order.</span>
<a name="line-283"></a><span class='hs-comment'>--</span>
<a name="line-284"></a><span class='hs-comment'>-- &gt; identity n =</span>
<a name="line-285"></a><span class='hs-comment'>-- &gt;                 n</span>
<a name="line-286"></a><span class='hs-comment'>-- &gt;   1 ( 1 0 ... 0 0 )</span>
<a name="line-287"></a><span class='hs-comment'>-- &gt;   2 ( 0 1 ... 0 0 )</span>
<a name="line-288"></a><span class='hs-comment'>-- &gt;     (     ...     )</span>
<a name="line-289"></a><span class='hs-comment'>-- &gt;     ( 0 0 ... 1 0 )</span>
<a name="line-290"></a><span class='hs-comment'>-- &gt;   n ( 0 0 ... 0 1 )</span>
<a name="line-291"></a><span class='hs-comment'>--</span>
<a name="line-292"></a><span class='hs-definition'>identity</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Num</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span>
<a name="line-293"></a><span class='hs-definition'>identity</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>matrix</span> <span class='hs-varid'>n</span> <span class='hs-varid'>n</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span><span class='hs-varid'>j</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>i</span> <span class='hs-varop'>==</span> <span class='hs-varid'>j</span> <span class='hs-keyword'>then</span> <span class='hs-num'>1</span> <span class='hs-keyword'>else</span> <span class='hs-num'>0</span>
<a name="line-294"></a>
<a name="line-295"></a><a name="diagonal"></a><span class='hs-comment'>-- | Similar to 'diagonalList', but using 'V.Vector', which</span>
<a name="line-296"></a><span class='hs-comment'>--   should be more efficient.</span>
<a name="line-297"></a><span class='hs-definition'>diagonal</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>a</span> <span class='hs-comment'>-- ^ Default element</span>
<a name="line-298"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-conid'>Vector</span> <span class='hs-varid'>a</span>  <span class='hs-comment'>-- ^ Diagonal vector</span>
<a name="line-299"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span>
<a name="line-300"></a><span class='hs-definition'>diagonal</span> <span class='hs-varid'>e</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>matrix</span> <span class='hs-varid'>n</span> <span class='hs-varid'>n</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span><span class='hs-varid'>j</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>i</span> <span class='hs-varop'>==</span> <span class='hs-varid'>j</span> <span class='hs-keyword'>then</span> <span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>unsafeIndex</span> <span class='hs-varid'>v</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span> <span class='hs-comment'>-</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>e</span>
<a name="line-301"></a>  <span class='hs-keyword'>where</span>
<a name="line-302"></a>    <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>length</span> <span class='hs-varid'>v</span>
<a name="line-303"></a>
<a name="line-304"></a><a name="fromList"></a><span class='hs-comment'>-- | Create a matrix from a non-empty list given the desired size.</span>
<a name="line-305"></a><span class='hs-comment'>--   The list must have at least /rows*cols/ elements.</span>
<a name="line-306"></a><span class='hs-comment'>--   An example:</span>
<a name="line-307"></a><span class='hs-comment'>--</span>
<a name="line-308"></a><span class='hs-comment'>-- &gt;                       ( 1 2 3 )</span>
<a name="line-309"></a><span class='hs-comment'>-- &gt;                       ( 4 5 6 )</span>
<a name="line-310"></a><span class='hs-comment'>-- &gt; fromList 3 3 [1..] =  ( 7 8 9 )</span>
<a name="line-311"></a><span class='hs-comment'>--</span>
<a name="line-312"></a><span class='hs-definition'>fromList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-comment'>-- ^ Rows</span>
<a name="line-313"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-comment'>-- ^ Columns</span>
<a name="line-314"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- ^ List of elements</span>
<a name="line-315"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span>
<a name="line-316"></a><span class='hs-comment'>{-# INLINE fromList #-}</span>
<a name="line-317"></a><span class='hs-definition'>fromList</span> <span class='hs-varid'>n</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>M</span> <span class='hs-varid'>n</span> <span class='hs-varid'>m</span> <span class='hs-num'>0</span> <span class='hs-num'>0</span> <span class='hs-varid'>m</span> <span class='hs-varop'>.</span> <span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>fromListN</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-varop'>*</span><span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-318"></a>
<a name="line-319"></a><a name="toList"></a><span class='hs-comment'>-- | Get the elements of a matrix stored in a list.</span>
<a name="line-320"></a><span class='hs-comment'>--</span>
<a name="line-321"></a><span class='hs-comment'>-- &gt;        ( 1 2 3 )</span>
<a name="line-322"></a><span class='hs-comment'>-- &gt;        ( 4 5 6 )</span>
<a name="line-323"></a><span class='hs-comment'>-- &gt; toList ( 7 8 9 ) = [1,2,3,4,5,6,7,8,9]</span>
<a name="line-324"></a><span class='hs-comment'>--</span>
<a name="line-325"></a><span class='hs-definition'>toList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span>
<a name="line-326"></a><span class='hs-definition'>toList</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>unsafeGet</span> <span class='hs-varid'>i</span> <span class='hs-varid'>j</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>1</span> <span class='hs-keyglyph'>..</span> <span class='hs-varid'>nrows</span> <span class='hs-varid'>m</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>,</span> <span class='hs-varid'>j</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>1</span> <span class='hs-keyglyph'>..</span> <span class='hs-varid'>ncols</span> <span class='hs-varid'>m</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>]</span>
<a name="line-327"></a>
<a name="line-328"></a><a name="toLists"></a><span class='hs-comment'>-- | Get the elements of a matrix stored in a list of lists,</span>
<a name="line-329"></a><span class='hs-comment'>--   where each list contains the elements of a single row.</span>
<a name="line-330"></a><span class='hs-comment'>--</span>
<a name="line-331"></a><span class='hs-comment'>-- &gt;         ( 1 2 3 )   [ [1,2,3]</span>
<a name="line-332"></a><span class='hs-comment'>-- &gt;         ( 4 5 6 )   , [4,5,6]</span>
<a name="line-333"></a><span class='hs-comment'>-- &gt; toLists ( 7 8 9 ) = , [7,8,9] ]</span>
<a name="line-334"></a><span class='hs-comment'>--</span>
<a name="line-335"></a><span class='hs-definition'>toLists</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span>
<a name="line-336"></a><span class='hs-definition'>toLists</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>unsafeGet</span> <span class='hs-varid'>i</span> <span class='hs-varid'>j</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>j</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>1</span> <span class='hs-keyglyph'>..</span> <span class='hs-varid'>ncols</span> <span class='hs-varid'>m</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>1</span> <span class='hs-keyglyph'>..</span> <span class='hs-varid'>nrows</span> <span class='hs-varid'>m</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>]</span>
<a name="line-337"></a>
<a name="line-338"></a><a name="diagonalList"></a><span class='hs-comment'>-- | Diagonal matrix from a non-empty list given the desired size.</span>
<a name="line-339"></a><span class='hs-comment'>--   Non-diagonal elements will be filled with the given default element.</span>
<a name="line-340"></a><span class='hs-comment'>--   The list must have at least /order/ elements.</span>
<a name="line-341"></a><span class='hs-comment'>--</span>
<a name="line-342"></a><span class='hs-comment'>-- &gt; diagonalList n 0 [1..] =</span>
<a name="line-343"></a><span class='hs-comment'>-- &gt;                   n</span>
<a name="line-344"></a><span class='hs-comment'>-- &gt;   1 ( 1 0 ... 0   0 )</span>
<a name="line-345"></a><span class='hs-comment'>-- &gt;   2 ( 0 2 ... 0   0 )</span>
<a name="line-346"></a><span class='hs-comment'>-- &gt;     (     ...       )</span>
<a name="line-347"></a><span class='hs-comment'>-- &gt;     ( 0 0 ... n-1 0 )</span>
<a name="line-348"></a><span class='hs-comment'>-- &gt;   n ( 0 0 ... 0   n )</span>
<a name="line-349"></a><span class='hs-comment'>--</span>
<a name="line-350"></a><span class='hs-definition'>diagonalList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span>
<a name="line-351"></a><span class='hs-definition'>diagonalList</span> <span class='hs-varid'>n</span> <span class='hs-varid'>e</span> <span class='hs-varid'>xs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>matrix</span> <span class='hs-varid'>n</span> <span class='hs-varid'>n</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span><span class='hs-varid'>j</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>i</span> <span class='hs-varop'>==</span> <span class='hs-varid'>j</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>xs</span> <span class='hs-varop'>!!</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span> <span class='hs-comment'>-</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>e</span>
<a name="line-352"></a>
<a name="line-353"></a><a name="fromLists"></a><span class='hs-comment'>-- | Create a matrix from a non-empty list of non-empty lists.</span>
<a name="line-354"></a><span class='hs-comment'>--   /Each list must have at least as many elements as the first list/.</span>
<a name="line-355"></a><span class='hs-comment'>--   Examples:</span>
<a name="line-356"></a><span class='hs-comment'>--</span>
<a name="line-357"></a><span class='hs-comment'>-- &gt; fromLists [ [1,2,3]      ( 1 2 3 )</span>
<a name="line-358"></a><span class='hs-comment'>-- &gt;           , [4,5,6]      ( 4 5 6 )</span>
<a name="line-359"></a><span class='hs-comment'>-- &gt;           , [7,8,9] ] =  ( 7 8 9 )</span>
<a name="line-360"></a><span class='hs-comment'>--</span>
<a name="line-361"></a><span class='hs-comment'>-- &gt; fromLists [ [1,2,3  ]     ( 1 2 3 )</span>
<a name="line-362"></a><span class='hs-comment'>-- &gt;           , [4,5,6,7]     ( 4 5 6 )</span>
<a name="line-363"></a><span class='hs-comment'>-- &gt;           , [8,9,0  ] ] = ( 8 9 0 )</span>
<a name="line-364"></a><span class='hs-comment'>--</span>
<a name="line-365"></a><span class='hs-definition'>fromLists</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span>
<a name="line-366"></a><span class='hs-comment'>{-# INLINE fromLists #-}</span>
<a name="line-367"></a><span class='hs-definition'>fromLists</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>error</span> <span class='hs-str'>"fromLists: empty list."</span>
<a name="line-368"></a><span class='hs-definition'>fromLists</span> <span class='hs-layout'>(</span><span class='hs-varid'>xs</span><span class='hs-conop'>:</span><span class='hs-varid'>xss</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromList</span> <span class='hs-varid'>n</span> <span class='hs-varid'>m</span> <span class='hs-varop'>$</span> <span class='hs-varid'>concat</span> <span class='hs-varop'>$</span> <span class='hs-varid'>xs</span> <span class='hs-conop'>:</span> <span class='hs-varid'>fmap</span> <span class='hs-layout'>(</span><span class='hs-varid'>take</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-varid'>xss</span>
<a name="line-369"></a>  <span class='hs-keyword'>where</span>
<a name="line-370"></a>    <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>length</span> <span class='hs-varid'>xss</span>
<a name="line-371"></a>    <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>xs</span>
<a name="line-372"></a>
<a name="line-373"></a><a name="rowVector"></a><span class='hs-comment'>-- | /O(1)/. Represent a vector as a one row matrix.</span>
<a name="line-374"></a><span class='hs-definition'>rowVector</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-conid'>Vector</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span>
<a name="line-375"></a><span class='hs-definition'>rowVector</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>M</span> <span class='hs-num'>1</span> <span class='hs-varid'>m</span> <span class='hs-num'>0</span> <span class='hs-num'>0</span> <span class='hs-varid'>m</span> <span class='hs-varid'>v</span>
<a name="line-376"></a>  <span class='hs-keyword'>where</span>
<a name="line-377"></a>    <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>length</span> <span class='hs-varid'>v</span>
<a name="line-378"></a>
<a name="line-379"></a><a name="colVector"></a><span class='hs-comment'>-- | /O(1)/. Represent a vector as a one column matrix.</span>
<a name="line-380"></a><span class='hs-definition'>colVector</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-conid'>Vector</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span>
<a name="line-381"></a><span class='hs-definition'>colVector</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>M</span> <span class='hs-layout'>(</span><span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>length</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-num'>1</span> <span class='hs-num'>0</span> <span class='hs-num'>0</span> <span class='hs-num'>1</span> <span class='hs-varid'>v</span>
<a name="line-382"></a>
<a name="line-383"></a><a name="permMatrix"></a><span class='hs-comment'>-- | /O(rows*cols)/. Permutation matrix.</span>
<a name="line-384"></a><span class='hs-comment'>--</span>
<a name="line-385"></a><span class='hs-comment'>-- &gt; permMatrix n i j =</span>
<a name="line-386"></a><span class='hs-comment'>-- &gt;               i     j       n</span>
<a name="line-387"></a><span class='hs-comment'>-- &gt;   1 ( 1 0 ... 0 ... 0 ... 0 0 )</span>
<a name="line-388"></a><span class='hs-comment'>-- &gt;   2 ( 0 1 ... 0 ... 0 ... 0 0 )</span>
<a name="line-389"></a><span class='hs-comment'>-- &gt;     (     ...   ...   ...     )</span>
<a name="line-390"></a><span class='hs-comment'>-- &gt;   i ( 0 0 ... 0 ... 1 ... 0 0 )</span>
<a name="line-391"></a><span class='hs-comment'>-- &gt;     (     ...   ...   ...     )</span>
<a name="line-392"></a><span class='hs-comment'>-- &gt;   j ( 0 0 ... 1 ... 0 ... 0 0 )</span>
<a name="line-393"></a><span class='hs-comment'>-- &gt;     (     ...   ...   ...     )</span>
<a name="line-394"></a><span class='hs-comment'>-- &gt;     ( 0 0 ... 0 ... 0 ... 1 0 )</span>
<a name="line-395"></a><span class='hs-comment'>-- &gt;   n ( 0 0 ... 0 ... 0 ... 0 1 )</span>
<a name="line-396"></a><span class='hs-comment'>--</span>
<a name="line-397"></a><span class='hs-comment'>-- When @i == j@ it reduces to 'identity' @n@.</span>
<a name="line-398"></a><span class='hs-comment'>--</span>
<a name="line-399"></a><span class='hs-definition'>permMatrix</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Num</span> <span class='hs-varid'>a</span>
<a name="line-400"></a>           <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-comment'>-- ^ Size of the matrix.</span>
<a name="line-401"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-comment'>-- ^ Permuted row 1.</span>
<a name="line-402"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-comment'>-- ^ Permuted row 2.</span>
<a name="line-403"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-comment'>-- ^ Permutation matrix.</span>
<a name="line-404"></a><span class='hs-definition'>permMatrix</span> <span class='hs-varid'>n</span> <span class='hs-varid'>r1</span> <span class='hs-varid'>r2</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>r1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>r2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>identity</span> <span class='hs-varid'>n</span>
<a name="line-405"></a><span class='hs-definition'>permMatrix</span> <span class='hs-varid'>n</span> <span class='hs-varid'>r1</span> <span class='hs-varid'>r2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>matrix</span> <span class='hs-varid'>n</span> <span class='hs-varid'>n</span> <span class='hs-varid'>f</span>
<a name="line-406"></a> <span class='hs-keyword'>where</span>
<a name="line-407"></a>  <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span><span class='hs-varid'>j</span><span class='hs-layout'>)</span>
<a name="line-408"></a>   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>i</span> <span class='hs-varop'>==</span> <span class='hs-varid'>r1</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>j</span> <span class='hs-varop'>==</span> <span class='hs-varid'>r2</span> <span class='hs-keyword'>then</span> <span class='hs-num'>1</span> <span class='hs-keyword'>else</span> <span class='hs-num'>0</span>
<a name="line-409"></a>   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>i</span> <span class='hs-varop'>==</span> <span class='hs-varid'>r2</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>j</span> <span class='hs-varop'>==</span> <span class='hs-varid'>r1</span> <span class='hs-keyword'>then</span> <span class='hs-num'>1</span> <span class='hs-keyword'>else</span> <span class='hs-num'>0</span>
<a name="line-410"></a>   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>i</span> <span class='hs-varop'>==</span> <span class='hs-varid'>j</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span>
<a name="line-411"></a>   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span>
<a name="line-412"></a>
<a name="line-413"></a><span class='hs-comment'>-------------------------------------------------------</span>
<a name="line-414"></a><span class='hs-comment'>-------------------------------------------------------</span>
<a name="line-415"></a><span class='hs-comment'>---- ACCESSING</span>
<a name="line-416"></a>
<a name="line-417"></a><a name="getElem"></a><span class='hs-comment'>-- | /O(1)/. Get an element of a matrix. Indices range from /(1,1)/ to /(n,m)/.</span>
<a name="line-418"></a><span class='hs-comment'>--   It returns an 'error' if the requested element is outside of range.</span>
<a name="line-419"></a><span class='hs-definition'>getElem</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span>      <span class='hs-comment'>-- ^ Row</span>
<a name="line-420"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>      <span class='hs-comment'>-- ^ Column</span>
<a name="line-421"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-comment'>-- ^ Matrix</span>
<a name="line-422"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span>
<a name="line-423"></a><span class='hs-comment'>{-# INLINE getElem #-}</span>
<a name="line-424"></a><span class='hs-definition'>getElem</span> <span class='hs-varid'>i</span> <span class='hs-varid'>j</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span>
<a name="line-425"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>safeGet</span> <span class='hs-varid'>i</span> <span class='hs-varid'>j</span> <span class='hs-varid'>m</span> <span class='hs-keyword'>of</span>
<a name="line-426"></a>    <span class='hs-conid'>Just</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>x</span>
<a name="line-427"></a>    <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>error</span>
<a name="line-428"></a>      <span class='hs-varop'>$</span> <span class='hs-str'>"getElem: Trying to get the "</span>
<a name="line-429"></a>     <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span><span class='hs-varid'>j</span><span class='hs-layout'>)</span>
<a name="line-430"></a>     <span class='hs-varop'>++</span> <span class='hs-str'>" element from a "</span>
<a name="line-431"></a>     <span class='hs-varop'>++</span> <span class='hs-varid'>sizeStr</span> <span class='hs-layout'>(</span><span class='hs-varid'>nrows</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ncols</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-432"></a>     <span class='hs-varop'>++</span> <span class='hs-str'>" matrix."</span>
<a name="line-433"></a>
<a name="line-434"></a><a name="unsafeGet"></a><span class='hs-comment'>-- | /O(1)/. Unsafe variant of 'getElem', without bounds checking.</span>
<a name="line-435"></a><span class='hs-definition'>unsafeGet</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span>      <span class='hs-comment'>-- ^ Row</span>
<a name="line-436"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>      <span class='hs-comment'>-- ^ Column</span>
<a name="line-437"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-comment'>-- ^ Matrix</span>
<a name="line-438"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span>
<a name="line-439"></a><span class='hs-comment'>{-# INLINE unsafeGet #-}</span>
<a name="line-440"></a><span class='hs-definition'>unsafeGet</span> <span class='hs-varid'>i</span> <span class='hs-varid'>j</span> <span class='hs-layout'>(</span><span class='hs-conid'>M</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ro</span> <span class='hs-varid'>co</span> <span class='hs-varid'>w</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>unsafeIndex</span> <span class='hs-varid'>v</span> <span class='hs-varop'>$</span> <span class='hs-varid'>encode</span> <span class='hs-varid'>w</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-varop'>+</span><span class='hs-varid'>ro</span><span class='hs-layout'>,</span><span class='hs-varid'>j</span><span class='hs-varop'>+</span><span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-441"></a>
<a name="line-442"></a><a name="!"></a><span class='hs-comment'>-- | Short alias for 'getElem'.</span>
<a name="line-443"></a><span class='hs-layout'>(</span><span class='hs-varop'>!</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Int</span><span class='hs-layout'>,</span><span class='hs-conid'>Int</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span>
<a name="line-444"></a><a name="m"></a><span class='hs-comment'>{-# INLINE (!) #-}</span>
<a name="line-445"></a><span class='hs-definition'>m</span> <span class='hs-varop'>!</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span><span class='hs-varid'>j</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getElem</span> <span class='hs-varid'>i</span> <span class='hs-varid'>j</span> <span class='hs-varid'>m</span>
<a name="line-446"></a>
<a name="line-447"></a><a name="!."></a><span class='hs-comment'>-- | Internal alias for 'unsafeGet'.</span>
<a name="line-448"></a><span class='hs-layout'>(</span><span class='hs-varop'>!.</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Int</span><span class='hs-layout'>,</span><span class='hs-conid'>Int</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span>
<a name="line-449"></a><span class='hs-comment'>{-# INLINE (!.) #-}</span>
<a name="line-450"></a><span class='hs-definition'>m</span> <span class='hs-varop'>!.</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span><span class='hs-varid'>j</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsafeGet</span> <span class='hs-varid'>i</span> <span class='hs-varid'>j</span> <span class='hs-varid'>m</span>
<a name="line-451"></a>
<a name="line-452"></a><a name="safeGet"></a><span class='hs-comment'>-- | Variant of 'getElem' that returns Maybe instead of an error.</span>
<a name="line-453"></a><span class='hs-definition'>safeGet</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-varid'>a</span>
<a name="line-454"></a><span class='hs-definition'>safeGet</span> <span class='hs-varid'>i</span> <span class='hs-varid'>j</span> <span class='hs-varid'>a</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>M</span> <span class='hs-varid'>n</span> <span class='hs-varid'>m</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-455"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>i</span> <span class='hs-varop'>&gt;</span> <span class='hs-varid'>n</span> <span class='hs-varop'>||</span> <span class='hs-varid'>j</span> <span class='hs-varop'>&gt;</span> <span class='hs-varid'>m</span> <span class='hs-varop'>||</span> <span class='hs-varid'>i</span> <span class='hs-varop'>&lt;</span> <span class='hs-num'>1</span> <span class='hs-varop'>||</span> <span class='hs-varid'>j</span> <span class='hs-varop'>&lt;</span> <span class='hs-num'>1</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-456"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varop'>$</span> <span class='hs-varid'>unsafeGet</span> <span class='hs-varid'>i</span> <span class='hs-varid'>j</span> <span class='hs-varid'>a</span>
<a name="line-457"></a>
<a name="line-458"></a><a name="safeSet"></a><span class='hs-comment'>-- | Variant of 'setElem' that returns Maybe instead of an error.</span>
<a name="line-459"></a><span class='hs-definition'>safeSet</span><span class='hs-keyglyph'>::</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Int</span><span class='hs-layout'>,</span> <span class='hs-conid'>Int</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-460"></a><span class='hs-definition'>safeSet</span> <span class='hs-varid'>x</span> <span class='hs-varid'>p</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span><span class='hs-varid'>j</span><span class='hs-layout'>)</span> <span class='hs-varid'>a</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>M</span> <span class='hs-varid'>n</span> <span class='hs-varid'>m</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-461"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>i</span> <span class='hs-varop'>&gt;</span> <span class='hs-varid'>n</span> <span class='hs-varop'>||</span> <span class='hs-varid'>j</span> <span class='hs-varop'>&gt;</span> <span class='hs-varid'>m</span> <span class='hs-varop'>||</span> <span class='hs-varid'>i</span> <span class='hs-varop'>&lt;</span> <span class='hs-num'>1</span> <span class='hs-varop'>||</span> <span class='hs-varid'>j</span> <span class='hs-varop'>&lt;</span> <span class='hs-num'>1</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-462"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varop'>$</span> <span class='hs-varid'>unsafeSet</span> <span class='hs-varid'>x</span> <span class='hs-varid'>p</span> <span class='hs-varid'>a</span>
<a name="line-463"></a>
<a name="line-464"></a><a name="getRow"></a><span class='hs-comment'>-- | /O(1)/. Get a row of a matrix as a vector.</span>
<a name="line-465"></a><span class='hs-definition'>getRow</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-conid'>Vector</span> <span class='hs-varid'>a</span>
<a name="line-466"></a><span class='hs-comment'>{-# INLINE getRow #-}</span>
<a name="line-467"></a><span class='hs-definition'>getRow</span> <span class='hs-varid'>i</span> <span class='hs-layout'>(</span><span class='hs-conid'>M</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>m</span> <span class='hs-varid'>ro</span> <span class='hs-varid'>co</span> <span class='hs-varid'>w</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>slice</span> <span class='hs-layout'>(</span><span class='hs-varid'>w</span><span class='hs-varop'>*</span><span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-varop'>+</span><span class='hs-varid'>ro</span><span class='hs-layout'>)</span> <span class='hs-varop'>+</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varid'>m</span> <span class='hs-varid'>v</span>
<a name="line-468"></a>
<a name="line-469"></a><a name="getCol"></a><span class='hs-comment'>-- | /O(rows)/. Get a column of a matrix as a vector.</span>
<a name="line-470"></a><span class='hs-definition'>getCol</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-conid'>Vector</span> <span class='hs-varid'>a</span>
<a name="line-471"></a><span class='hs-comment'>{-# INLINE getCol #-}</span>
<a name="line-472"></a><span class='hs-definition'>getCol</span> <span class='hs-varid'>j</span> <span class='hs-layout'>(</span><span class='hs-conid'>M</span> <span class='hs-varid'>n</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ro</span> <span class='hs-varid'>co</span> <span class='hs-varid'>w</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>generate</span> <span class='hs-varid'>n</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>i</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>v</span> <span class='hs-conid'>V</span><span class='hs-varop'>.!</span> <span class='hs-varid'>encode</span> <span class='hs-varid'>w</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-varop'>+</span><span class='hs-varid'>ro</span><span class='hs-layout'>,</span><span class='hs-varid'>j</span><span class='hs-varop'>+</span><span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-473"></a>
<a name="line-474"></a><a name="getDiag"></a><span class='hs-comment'>-- | /O(min rows cols)/. Diagonal of a /not necessarily square/ matrix.</span>
<a name="line-475"></a><span class='hs-definition'>getDiag</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-conid'>Vector</span> <span class='hs-varid'>a</span>
<a name="line-476"></a><span class='hs-definition'>getDiag</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>generate</span> <span class='hs-varid'>k</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>i</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-varop'>!</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>,</span><span class='hs-varid'>i</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-477"></a> <span class='hs-keyword'>where</span>
<a name="line-478"></a>  <span class='hs-varid'>k</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>min</span> <span class='hs-layout'>(</span><span class='hs-varid'>nrows</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ncols</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-479"></a>
<a name="line-480"></a><a name="getMatrixAsVector"></a><span class='hs-comment'>-- | /O(rows*cols)/. Transform a 'Matrix' to a 'V.Vector' of size /rows*cols/.</span>
<a name="line-481"></a><span class='hs-comment'>--  This is equivalent to get all the rows of the matrix using 'getRow'</span>
<a name="line-482"></a><span class='hs-comment'>--  and then append them, but far more efficient.</span>
<a name="line-483"></a><span class='hs-definition'>getMatrixAsVector</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-conid'>Vector</span> <span class='hs-varid'>a</span>
<a name="line-484"></a><span class='hs-definition'>getMatrixAsVector</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mvect</span> <span class='hs-varop'>.</span> <span class='hs-varid'>forceMatrix</span>
<a name="line-485"></a>
<a name="line-486"></a><span class='hs-comment'>-------------------------------------------------------</span>
<a name="line-487"></a><span class='hs-comment'>-------------------------------------------------------</span>
<a name="line-488"></a><span class='hs-comment'>---- MANIPULATING MATRICES</span>
<a name="line-489"></a>
<a name="line-490"></a><a name="msetElem"></a><span class='hs-definition'>msetElem</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrimMonad</span> <span class='hs-varid'>m</span>
<a name="line-491"></a>         <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>a</span> <span class='hs-comment'>-- ^ New element</span>
<a name="line-492"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-comment'>-- ^ Number of columns of the matrix</span>
<a name="line-493"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-comment'>-- ^ Row offset</span>
<a name="line-494"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-comment'>-- ^ Column offset</span>
<a name="line-495"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Int</span><span class='hs-layout'>,</span><span class='hs-conid'>Int</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- ^ Position to set the new element</span>
<a name="line-496"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MV</span><span class='hs-varop'>.</span><span class='hs-conid'>MVector</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimState</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-varid'>a</span> <span class='hs-comment'>-- ^ Mutable vector</span>
<a name="line-497"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>()</span>
<a name="line-498"></a><span class='hs-comment'>{-# INLINE msetElem #-}</span>
<a name="line-499"></a><span class='hs-definition'>msetElem</span> <span class='hs-varid'>x</span> <span class='hs-varid'>w</span> <span class='hs-varid'>ro</span> <span class='hs-varid'>co</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span><span class='hs-varid'>j</span><span class='hs-layout'>)</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MV</span><span class='hs-varop'>.</span><span class='hs-varid'>write</span> <span class='hs-varid'>v</span> <span class='hs-layout'>(</span><span class='hs-varid'>encode</span> <span class='hs-varid'>w</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-varop'>+</span><span class='hs-varid'>ro</span><span class='hs-layout'>,</span><span class='hs-varid'>j</span><span class='hs-varop'>+</span><span class='hs-varid'>co</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>x</span>
<a name="line-500"></a>
<a name="line-501"></a><a name="unsafeMset"></a><span class='hs-definition'>unsafeMset</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PrimMonad</span> <span class='hs-varid'>m</span>
<a name="line-502"></a>         <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>a</span> <span class='hs-comment'>-- ^ New element</span>
<a name="line-503"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-comment'>-- ^ Number of columns of the matrix</span>
<a name="line-504"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-comment'>-- ^ Row offset</span>
<a name="line-505"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-comment'>-- ^ Column offset</span>
<a name="line-506"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Int</span><span class='hs-layout'>,</span><span class='hs-conid'>Int</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- ^ Position to set the new element</span>
<a name="line-507"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MV</span><span class='hs-varop'>.</span><span class='hs-conid'>MVector</span> <span class='hs-layout'>(</span><span class='hs-conid'>PrimState</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-varid'>a</span> <span class='hs-comment'>-- ^ Mutable vector</span>
<a name="line-508"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>()</span>
<a name="line-509"></a><span class='hs-comment'>{-# INLINE unsafeMset #-}</span>
<a name="line-510"></a><span class='hs-definition'>unsafeMset</span> <span class='hs-varid'>x</span> <span class='hs-varid'>w</span> <span class='hs-varid'>ro</span> <span class='hs-varid'>co</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span><span class='hs-varid'>j</span><span class='hs-layout'>)</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MV</span><span class='hs-varop'>.</span><span class='hs-varid'>unsafeWrite</span> <span class='hs-varid'>v</span> <span class='hs-layout'>(</span><span class='hs-varid'>encode</span> <span class='hs-varid'>w</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-varop'>+</span><span class='hs-varid'>ro</span><span class='hs-layout'>,</span><span class='hs-varid'>j</span><span class='hs-varop'>+</span><span class='hs-varid'>co</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>x</span>
<a name="line-511"></a>
<a name="line-512"></a><a name="setElem"></a><span class='hs-comment'>-- | Replace the value of a cell in a matrix.</span>
<a name="line-513"></a><span class='hs-definition'>setElem</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>a</span> <span class='hs-comment'>-- ^ New value.</span>
<a name="line-514"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Int</span><span class='hs-layout'>,</span><span class='hs-conid'>Int</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- ^ Position to replace.</span>
<a name="line-515"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-comment'>-- ^ Original matrix.</span>
<a name="line-516"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-comment'>-- ^ Matrix with the given position replaced with the given value.</span>
<a name="line-517"></a><span class='hs-comment'>{-# INLINE setElem #-}</span>
<a name="line-518"></a><span class='hs-definition'>setElem</span> <span class='hs-varid'>x</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-conid'>M</span> <span class='hs-varid'>n</span> <span class='hs-varid'>m</span> <span class='hs-varid'>ro</span> <span class='hs-varid'>co</span> <span class='hs-varid'>w</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>M</span> <span class='hs-varid'>n</span> <span class='hs-varid'>m</span> <span class='hs-varid'>ro</span> <span class='hs-varid'>co</span> <span class='hs-varid'>w</span> <span class='hs-varop'>$</span> <span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>modify</span> <span class='hs-layout'>(</span><span class='hs-varid'>msetElem</span> <span class='hs-varid'>x</span> <span class='hs-varid'>w</span> <span class='hs-varid'>ro</span> <span class='hs-varid'>co</span> <span class='hs-varid'>p</span><span class='hs-layout'>)</span> <span class='hs-varid'>v</span>
<a name="line-519"></a>
<a name="line-520"></a><a name="unsafeSet"></a><span class='hs-comment'>-- | Unsafe variant of 'setElem', without bounds checking.</span>
<a name="line-521"></a><span class='hs-definition'>unsafeSet</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>a</span> <span class='hs-comment'>-- ^ New value.</span>
<a name="line-522"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Int</span><span class='hs-layout'>,</span><span class='hs-conid'>Int</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- ^ Position to replace.</span>
<a name="line-523"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-comment'>-- ^ Original matrix.</span>
<a name="line-524"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-comment'>-- ^ Matrix with the given position replaced with the given value.</span>
<a name="line-525"></a><span class='hs-comment'>{-# INLINE unsafeSet #-}</span>
<a name="line-526"></a><span class='hs-definition'>unsafeSet</span> <span class='hs-varid'>x</span> <span class='hs-varid'>p</span> <span class='hs-layout'>(</span><span class='hs-conid'>M</span> <span class='hs-varid'>n</span> <span class='hs-varid'>m</span> <span class='hs-varid'>ro</span> <span class='hs-varid'>co</span> <span class='hs-varid'>w</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>M</span> <span class='hs-varid'>n</span> <span class='hs-varid'>m</span> <span class='hs-varid'>ro</span> <span class='hs-varid'>co</span> <span class='hs-varid'>w</span> <span class='hs-varop'>$</span> <span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>modify</span> <span class='hs-layout'>(</span><span class='hs-varid'>unsafeMset</span> <span class='hs-varid'>x</span> <span class='hs-varid'>w</span> <span class='hs-varid'>ro</span> <span class='hs-varid'>co</span> <span class='hs-varid'>p</span><span class='hs-layout'>)</span> <span class='hs-varid'>v</span>
<a name="line-527"></a>
<a name="line-528"></a><a name="transpose"></a><span class='hs-comment'>-- | /O(rows*cols)/. The transpose of a matrix.</span>
<a name="line-529"></a><span class='hs-comment'>--   Example:</span>
<a name="line-530"></a><span class='hs-comment'>--</span>
<a name="line-531"></a><span class='hs-comment'>-- &gt;           ( 1 2 3 )   ( 1 4 7 )</span>
<a name="line-532"></a><span class='hs-comment'>-- &gt;           ( 4 5 6 )   ( 2 5 8 )</span>
<a name="line-533"></a><span class='hs-comment'>-- &gt; transpose ( 7 8 9 ) = ( 3 6 9 )</span>
<a name="line-534"></a><span class='hs-definition'>transpose</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span>
<a name="line-535"></a><span class='hs-definition'>transpose</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>matrix</span> <span class='hs-layout'>(</span><span class='hs-varid'>ncols</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>nrows</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span><span class='hs-varid'>j</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-varop'>!</span> <span class='hs-layout'>(</span><span class='hs-varid'>j</span><span class='hs-layout'>,</span><span class='hs-varid'>i</span><span class='hs-layout'>)</span>
<a name="line-536"></a>
<a name="line-537"></a><a name="inverse"></a><span class='hs-comment'>-- | /O(rows*rows*rows) = O(cols*cols*cols)/. The inverse of a square matrix.</span>
<a name="line-538"></a><span class='hs-comment'>--   Uses naive Gaussian elimination formula.</span>
<a name="line-539"></a><span class='hs-definition'>inverse</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Fractional</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Eq</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Either</span> <span class='hs-conid'>String</span> <span class='hs-layout'>(</span><span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-540"></a><span class='hs-definition'>inverse</span> <span class='hs-varid'>m</span>
<a name="line-541"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>ncols</span> <span class='hs-varid'>m</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>nrows</span> <span class='hs-varid'>m</span>
<a name="line-542"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Left</span>
<a name="line-543"></a>            <span class='hs-varop'>$</span> <span class='hs-str'>"Inverting non-square matrix with dimensions "</span>
<a name="line-544"></a>                <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-layout'>(</span><span class='hs-varid'>sizeStr</span> <span class='hs-layout'>(</span><span class='hs-varid'>ncols</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>nrows</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-545"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span>
<a name="line-546"></a>        <span class='hs-keyword'>let</span>
<a name="line-547"></a>            <span class='hs-varid'>adjoinedWId</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>m</span> <span class='hs-varop'>&lt;|&gt;</span> <span class='hs-varid'>identity</span> <span class='hs-layout'>(</span><span class='hs-varid'>nrows</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-548"></a>            <span class='hs-varid'>rref'd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rref</span> <span class='hs-varid'>adjoinedWId</span>
<a name="line-549"></a>        <span class='hs-keyword'>in</span> <span class='hs-varid'>rref'd</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>return</span> <span class='hs-varop'>.</span> <span class='hs-varid'>submatrix</span> <span class='hs-num'>1</span> <span class='hs-layout'>(</span><span class='hs-varid'>nrows</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ncols</span> <span class='hs-varid'>m</span> <span class='hs-varop'>+</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ncols</span> <span class='hs-varid'>m</span> <span class='hs-varop'>*</span> <span class='hs-num'>2</span><span class='hs-layout'>)</span>
<a name="line-550"></a>
<a name="line-551"></a><a name="rref"></a><span class='hs-comment'>-- | /O(rows*rows*cols)/. Converts a matrix to reduced row echelon form, thus</span>
<a name="line-552"></a><span class='hs-comment'>--  solving a linear system of equations. This requires that (cols &gt; rows)</span>
<a name="line-553"></a><span class='hs-comment'>--  if cols &lt; rows, then there are fewer variables than equations and the</span>
<a name="line-554"></a><span class='hs-comment'>--  problem cannot be solved consistently. If rows = cols, then it is</span>
<a name="line-555"></a><span class='hs-comment'>--  basically a homogenous system of equations, so it will be reduced to</span>
<a name="line-556"></a><span class='hs-comment'>--  identity or an error depending on whether the marix is invertible</span>
<a name="line-557"></a><span class='hs-comment'>--  (this case is allowed for robustness).</span>
<a name="line-558"></a><span class='hs-definition'>rref</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Fractional</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Eq</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Either</span> <span class='hs-conid'>String</span> <span class='hs-layout'>(</span><span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-559"></a><span class='hs-definition'>rref</span> <span class='hs-varid'>m</span>
<a name="line-560"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>ncols</span> <span class='hs-varid'>m</span> <span class='hs-varop'>&lt;</span> <span class='hs-varid'>nrows</span> <span class='hs-varid'>m</span>
<a name="line-561"></a>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Left</span> <span class='hs-varop'>$</span>
<a name="line-562"></a>                <span class='hs-str'>"Invalid dimensions "</span>
<a name="line-563"></a>                    <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-layout'>(</span><span class='hs-varid'>sizeStr</span> <span class='hs-layout'>(</span><span class='hs-varid'>ncols</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>nrows</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-564"></a>                    <span class='hs-varop'>++</span> <span class='hs-str'>"; the number of columns must be greater than or equal to the number of rows"</span>
<a name="line-565"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rrefRefd</span> <span class='hs-layout'>(</span><span class='hs-varid'>ref</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-566"></a>    <span class='hs-keyword'>where</span>
<a name="line-567"></a>    <span class='hs-varid'>rrefRefd</span> <span class='hs-varid'>mtx</span>
<a name="line-568"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>nrows</span> <span class='hs-varid'>mtx</span> <span class='hs-varop'>==</span> <span class='hs-num'>1</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Right</span> <span class='hs-varid'>mtx</span>
<a name="line-569"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span>
<a name="line-570"></a>            <span class='hs-keyword'>let</span>
<a name="line-571"></a>                <span class='hs-varid'>resolvedRight</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-varop'>.</span><span class='hs-layout'>)</span> <span class='hs-varid'>id</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>resolveRow</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>1</span><span class='hs-keyglyph'>..</span><span class='hs-varid'>col</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-varid'>mtx</span>
<a name="line-572"></a>                    <span class='hs-keyword'>where</span>
<a name="line-573"></a>                    <span class='hs-varid'>col</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nrows</span> <span class='hs-varid'>mtx</span>
<a name="line-574"></a>                    <span class='hs-varid'>resolveRow</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>combineRows</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-comment'>-</span><span class='hs-varid'>getElem</span> <span class='hs-varid'>n</span> <span class='hs-varid'>col</span> <span class='hs-varid'>mtx</span><span class='hs-layout'>)</span> <span class='hs-varid'>col</span>
<a name="line-575"></a>                <span class='hs-varid'>top</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>submatrix</span> <span class='hs-num'>1</span> <span class='hs-layout'>(</span><span class='hs-varid'>nrows</span> <span class='hs-varid'>resolvedRight</span> <span class='hs-comment'>-</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-num'>1</span> <span class='hs-layout'>(</span><span class='hs-varid'>ncols</span> <span class='hs-varid'>resolvedRight</span><span class='hs-layout'>)</span> <span class='hs-varid'>resolvedRight</span>
<a name="line-576"></a>                <span class='hs-varid'>top'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rrefRefd</span> <span class='hs-varid'>top</span>
<a name="line-577"></a>                <span class='hs-varid'>bot</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>submatrix</span> <span class='hs-layout'>(</span><span class='hs-varid'>nrows</span> <span class='hs-varid'>resolvedRight</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>nrows</span> <span class='hs-varid'>resolvedRight</span><span class='hs-layout'>)</span> <span class='hs-num'>1</span> <span class='hs-layout'>(</span><span class='hs-varid'>ncols</span> <span class='hs-varid'>resolvedRight</span><span class='hs-layout'>)</span> <span class='hs-varid'>resolvedRight</span>
<a name="line-578"></a>            <span class='hs-keyword'>in</span> <span class='hs-varid'>top'</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>return</span> <span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-varop'>&lt;-&gt;</span> <span class='hs-varid'>bot</span><span class='hs-layout'>)</span>
<a name="line-579"></a>
<a name="line-580"></a>
<a name="line-581"></a><a name="ref"></a><span class='hs-definition'>ref</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Fractional</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Eq</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span>
<a name="line-582"></a><span class='hs-definition'>ref</span> <span class='hs-varid'>mtx</span>
<a name="line-583"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>nrows</span> <span class='hs-varid'>mtx</span> <span class='hs-varop'>==</span> <span class='hs-num'>1</span>
<a name="line-584"></a>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>clearedLeft</span>
<a name="line-585"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span>
<a name="line-586"></a>            <span class='hs-keyword'>let</span>
<a name="line-587"></a>                <span class='hs-layout'>(</span><span class='hs-varid'>tl</span><span class='hs-layout'>,</span> <span class='hs-varid'>tr</span><span class='hs-layout'>,</span> <span class='hs-varid'>bl</span><span class='hs-layout'>,</span> <span class='hs-varid'>br</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitBlocks</span> <span class='hs-num'>1</span> <span class='hs-num'>1</span> <span class='hs-varid'>clearedLeft</span>
<a name="line-588"></a>                <span class='hs-varid'>br'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ref</span> <span class='hs-varid'>br</span>
<a name="line-589"></a>            <span class='hs-keyword'>in</span> <span class='hs-layout'>(</span><span class='hs-varid'>tl</span> <span class='hs-varop'>&lt;|&gt;</span> <span class='hs-varid'>tr</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>bl</span> <span class='hs-varop'>&lt;|&gt;</span> <span class='hs-varid'>br'</span><span class='hs-layout'>)</span>
<a name="line-590"></a>    <span class='hs-keyword'>where</span>
<a name="line-591"></a>    <span class='hs-varid'>sigAtTop</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>switchRows</span> <span class='hs-num'>1</span> <span class='hs-varid'>goodRow</span> <span class='hs-varid'>mtx</span>
<a name="line-592"></a>        <span class='hs-keyword'>where</span>
<a name="line-593"></a>        <span class='hs-varid'>significantRow</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getElem</span> <span class='hs-varid'>n</span> <span class='hs-num'>1</span> <span class='hs-varid'>mtx</span> <span class='hs-varop'>/=</span> <span class='hs-num'>0</span>
<a name="line-594"></a>        <span class='hs-varid'>goodRow</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>listToMaybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>filter</span> <span class='hs-varid'>significantRow</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>1</span><span class='hs-keyglyph'>..</span><span class='hs-varid'>ncols</span> <span class='hs-varid'>mtx</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-595"></a>            <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>error</span> <span class='hs-str'>"Attempt to invert a non-invertible matrix"</span>
<a name="line-596"></a>            <span class='hs-conid'>Just</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>x</span>
<a name="line-597"></a>    <span class='hs-varid'>normalizedFirstRow</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>scaleRow</span> <span class='hs-layout'>(</span><span class='hs-num'>1</span> <span class='hs-varop'>/</span> <span class='hs-varid'>getElem</span> <span class='hs-num'>1</span> <span class='hs-num'>1</span> <span class='hs-varid'>mtx</span><span class='hs-layout'>)</span> <span class='hs-num'>1</span> <span class='hs-varid'>sigAtTop</span>
<a name="line-598"></a>    <span class='hs-varid'>clearedLeft</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-varop'>.</span><span class='hs-layout'>)</span> <span class='hs-varid'>id</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>combinator</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>2</span><span class='hs-keyglyph'>..</span><span class='hs-varid'>nrows</span> <span class='hs-varid'>mtx</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-varid'>normalizedFirstRow</span>
<a name="line-599"></a>        <span class='hs-keyword'>where</span>
<a name="line-600"></a>        <span class='hs-varid'>combinator</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>combineRows</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-comment'>-</span><span class='hs-varid'>getElem</span> <span class='hs-varid'>n</span> <span class='hs-num'>1</span> <span class='hs-varid'>normalizedFirstRow</span><span class='hs-layout'>)</span> <span class='hs-num'>1</span>
<a name="line-601"></a>
<a name="line-602"></a><a name="extendTo"></a><span class='hs-comment'>-- | Extend a matrix to a given size adding a default element.</span>
<a name="line-603"></a><span class='hs-comment'>--   If the matrix already has the required size, nothing happens.</span>
<a name="line-604"></a><span class='hs-comment'>--   The matrix is /never/ reduced in size.</span>
<a name="line-605"></a><span class='hs-comment'>--   Example:</span>
<a name="line-606"></a><span class='hs-comment'>--</span>
<a name="line-607"></a><span class='hs-comment'>-- &gt;                            ( 1 2 3 0 0 )</span>
<a name="line-608"></a><span class='hs-comment'>-- &gt;                ( 1 2 3 )   ( 4 5 6 0 0 )</span>
<a name="line-609"></a><span class='hs-comment'>-- &gt;                ( 4 5 6 )   ( 7 8 9 0 0 )</span>
<a name="line-610"></a><span class='hs-comment'>-- &gt; extendTo 0 4 5 ( 7 8 9 ) = ( 0 0 0 0 0 )</span>
<a name="line-611"></a><span class='hs-comment'>--</span>
<a name="line-612"></a><span class='hs-comment'>-- The definition of 'extendTo' is based on 'setSize':</span>
<a name="line-613"></a><span class='hs-comment'>--</span>
<a name="line-614"></a><span class='hs-comment'>-- &gt; extendTo e n m a = setSize e (max n $ nrows a) (max m $ ncols a) a</span>
<a name="line-615"></a><span class='hs-comment'>--</span>
<a name="line-616"></a><span class='hs-definition'>extendTo</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>a</span>   <span class='hs-comment'>-- ^ Element to add when extending.</span>
<a name="line-617"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-comment'>-- ^ Minimal number of rows.</span>
<a name="line-618"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-comment'>-- ^ Minimal number of columns.</span>
<a name="line-619"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span>
<a name="line-620"></a><span class='hs-definition'>extendTo</span> <span class='hs-varid'>e</span> <span class='hs-varid'>n</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSize</span> <span class='hs-varid'>e</span> <span class='hs-layout'>(</span><span class='hs-varid'>max</span> <span class='hs-varid'>n</span> <span class='hs-varop'>$</span> <span class='hs-varid'>nrows</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>max</span> <span class='hs-varid'>m</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ncols</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-varid'>a</span>
<a name="line-621"></a>
<a name="line-622"></a><a name="setSize"></a><span class='hs-comment'>-- | Set the size of a matrix to given parameters. Use a default element</span>
<a name="line-623"></a><span class='hs-comment'>--   for undefined entries if the matrix has been extended.</span>
<a name="line-624"></a><span class='hs-definition'>setSize</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>a</span>   <span class='hs-comment'>-- ^ Default element.</span>
<a name="line-625"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-comment'>-- ^ Number of rows.</span>
<a name="line-626"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-comment'>-- ^ Number of columns.</span>
<a name="line-627"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span>
<a name="line-628"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span>
<a name="line-629"></a><span class='hs-comment'>{-# INLINE setSize #-}</span>
<a name="line-630"></a><span class='hs-definition'>setSize</span> <span class='hs-varid'>e</span> <span class='hs-varid'>n</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>M</span> <span class='hs-varid'>n0</span> <span class='hs-varid'>m0</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>matrix</span> <span class='hs-varid'>n</span> <span class='hs-varid'>m</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span><span class='hs-varid'>j</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-631"></a>  <span class='hs-keyword'>if</span> <span class='hs-varid'>i</span> <span class='hs-varop'>&lt;=</span> <span class='hs-varid'>n0</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>j</span> <span class='hs-varop'>&lt;=</span> <span class='hs-varid'>m0</span>
<a name="line-632"></a>     <span class='hs-keyword'>then</span> <span class='hs-varid'>unsafeGet</span> <span class='hs-varid'>i</span> <span class='hs-varid'>j</span> <span class='hs-varid'>a</span>
<a name="line-633"></a>     <span class='hs-keyword'>else</span> <span class='hs-varid'>e</span>
<a name="line-634"></a>
<a name="line-635"></a><span class='hs-comment'>-------------------------------------------------------</span>
<a name="line-636"></a><span class='hs-comment'>-------------------------------------------------------</span>
<a name="line-637"></a><span class='hs-comment'>---- WORKING WITH BLOCKS</span>
<a name="line-638"></a>
<a name="line-639"></a><a name="submatrix"></a><span class='hs-comment'>-- | /O(1)/. Extract a submatrix given row and column limits.</span>
<a name="line-640"></a><span class='hs-comment'>--   Example:</span>
<a name="line-641"></a><span class='hs-comment'>--</span>
<a name="line-642"></a><span class='hs-comment'>-- &gt;                   ( 1 2 3 )</span>
<a name="line-643"></a><span class='hs-comment'>-- &gt;                   ( 4 5 6 )   ( 2 3 )</span>
<a name="line-644"></a><span class='hs-comment'>-- &gt; submatrix 1 2 2 3 ( 7 8 9 ) = ( 5 6 )</span>
<a name="line-645"></a><span class='hs-definition'>submatrix</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span>    <span class='hs-comment'>-- ^ Starting row</span>
<a name="line-646"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-comment'>-- ^ Ending row</span>
<a name="line-647"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>    <span class='hs-comment'>-- ^ Starting column</span>
<a name="line-648"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-comment'>-- ^ Ending column</span>
<a name="line-649"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span>
<a name="line-650"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span>
<a name="line-651"></a><span class='hs-comment'>{-# INLINE submatrix #-}</span>
<a name="line-652"></a><span class='hs-definition'>submatrix</span> <span class='hs-varid'>r1</span> <span class='hs-varid'>r2</span> <span class='hs-varid'>c1</span> <span class='hs-varid'>c2</span> <span class='hs-layout'>(</span><span class='hs-conid'>M</span> <span class='hs-varid'>n</span> <span class='hs-varid'>m</span> <span class='hs-varid'>ro</span> <span class='hs-varid'>co</span> <span class='hs-varid'>w</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-653"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>r1</span> <span class='hs-varop'>&lt;</span> <span class='hs-num'>1</span>  <span class='hs-varop'>||</span> <span class='hs-varid'>r1</span> <span class='hs-varop'>&gt;</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>error</span> <span class='hs-varop'>$</span> <span class='hs-str'>"submatrix: starting row ("</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>r1</span> <span class='hs-varop'>++</span> <span class='hs-str'>") is out of range. Matrix has "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>n</span> <span class='hs-varop'>++</span> <span class='hs-str'>" rows."</span>
<a name="line-654"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>c1</span> <span class='hs-varop'>&lt;</span> <span class='hs-num'>1</span>  <span class='hs-varop'>||</span> <span class='hs-varid'>c1</span> <span class='hs-varop'>&gt;</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>error</span> <span class='hs-varop'>$</span> <span class='hs-str'>"submatrix: starting column ("</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>c1</span> <span class='hs-varop'>++</span> <span class='hs-str'>") is out of range. Matrix has "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>m</span> <span class='hs-varop'>++</span> <span class='hs-str'>" columns."</span>
<a name="line-655"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>r2</span> <span class='hs-varop'>&lt;</span> <span class='hs-varid'>r1</span> <span class='hs-varop'>||</span> <span class='hs-varid'>r2</span> <span class='hs-varop'>&gt;</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>error</span> <span class='hs-varop'>$</span> <span class='hs-str'>"submatrix: ending row ("</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>r2</span> <span class='hs-varop'>++</span> <span class='hs-str'>") is out of range. Matrix has "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>n</span> <span class='hs-varop'>++</span> <span class='hs-str'>" rows, and starting row is "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>r1</span> <span class='hs-varop'>++</span> <span class='hs-str'>"."</span>
<a name="line-656"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>c2</span> <span class='hs-varop'>&lt;</span> <span class='hs-varid'>c1</span> <span class='hs-varop'>||</span> <span class='hs-varid'>c2</span> <span class='hs-varop'>&gt;</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>error</span> <span class='hs-varop'>$</span> <span class='hs-str'>"submatrix: ending column ("</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>c2</span> <span class='hs-varop'>++</span> <span class='hs-str'>") is out of range. Matrix has "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>m</span> <span class='hs-varop'>++</span> <span class='hs-str'>" columns, and starting column is "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>c1</span> <span class='hs-varop'>++</span> <span class='hs-str'>"."</span>
<a name="line-657"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>M</span> <span class='hs-layout'>(</span><span class='hs-varid'>r2</span><span class='hs-comment'>-</span><span class='hs-varid'>r1</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>c2</span><span class='hs-comment'>-</span><span class='hs-varid'>c1</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ro</span><span class='hs-varop'>+</span><span class='hs-varid'>r1</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-varop'>+</span><span class='hs-varid'>c1</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>w</span> <span class='hs-varid'>v</span>
<a name="line-658"></a>
<a name="line-659"></a><a name="minorMatrix"></a><span class='hs-comment'>-- | /O(rows*cols)/. Remove a row and a column from a matrix.</span>
<a name="line-660"></a><span class='hs-comment'>--   Example:</span>
<a name="line-661"></a><span class='hs-comment'>--</span>
<a name="line-662"></a><span class='hs-comment'>-- &gt;                 ( 1 2 3 )</span>
<a name="line-663"></a><span class='hs-comment'>-- &gt;                 ( 4 5 6 )   ( 1 3 )</span>
<a name="line-664"></a><span class='hs-comment'>-- &gt; minorMatrix 2 2 ( 7 8 9 ) = ( 7 9 )</span>
<a name="line-665"></a><span class='hs-definition'>minorMatrix</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-comment'>-- ^ Row @r@ to remove.</span>
<a name="line-666"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-comment'>-- ^ Column @c@ to remove.</span>
<a name="line-667"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-comment'>-- ^ Original matrix.</span>
<a name="line-668"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-comment'>-- ^ Matrix with row @r@ and column @c@ removed.</span>
<a name="line-669"></a><span class='hs-definition'>minorMatrix</span> <span class='hs-varid'>r0</span> <span class='hs-varid'>c0</span> <span class='hs-layout'>(</span><span class='hs-conid'>M</span> <span class='hs-varid'>n</span> <span class='hs-varid'>m</span> <span class='hs-varid'>ro</span> <span class='hs-varid'>co</span> <span class='hs-varid'>w</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-670"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>r</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>r0</span> <span class='hs-varop'>+</span> <span class='hs-varid'>ro</span>
<a name="line-671"></a>      <span class='hs-varid'>c</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>c0</span> <span class='hs-varop'>+</span> <span class='hs-varid'>co</span>
<a name="line-672"></a>  <span class='hs-keyword'>in</span>  <span class='hs-conid'>M</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>m</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>ro</span> <span class='hs-varid'>co</span> <span class='hs-layout'>(</span><span class='hs-varid'>w</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>ifilter</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>k</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span><span class='hs-varid'>j</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>decode</span> <span class='hs-varid'>w</span> <span class='hs-varid'>k</span> <span class='hs-keyword'>in</span> <span class='hs-varid'>i</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>r</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>j</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span> <span class='hs-varid'>v</span>
<a name="line-673"></a>
<a name="line-674"></a><a name="splitBlocks"></a><span class='hs-comment'>-- | /O(1)/. Make a block-partition of a matrix using a given element as reference.</span>
<a name="line-675"></a><span class='hs-comment'>--   The element will stay in the bottom-right corner of the top-left corner matrix.</span>
<a name="line-676"></a><span class='hs-comment'>--</span>
<a name="line-677"></a><span class='hs-comment'>-- &gt;                 (             )   (      |      )</span>
<a name="line-678"></a><span class='hs-comment'>-- &gt;                 (             )   ( ...  | ...  )</span>
<a name="line-679"></a><span class='hs-comment'>-- &gt;                 (    x        )   (    x |      )</span>
<a name="line-680"></a><span class='hs-comment'>-- &gt; splitBlocks i j (             ) = (-------------) , where x = a_{i,j}</span>
<a name="line-681"></a><span class='hs-comment'>-- &gt;                 (             )   (      |      )</span>
<a name="line-682"></a><span class='hs-comment'>-- &gt;                 (             )   ( ...  | ...  )</span>
<a name="line-683"></a><span class='hs-comment'>-- &gt;                 (             )   (      |      )</span>
<a name="line-684"></a><span class='hs-comment'>--</span>
<a name="line-685"></a><span class='hs-comment'>--   Note that some blocks can end up empty. We use the following notation for these blocks:</span>
<a name="line-686"></a><span class='hs-comment'>--</span>
<a name="line-687"></a><span class='hs-comment'>-- &gt; ( TL | TR )</span>
<a name="line-688"></a><span class='hs-comment'>-- &gt; (---------)</span>
<a name="line-689"></a><span class='hs-comment'>-- &gt; ( BL | BR )</span>
<a name="line-690"></a><span class='hs-comment'>--</span>
<a name="line-691"></a><span class='hs-comment'>--   Where T = Top, B = Bottom, L = Left, R = Right.</span>
<a name="line-692"></a><span class='hs-comment'>--</span>
<a name="line-693"></a><span class='hs-definition'>splitBlocks</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span>      <span class='hs-comment'>-- ^ Row of the splitting element.</span>
<a name="line-694"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>      <span class='hs-comment'>-- ^ Column of the splitting element.</span>
<a name="line-695"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-comment'>-- ^ Matrix to split.</span>
<a name="line-696"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span><span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span>
<a name="line-697"></a>               <span class='hs-layout'>,</span><span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span><span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- ^ (TL,TR,BL,BR)</span>
<a name="line-698"></a><span class='hs-comment'>{-# INLINE[1] splitBlocks #-}</span>
<a name="line-699"></a><span class='hs-definition'>splitBlocks</span> <span class='hs-varid'>i</span> <span class='hs-varid'>j</span> <span class='hs-varid'>a</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>M</span> <span class='hs-varid'>n</span> <span class='hs-varid'>m</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-700"></a>    <span class='hs-layout'>(</span> <span class='hs-varid'>submatrix</span>    <span class='hs-num'>1</span>  <span class='hs-varid'>i</span> <span class='hs-num'>1</span> <span class='hs-varid'>j</span> <span class='hs-varid'>a</span> <span class='hs-layout'>,</span> <span class='hs-varid'>submatrix</span>    <span class='hs-num'>1</span>  <span class='hs-varid'>i</span> <span class='hs-layout'>(</span><span class='hs-varid'>j</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span>
<a name="line-701"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>submatrix</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>n</span> <span class='hs-num'>1</span> <span class='hs-varid'>j</span> <span class='hs-varid'>a</span> <span class='hs-layout'>,</span> <span class='hs-varid'>submatrix</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-varid'>j</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-layout'>)</span>
<a name="line-702"></a>
<a name="line-703"></a><a name="joinBlocks"></a><span class='hs-comment'>-- | Join blocks of the form detailed in 'splitBlocks'. Precisely:</span>
<a name="line-704"></a><span class='hs-comment'>--</span>
<a name="line-705"></a><span class='hs-comment'>-- &gt; joinBlocks (tl,tr,bl,br) =</span>
<a name="line-706"></a><span class='hs-comment'>-- &gt;   (tl &lt;|&gt; tr)</span>
<a name="line-707"></a><span class='hs-comment'>-- &gt;       &lt;-&gt;</span>
<a name="line-708"></a><span class='hs-comment'>-- &gt;   (bl &lt;|&gt; br)</span>
<a name="line-709"></a><span class='hs-definition'>joinBlocks</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span><span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span><span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span><span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span>
<a name="line-710"></a><span class='hs-comment'>{-# INLINE[1] joinBlocks #-}</span>
<a name="line-711"></a><span class='hs-definition'>joinBlocks</span> <span class='hs-layout'>(</span><span class='hs-varid'>tl</span><span class='hs-layout'>,</span><span class='hs-varid'>tr</span><span class='hs-layout'>,</span><span class='hs-varid'>bl</span><span class='hs-layout'>,</span><span class='hs-varid'>br</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-712"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>n</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nrows</span> <span class='hs-varid'>tl</span>
<a name="line-713"></a>      <span class='hs-varid'>nb</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nrows</span> <span class='hs-varid'>bl</span>
<a name="line-714"></a>      <span class='hs-varid'>n'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span> <span class='hs-varop'>+</span> <span class='hs-varid'>nb</span>
<a name="line-715"></a>      <span class='hs-varid'>m</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ncols</span> <span class='hs-varid'>tl</span>
<a name="line-716"></a>      <span class='hs-varid'>mr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ncols</span> <span class='hs-varid'>tr</span>
<a name="line-717"></a>      <span class='hs-varid'>m'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>m</span> <span class='hs-varop'>+</span> <span class='hs-varid'>mr</span>
<a name="line-718"></a>      <span class='hs-varid'>en</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>encode</span> <span class='hs-varid'>m'</span>
<a name="line-719"></a>  <span class='hs-keyword'>in</span>  <span class='hs-conid'>M</span> <span class='hs-varid'>n'</span> <span class='hs-varid'>m'</span> <span class='hs-num'>0</span> <span class='hs-num'>0</span> <span class='hs-varid'>m'</span> <span class='hs-varop'>$</span> <span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>create</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-720"></a>        <span class='hs-varid'>v</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>MV</span><span class='hs-varop'>.</span><span class='hs-varid'>new</span> <span class='hs-layout'>(</span><span class='hs-varid'>n'</span><span class='hs-varop'>*</span><span class='hs-varid'>m'</span><span class='hs-layout'>)</span>
<a name="line-721"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>wr</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MV</span><span class='hs-varop'>.</span><span class='hs-varid'>write</span> <span class='hs-varid'>v</span>
<a name="line-722"></a>        <span class='hs-varid'>numLoop</span> <span class='hs-num'>1</span> <span class='hs-varid'>n</span>  <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>i</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-723"></a>          <span class='hs-varid'>numLoop</span> <span class='hs-num'>1</span> <span class='hs-varid'>m</span>  <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>j</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>wr</span> <span class='hs-layout'>(</span><span class='hs-varid'>en</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span> <span class='hs-layout'>,</span><span class='hs-varid'>j</span>  <span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tl</span> <span class='hs-varop'>!</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span><span class='hs-varid'>j</span><span class='hs-layout'>)</span>
<a name="line-724"></a>          <span class='hs-varid'>numLoop</span> <span class='hs-num'>1</span> <span class='hs-varid'>mr</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>j</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>wr</span> <span class='hs-layout'>(</span><span class='hs-varid'>en</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span> <span class='hs-layout'>,</span><span class='hs-varid'>j</span><span class='hs-varop'>+</span><span class='hs-varid'>m</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tr</span> <span class='hs-varop'>!</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span><span class='hs-varid'>j</span><span class='hs-layout'>)</span>
<a name="line-725"></a>        <span class='hs-varid'>numLoop</span> <span class='hs-num'>1</span> <span class='hs-varid'>nb</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>i</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-726"></a>          <span class='hs-keyword'>let</span> <span class='hs-varid'>i'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>i</span><span class='hs-varop'>+</span><span class='hs-varid'>n</span>
<a name="line-727"></a>          <span class='hs-varid'>numLoop</span> <span class='hs-num'>1</span> <span class='hs-varid'>m</span>  <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>j</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>wr</span> <span class='hs-layout'>(</span><span class='hs-varid'>en</span> <span class='hs-layout'>(</span><span class='hs-varid'>i'</span><span class='hs-layout'>,</span><span class='hs-varid'>j</span>  <span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>bl</span> <span class='hs-varop'>!</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span><span class='hs-varid'>j</span><span class='hs-layout'>)</span>
<a name="line-728"></a>          <span class='hs-varid'>numLoop</span> <span class='hs-num'>1</span> <span class='hs-varid'>mr</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>j</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>wr</span> <span class='hs-layout'>(</span><span class='hs-varid'>en</span> <span class='hs-layout'>(</span><span class='hs-varid'>i'</span><span class='hs-layout'>,</span><span class='hs-varid'>j</span><span class='hs-varop'>+</span><span class='hs-varid'>m</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>br</span> <span class='hs-varop'>!</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span><span class='hs-varid'>j</span><span class='hs-layout'>)</span>
<a name="line-729"></a>        <span class='hs-varid'>return</span> <span class='hs-varid'>v</span>
<a name="line-730"></a>
<a name="line-731"></a><span class='hs-comment'>{-# RULES
<a name="line-732"></a>"matrix/splitAndJoin"
<a name="line-733"></a>   forall i j m. joinBlocks (splitBlocks i j m) = m
<a name="line-734"></a>  #-}</span>
<a name="line-735"></a>
<a name="line-736"></a><a name="%3c%7c%3e"></a><span class='hs-comment'>-- | Horizontally join two matrices. Visually:</span>
<a name="line-737"></a><span class='hs-comment'>--</span>
<a name="line-738"></a><span class='hs-comment'>-- &gt; ( A ) &lt;|&gt; ( B ) = ( A | B )</span>
<a name="line-739"></a><span class='hs-comment'>--</span>
<a name="line-740"></a><span class='hs-comment'>-- Where both matrices /A/ and /B/ have the same number of rows.</span>
<a name="line-741"></a><span class='hs-comment'>-- /This condition is not checked/.</span>
<a name="line-742"></a><span class='hs-layout'>(</span><span class='hs-varop'>&lt;|&gt;</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span>
<a name="line-743"></a><span class='hs-comment'>{-# INLINE (&lt;|&gt;) #-}</span>
<a name="line-744"></a><span class='hs-definition'>m</span> <span class='hs-varop'>&lt;|&gt;</span> <span class='hs-varid'>m'</span> <span class='hs-keyglyph'>=</span>
<a name="line-745"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ncols</span> <span class='hs-varid'>m</span>
<a name="line-746"></a>  <span class='hs-keyword'>in</span>  <span class='hs-varid'>matrix</span> <span class='hs-layout'>(</span><span class='hs-varid'>nrows</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>c</span> <span class='hs-varop'>+</span> <span class='hs-varid'>ncols</span> <span class='hs-varid'>m'</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span><span class='hs-varid'>j</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-747"></a>        <span class='hs-keyword'>if</span> <span class='hs-varid'>j</span> <span class='hs-varop'>&lt;=</span> <span class='hs-varid'>c</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>m</span> <span class='hs-varop'>!</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span><span class='hs-varid'>j</span><span class='hs-layout'>)</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>m'</span> <span class='hs-varop'>!</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span><span class='hs-varid'>j</span><span class='hs-comment'>-</span><span class='hs-varid'>c</span><span class='hs-layout'>)</span>
<a name="line-748"></a>
<a name="line-749"></a><a name="%3c-%3e"></a><span class='hs-comment'>-- | Vertically join two matrices. Visually:</span>
<a name="line-750"></a><span class='hs-comment'>--</span>
<a name="line-751"></a><span class='hs-comment'>-- &gt;                   ( A )</span>
<a name="line-752"></a><span class='hs-comment'>-- &gt; ( A ) &lt;-&gt; ( B ) = ( - )</span>
<a name="line-753"></a><span class='hs-comment'>-- &gt;                   ( B )</span>
<a name="line-754"></a><span class='hs-comment'>--</span>
<a name="line-755"></a><span class='hs-comment'>-- Where both matrices /A/ and /B/ have the same number of columns.</span>
<a name="line-756"></a><span class='hs-comment'>-- /This condition is not checked/.</span>
<a name="line-757"></a><span class='hs-layout'>(</span><span class='hs-varop'>&lt;-&gt;</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span>
<a name="line-758"></a><span class='hs-comment'>{-# INLINE (&lt;-&gt;) #-}</span>
<a name="line-759"></a><span class='hs-definition'>m</span> <span class='hs-varop'>&lt;-&gt;</span> <span class='hs-varid'>m'</span> <span class='hs-keyglyph'>=</span>
<a name="line-760"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>r</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nrows</span> <span class='hs-varid'>m</span>
<a name="line-761"></a>  <span class='hs-keyword'>in</span>  <span class='hs-varid'>matrix</span> <span class='hs-layout'>(</span><span class='hs-varid'>r</span> <span class='hs-varop'>+</span> <span class='hs-varid'>nrows</span> <span class='hs-varid'>m'</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ncols</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span><span class='hs-varid'>j</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-762"></a>        <span class='hs-keyword'>if</span> <span class='hs-varid'>i</span> <span class='hs-varop'>&lt;=</span> <span class='hs-varid'>r</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>m</span> <span class='hs-varop'>!</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span><span class='hs-varid'>j</span><span class='hs-layout'>)</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>m'</span> <span class='hs-varop'>!</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-comment'>-</span><span class='hs-varid'>r</span><span class='hs-layout'>,</span><span class='hs-varid'>j</span><span class='hs-layout'>)</span>
<a name="line-763"></a>
<a name="line-764"></a><span class='hs-comment'>-------------------------------------------------------</span>
<a name="line-765"></a><span class='hs-comment'>-------------------------------------------------------</span>
<a name="line-766"></a><span class='hs-comment'>---- MATRIX OPERATIONS</span>
<a name="line-767"></a>
<a name="line-768"></a><a name="elementwise"></a><span class='hs-comment'>-- | Perform an operation element-wise.</span>
<a name="line-769"></a><span class='hs-comment'>--   The second matrix must have at least as many rows</span>
<a name="line-770"></a><span class='hs-comment'>--   and columns as the first matrix. If it's bigger,</span>
<a name="line-771"></a><span class='hs-comment'>--   the leftover items will be ignored.</span>
<a name="line-772"></a><span class='hs-comment'>--   If it's smaller, it will cause a run-time error.</span>
<a name="line-773"></a><span class='hs-comment'>--   You may want to use 'elementwiseUnsafe' if you</span>
<a name="line-774"></a><span class='hs-comment'>--   are definitely sure that a run-time error won't</span>
<a name="line-775"></a><span class='hs-comment'>--   arise.</span>
<a name="line-776"></a><span class='hs-definition'>elementwise</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span>
<a name="line-777"></a><span class='hs-definition'>elementwise</span> <span class='hs-varid'>f</span> <span class='hs-varid'>m</span> <span class='hs-varid'>m'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>matrix</span> <span class='hs-layout'>(</span><span class='hs-varid'>nrows</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ncols</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-778"></a>  <span class='hs-keyglyph'>\</span><span class='hs-varid'>k</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-varid'>m</span> <span class='hs-varop'>!</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>m'</span> <span class='hs-varop'>!</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span>
<a name="line-779"></a>
<a name="line-780"></a><a name="elementwiseUnsafe"></a><span class='hs-comment'>-- | Unsafe version of 'elementwise', but faster.</span>
<a name="line-781"></a><span class='hs-definition'>elementwiseUnsafe</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span>
<a name="line-782"></a><span class='hs-comment'>{-# INLINE elementwiseUnsafe #-}</span>
<a name="line-783"></a><span class='hs-definition'>elementwiseUnsafe</span> <span class='hs-varid'>f</span> <span class='hs-varid'>m</span> <span class='hs-varid'>m'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>matrix</span> <span class='hs-layout'>(</span><span class='hs-varid'>nrows</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ncols</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-784"></a>  <span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span><span class='hs-varid'>j</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-varid'>unsafeGet</span> <span class='hs-varid'>i</span> <span class='hs-varid'>j</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>unsafeGet</span> <span class='hs-varid'>i</span> <span class='hs-varid'>j</span> <span class='hs-varid'>m'</span><span class='hs-layout'>)</span>
<a name="line-785"></a>
<a name="line-786"></a><span class='hs-keyword'>infixl</span> <span class='hs-num'>6</span> <span class='hs-varop'>+.</span><span class='hs-layout'>,</span> <span class='hs-varop'>-.</span>
<a name="line-787"></a>
<a name="line-788"></a><a name="+."></a><span class='hs-comment'>-- | Internal unsafe addition.</span>
<a name="line-789"></a><span class='hs-layout'>(</span><span class='hs-varop'>+.</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Num</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span>
<a name="line-790"></a><span class='hs-comment'>{-# INLINE (+.) #-}</span>
<a name="line-791"></a><span class='hs-layout'>(</span><span class='hs-varop'>+.</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>elementwiseUnsafe</span> <span class='hs-layout'>(</span><span class='hs-varop'>+</span><span class='hs-layout'>)</span>
<a name="line-792"></a>
<a name="line-793"></a><a name="-."></a><span class='hs-comment'>-- | Internal unsafe substraction.</span>
<a name="line-794"></a><span class='hs-layout'>(</span><span class='hs-varop'>-.</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Num</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span>
<a name="line-795"></a><span class='hs-comment'>{-# INLINE (-.) #-}</span>
<a name="line-796"></a><span class='hs-layout'>(</span><span class='hs-varop'>-.</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>elementwiseUnsafe</span> <span class='hs-layout'>(</span><span class='hs-comment'>-</span><span class='hs-layout'>)</span>
<a name="line-797"></a>
<a name="line-798"></a><span class='hs-comment'>-------------------------------------------------------</span>
<a name="line-799"></a><span class='hs-comment'>-------------------------------------------------------</span>
<a name="line-800"></a><span class='hs-comment'>---- MATRIX MULTIPLICATION</span>
<a name="line-801"></a>
<a name="line-802"></a><span class='hs-comment'>{- $mult
<a name="line-803"></a>
<a name="line-804"></a>Four methods are provided for matrix multiplication.
<a name="line-805"></a>
<a name="line-806"></a>* 'multStd':
<a name="line-807"></a>     Matrix multiplication following directly the definition.
<a name="line-808"></a>     This is the best choice when you know for sure that your
<a name="line-809"></a>     matrices are small.
<a name="line-810"></a>
<a name="line-811"></a>* 'multStd2':
<a name="line-812"></a>     Matrix multiplication following directly the definition.
<a name="line-813"></a>     However, using a different definition from 'multStd'.
<a name="line-814"></a>     According to our benchmarks with this version, 'multStd2' is
<a name="line-815"></a>     around 3 times faster than 'multStd'.
<a name="line-816"></a>
<a name="line-817"></a>* 'multStrassen':
<a name="line-818"></a>     Matrix multiplication following the Strassen's algorithm.
<a name="line-819"></a>     Complexity grows slower but also some work is added
<a name="line-820"></a>     partitioning the matrix. Also, it only works on square
<a name="line-821"></a>     matrices of order @2^n@, so if this condition is not
<a name="line-822"></a>     met, it is zero-padded until this is accomplished.
<a name="line-823"></a>     Therefore, its use is not recommended.
<a name="line-824"></a>
<a name="line-825"></a>* 'multStrassenMixed':
<a name="line-826"></a>     This function mixes the previous methods.
<a name="line-827"></a>     It provides a better performance in general. Method @(@'*'@)@
<a name="line-828"></a>     of the 'Num' class uses this function because it gives the best
<a name="line-829"></a>     average performance. However, if you know for sure that your matrices are
<a name="line-830"></a>     small (size less than 500x500), you should use 'multStd' or 'multStd2' instead,
<a name="line-831"></a>     since 'multStrassenMixed' is going to switch to those functions anyway.
<a name="line-832"></a>
<a name="line-833"></a>We keep researching how to get better performance for matrix multiplication.
<a name="line-834"></a>If you want to be on the safe side, use ('*').
<a name="line-835"></a>
<a name="line-836"></a>-}</span>
<a name="line-837"></a>
<a name="line-838"></a><a name="multStd"></a><span class='hs-comment'>-- | Standard matrix multiplication by definition.</span>
<a name="line-839"></a><span class='hs-definition'>multStd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Num</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span>
<a name="line-840"></a><span class='hs-comment'>{-# INLINE multStd #-}</span>
<a name="line-841"></a><span class='hs-definition'>multStd</span> <span class='hs-varid'>a1</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>M</span> <span class='hs-varid'>n</span> <span class='hs-varid'>m</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>a2</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>M</span> <span class='hs-varid'>n'</span> <span class='hs-varid'>m'</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-842"></a>   <span class='hs-comment'>-- Checking that sizes match...</span>
<a name="line-843"></a>   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>m</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>n'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>error</span> <span class='hs-varop'>$</span> <span class='hs-str'>"Multiplication of "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>sizeStr</span> <span class='hs-varid'>n</span> <span class='hs-varid'>m</span> <span class='hs-varop'>++</span> <span class='hs-str'>" and "</span>
<a name="line-844"></a>                    <span class='hs-varop'>++</span> <span class='hs-varid'>sizeStr</span> <span class='hs-varid'>n'</span> <span class='hs-varid'>m'</span> <span class='hs-varop'>++</span> <span class='hs-str'>" matrices."</span>
<a name="line-845"></a>   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>multStd_</span> <span class='hs-varid'>a1</span> <span class='hs-varid'>a2</span>
<a name="line-846"></a>
<a name="line-847"></a><a name="multStd2"></a><span class='hs-comment'>-- | Standard matrix multiplication by definition.</span>
<a name="line-848"></a><span class='hs-definition'>multStd2</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Num</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span>
<a name="line-849"></a><span class='hs-comment'>{-# INLINE multStd2 #-}</span>
<a name="line-850"></a><span class='hs-definition'>multStd2</span> <span class='hs-varid'>a1</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>M</span> <span class='hs-varid'>n</span> <span class='hs-varid'>m</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>a2</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>M</span> <span class='hs-varid'>n'</span> <span class='hs-varid'>m'</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-851"></a>   <span class='hs-comment'>-- Checking that sizes match...</span>
<a name="line-852"></a>   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>m</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>n'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>error</span> <span class='hs-varop'>$</span> <span class='hs-str'>"Multiplication of "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>sizeStr</span> <span class='hs-varid'>n</span> <span class='hs-varid'>m</span> <span class='hs-varop'>++</span> <span class='hs-str'>" and "</span>
<a name="line-853"></a>                    <span class='hs-varop'>++</span> <span class='hs-varid'>sizeStr</span> <span class='hs-varid'>n'</span> <span class='hs-varid'>m'</span> <span class='hs-varop'>++</span> <span class='hs-str'>" matrices."</span>
<a name="line-854"></a>   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>multStd__</span> <span class='hs-varid'>a1</span> <span class='hs-varid'>a2</span>
<a name="line-855"></a>
<a name="line-856"></a><a name="multStd_"></a><span class='hs-comment'>-- | Standard matrix multiplication by definition, without checking if sizes match.</span>
<a name="line-857"></a><span class='hs-definition'>multStd_</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Num</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span>
<a name="line-858"></a><span class='hs-comment'>{-# INLINE multStd_ #-}</span>
<a name="line-859"></a><span class='hs-definition'>multStd_</span> <span class='hs-varid'>a</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>M</span> <span class='hs-num'>1</span> <span class='hs-num'>1</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>b</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>M</span> <span class='hs-num'>1</span> <span class='hs-num'>1</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>M</span> <span class='hs-num'>1</span> <span class='hs-num'>1</span> <span class='hs-num'>0</span> <span class='hs-num'>0</span> <span class='hs-num'>1</span> <span class='hs-varop'>$</span> <span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>singleton</span> <span class='hs-varop'>$</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-varop'>!</span> <span class='hs-layout'>(</span><span class='hs-num'>1</span><span class='hs-layout'>,</span><span class='hs-num'>1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>*</span> <span class='hs-layout'>(</span><span class='hs-varid'>b</span> <span class='hs-varop'>!</span> <span class='hs-layout'>(</span><span class='hs-num'>1</span><span class='hs-layout'>,</span><span class='hs-num'>1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-860"></a><span class='hs-definition'>multStd_</span> <span class='hs-varid'>a</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>M</span> <span class='hs-num'>2</span> <span class='hs-num'>2</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>b</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>M</span> <span class='hs-num'>2</span> <span class='hs-num'>2</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-861"></a>  <span class='hs-conid'>M</span> <span class='hs-num'>2</span> <span class='hs-num'>2</span> <span class='hs-num'>0</span> <span class='hs-num'>0</span> <span class='hs-num'>2</span> <span class='hs-varop'>$</span>
<a name="line-862"></a>    <span class='hs-keyword'>let</span> <span class='hs-comment'>-- A</span>
<a name="line-863"></a>        <span class='hs-varid'>a11</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>a</span> <span class='hs-varop'>!.</span> <span class='hs-layout'>(</span><span class='hs-num'>1</span><span class='hs-layout'>,</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-layout'>;</span> <span class='hs-varid'>a12</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>a</span> <span class='hs-varop'>!.</span> <span class='hs-layout'>(</span><span class='hs-num'>1</span><span class='hs-layout'>,</span><span class='hs-num'>2</span><span class='hs-layout'>)</span>
<a name="line-864"></a>        <span class='hs-varid'>a21</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>a</span> <span class='hs-varop'>!.</span> <span class='hs-layout'>(</span><span class='hs-num'>2</span><span class='hs-layout'>,</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-layout'>;</span> <span class='hs-varid'>a22</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>a</span> <span class='hs-varop'>!.</span> <span class='hs-layout'>(</span><span class='hs-num'>2</span><span class='hs-layout'>,</span><span class='hs-num'>2</span><span class='hs-layout'>)</span>
<a name="line-865"></a>        <span class='hs-comment'>-- B</span>
<a name="line-866"></a>        <span class='hs-varid'>b11</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>b</span> <span class='hs-varop'>!.</span> <span class='hs-layout'>(</span><span class='hs-num'>1</span><span class='hs-layout'>,</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-layout'>;</span> <span class='hs-varid'>b12</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>b</span> <span class='hs-varop'>!.</span> <span class='hs-layout'>(</span><span class='hs-num'>1</span><span class='hs-layout'>,</span><span class='hs-num'>2</span><span class='hs-layout'>)</span>
<a name="line-867"></a>        <span class='hs-varid'>b21</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>b</span> <span class='hs-varop'>!.</span> <span class='hs-layout'>(</span><span class='hs-num'>2</span><span class='hs-layout'>,</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-layout'>;</span> <span class='hs-varid'>b22</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>b</span> <span class='hs-varop'>!.</span> <span class='hs-layout'>(</span><span class='hs-num'>2</span><span class='hs-layout'>,</span><span class='hs-num'>2</span><span class='hs-layout'>)</span>
<a name="line-868"></a>    <span class='hs-keyword'>in</span> <span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>fromList</span> 
<a name="line-869"></a>         <span class='hs-keyglyph'>[</span> <span class='hs-varid'>a11</span><span class='hs-varop'>*</span><span class='hs-varid'>b11</span> <span class='hs-varop'>+</span> <span class='hs-varid'>a12</span><span class='hs-varop'>*</span><span class='hs-varid'>b21</span> <span class='hs-layout'>,</span> <span class='hs-varid'>a11</span><span class='hs-varop'>*</span><span class='hs-varid'>b12</span> <span class='hs-varop'>+</span> <span class='hs-varid'>a12</span><span class='hs-varop'>*</span><span class='hs-varid'>b22</span>
<a name="line-870"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>a21</span><span class='hs-varop'>*</span><span class='hs-varid'>b11</span> <span class='hs-varop'>+</span> <span class='hs-varid'>a22</span><span class='hs-varop'>*</span><span class='hs-varid'>b21</span> <span class='hs-layout'>,</span> <span class='hs-varid'>a21</span><span class='hs-varop'>*</span><span class='hs-varid'>b12</span> <span class='hs-varop'>+</span> <span class='hs-varid'>a22</span><span class='hs-varop'>*</span><span class='hs-varid'>b22</span>
<a name="line-871"></a>           <span class='hs-keyglyph'>]</span>
<a name="line-872"></a><span class='hs-definition'>multStd_</span> <span class='hs-varid'>a</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>M</span> <span class='hs-num'>3</span> <span class='hs-num'>3</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>b</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>M</span> <span class='hs-num'>3</span> <span class='hs-num'>3</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-873"></a>  <span class='hs-conid'>M</span> <span class='hs-num'>3</span> <span class='hs-num'>3</span> <span class='hs-num'>0</span> <span class='hs-num'>0</span> <span class='hs-num'>3</span> <span class='hs-varop'>$</span>
<a name="line-874"></a>    <span class='hs-keyword'>let</span> <span class='hs-comment'>-- A</span>
<a name="line-875"></a>        <span class='hs-varid'>a11</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>a</span> <span class='hs-varop'>!.</span> <span class='hs-layout'>(</span><span class='hs-num'>1</span><span class='hs-layout'>,</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-layout'>;</span> <span class='hs-varid'>a12</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>a</span> <span class='hs-varop'>!.</span> <span class='hs-layout'>(</span><span class='hs-num'>1</span><span class='hs-layout'>,</span><span class='hs-num'>2</span><span class='hs-layout'>)</span> <span class='hs-layout'>;</span> <span class='hs-varid'>a13</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>a</span> <span class='hs-varop'>!.</span> <span class='hs-layout'>(</span><span class='hs-num'>1</span><span class='hs-layout'>,</span><span class='hs-num'>3</span><span class='hs-layout'>)</span>
<a name="line-876"></a>        <span class='hs-varid'>a21</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>a</span> <span class='hs-varop'>!.</span> <span class='hs-layout'>(</span><span class='hs-num'>2</span><span class='hs-layout'>,</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-layout'>;</span> <span class='hs-varid'>a22</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>a</span> <span class='hs-varop'>!.</span> <span class='hs-layout'>(</span><span class='hs-num'>2</span><span class='hs-layout'>,</span><span class='hs-num'>2</span><span class='hs-layout'>)</span> <span class='hs-layout'>;</span> <span class='hs-varid'>a23</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>a</span> <span class='hs-varop'>!.</span> <span class='hs-layout'>(</span><span class='hs-num'>2</span><span class='hs-layout'>,</span><span class='hs-num'>3</span><span class='hs-layout'>)</span>
<a name="line-877"></a>        <span class='hs-varid'>a31</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>a</span> <span class='hs-varop'>!.</span> <span class='hs-layout'>(</span><span class='hs-num'>3</span><span class='hs-layout'>,</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-layout'>;</span> <span class='hs-varid'>a32</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>a</span> <span class='hs-varop'>!.</span> <span class='hs-layout'>(</span><span class='hs-num'>3</span><span class='hs-layout'>,</span><span class='hs-num'>2</span><span class='hs-layout'>)</span> <span class='hs-layout'>;</span> <span class='hs-varid'>a33</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>a</span> <span class='hs-varop'>!.</span> <span class='hs-layout'>(</span><span class='hs-num'>3</span><span class='hs-layout'>,</span><span class='hs-num'>3</span><span class='hs-layout'>)</span>
<a name="line-878"></a>        <span class='hs-comment'>-- B</span>
<a name="line-879"></a>        <span class='hs-varid'>b11</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>b</span> <span class='hs-varop'>!.</span> <span class='hs-layout'>(</span><span class='hs-num'>1</span><span class='hs-layout'>,</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-layout'>;</span> <span class='hs-varid'>b12</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>b</span> <span class='hs-varop'>!.</span> <span class='hs-layout'>(</span><span class='hs-num'>1</span><span class='hs-layout'>,</span><span class='hs-num'>2</span><span class='hs-layout'>)</span> <span class='hs-layout'>;</span> <span class='hs-varid'>b13</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>b</span> <span class='hs-varop'>!.</span> <span class='hs-layout'>(</span><span class='hs-num'>1</span><span class='hs-layout'>,</span><span class='hs-num'>3</span><span class='hs-layout'>)</span>
<a name="line-880"></a>        <span class='hs-varid'>b21</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>b</span> <span class='hs-varop'>!.</span> <span class='hs-layout'>(</span><span class='hs-num'>2</span><span class='hs-layout'>,</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-layout'>;</span> <span class='hs-varid'>b22</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>b</span> <span class='hs-varop'>!.</span> <span class='hs-layout'>(</span><span class='hs-num'>2</span><span class='hs-layout'>,</span><span class='hs-num'>2</span><span class='hs-layout'>)</span> <span class='hs-layout'>;</span> <span class='hs-varid'>b23</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>b</span> <span class='hs-varop'>!.</span> <span class='hs-layout'>(</span><span class='hs-num'>2</span><span class='hs-layout'>,</span><span class='hs-num'>3</span><span class='hs-layout'>)</span>
<a name="line-881"></a>        <span class='hs-varid'>b31</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>b</span> <span class='hs-varop'>!.</span> <span class='hs-layout'>(</span><span class='hs-num'>3</span><span class='hs-layout'>,</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-layout'>;</span> <span class='hs-varid'>b32</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>b</span> <span class='hs-varop'>!.</span> <span class='hs-layout'>(</span><span class='hs-num'>3</span><span class='hs-layout'>,</span><span class='hs-num'>2</span><span class='hs-layout'>)</span> <span class='hs-layout'>;</span> <span class='hs-varid'>b33</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>b</span> <span class='hs-varop'>!.</span> <span class='hs-layout'>(</span><span class='hs-num'>3</span><span class='hs-layout'>,</span><span class='hs-num'>3</span><span class='hs-layout'>)</span>
<a name="line-882"></a>    <span class='hs-keyword'>in</span> <span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>fromList</span>
<a name="line-883"></a>         <span class='hs-keyglyph'>[</span> <span class='hs-varid'>a11</span><span class='hs-varop'>*</span><span class='hs-varid'>b11</span> <span class='hs-varop'>+</span> <span class='hs-varid'>a12</span><span class='hs-varop'>*</span><span class='hs-varid'>b21</span> <span class='hs-varop'>+</span> <span class='hs-varid'>a13</span><span class='hs-varop'>*</span><span class='hs-varid'>b31</span> <span class='hs-layout'>,</span> <span class='hs-varid'>a11</span><span class='hs-varop'>*</span><span class='hs-varid'>b12</span> <span class='hs-varop'>+</span> <span class='hs-varid'>a12</span><span class='hs-varop'>*</span><span class='hs-varid'>b22</span> <span class='hs-varop'>+</span> <span class='hs-varid'>a13</span><span class='hs-varop'>*</span><span class='hs-varid'>b32</span> <span class='hs-layout'>,</span> <span class='hs-varid'>a11</span><span class='hs-varop'>*</span><span class='hs-varid'>b13</span> <span class='hs-varop'>+</span> <span class='hs-varid'>a12</span><span class='hs-varop'>*</span><span class='hs-varid'>b23</span> <span class='hs-varop'>+</span> <span class='hs-varid'>a13</span><span class='hs-varop'>*</span><span class='hs-varid'>b33</span>
<a name="line-884"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>a21</span><span class='hs-varop'>*</span><span class='hs-varid'>b11</span> <span class='hs-varop'>+</span> <span class='hs-varid'>a22</span><span class='hs-varop'>*</span><span class='hs-varid'>b21</span> <span class='hs-varop'>+</span> <span class='hs-varid'>a23</span><span class='hs-varop'>*</span><span class='hs-varid'>b31</span> <span class='hs-layout'>,</span> <span class='hs-varid'>a21</span><span class='hs-varop'>*</span><span class='hs-varid'>b12</span> <span class='hs-varop'>+</span> <span class='hs-varid'>a22</span><span class='hs-varop'>*</span><span class='hs-varid'>b22</span> <span class='hs-varop'>+</span> <span class='hs-varid'>a23</span><span class='hs-varop'>*</span><span class='hs-varid'>b32</span> <span class='hs-layout'>,</span> <span class='hs-varid'>a21</span><span class='hs-varop'>*</span><span class='hs-varid'>b13</span> <span class='hs-varop'>+</span> <span class='hs-varid'>a22</span><span class='hs-varop'>*</span><span class='hs-varid'>b23</span> <span class='hs-varop'>+</span> <span class='hs-varid'>a23</span><span class='hs-varop'>*</span><span class='hs-varid'>b33</span>
<a name="line-885"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>a31</span><span class='hs-varop'>*</span><span class='hs-varid'>b11</span> <span class='hs-varop'>+</span> <span class='hs-varid'>a32</span><span class='hs-varop'>*</span><span class='hs-varid'>b21</span> <span class='hs-varop'>+</span> <span class='hs-varid'>a33</span><span class='hs-varop'>*</span><span class='hs-varid'>b31</span> <span class='hs-layout'>,</span> <span class='hs-varid'>a31</span><span class='hs-varop'>*</span><span class='hs-varid'>b12</span> <span class='hs-varop'>+</span> <span class='hs-varid'>a32</span><span class='hs-varop'>*</span><span class='hs-varid'>b22</span> <span class='hs-varop'>+</span> <span class='hs-varid'>a33</span><span class='hs-varop'>*</span><span class='hs-varid'>b32</span> <span class='hs-layout'>,</span> <span class='hs-varid'>a31</span><span class='hs-varop'>*</span><span class='hs-varid'>b13</span> <span class='hs-varop'>+</span> <span class='hs-varid'>a32</span><span class='hs-varop'>*</span><span class='hs-varid'>b23</span> <span class='hs-varop'>+</span> <span class='hs-varid'>a33</span><span class='hs-varop'>*</span><span class='hs-varid'>b33</span>
<a name="line-886"></a>           <span class='hs-keyglyph'>]</span>
<a name="line-887"></a><span class='hs-definition'>multStd_</span> <span class='hs-varid'>a</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>M</span> <span class='hs-varid'>n</span> <span class='hs-varid'>m</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>b</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>M</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>m'</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>matrix</span> <span class='hs-varid'>n</span> <span class='hs-varid'>m'</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span><span class='hs-varid'>j</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>sum</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>a</span> <span class='hs-varop'>!.</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span><span class='hs-varid'>k</span><span class='hs-layout'>)</span> <span class='hs-varop'>*</span> <span class='hs-varid'>b</span> <span class='hs-varop'>!.</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span><span class='hs-layout'>,</span><span class='hs-varid'>j</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>1</span> <span class='hs-keyglyph'>..</span> <span class='hs-varid'>m</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>]</span>
<a name="line-888"></a>
<a name="line-889"></a><a name="multStd__"></a><span class='hs-definition'>multStd__</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Num</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span>
<a name="line-890"></a><span class='hs-comment'>{-# INLINE multStd__ #-}</span>
<a name="line-891"></a><span class='hs-definition'>multStd__</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>matrix</span> <span class='hs-varid'>r</span> <span class='hs-varid'>c</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span><span class='hs-varid'>j</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>dotProduct</span> <span class='hs-layout'>(</span><span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>unsafeIndex</span> <span class='hs-varid'>avs</span> <span class='hs-varop'>$</span> <span class='hs-varid'>i</span> <span class='hs-comment'>-</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>unsafeIndex</span> <span class='hs-varid'>bvs</span> <span class='hs-varop'>$</span> <span class='hs-varid'>j</span> <span class='hs-comment'>-</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-892"></a>  <span class='hs-keyword'>where</span>
<a name="line-893"></a>    <span class='hs-varid'>r</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nrows</span> <span class='hs-varid'>a</span>
<a name="line-894"></a>    <span class='hs-varid'>avs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>generate</span> <span class='hs-varid'>r</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>i</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>getRow</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>a</span>
<a name="line-895"></a>    <span class='hs-varid'>c</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ncols</span> <span class='hs-varid'>b</span>
<a name="line-896"></a>    <span class='hs-varid'>bvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>generate</span> <span class='hs-varid'>c</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>i</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>getCol</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>b</span>
<a name="line-897"></a>
<a name="line-898"></a><a name="dotProduct"></a><span class='hs-definition'>dotProduct</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Num</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-conid'>Vector</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-conid'>Vector</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span>
<a name="line-899"></a><span class='hs-comment'>{-# INLINE dotProduct #-}</span>
<a name="line-900"></a><span class='hs-definition'>dotProduct</span> <span class='hs-varid'>v1</span> <span class='hs-varid'>v2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>numLoopFold</span> <span class='hs-num'>0</span> <span class='hs-layout'>(</span><span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>length</span> <span class='hs-varid'>v1</span> <span class='hs-comment'>-</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-num'>0</span> <span class='hs-varop'>$</span>
<a name="line-901"></a>  <span class='hs-keyglyph'>\</span><span class='hs-varid'>r</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>unsafeIndex</span> <span class='hs-varid'>v1</span> <span class='hs-varid'>i</span> <span class='hs-varop'>*</span> <span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>unsafeIndex</span> <span class='hs-varid'>v2</span> <span class='hs-varid'>i</span> <span class='hs-varop'>+</span> <span class='hs-varid'>r</span>
<a name="line-902"></a>
<a name="line-903"></a><span class='hs-comment'>{-
<a name="line-904"></a>dotProduct v1 v2 = go (V.length v1 - 1) 0
<a name="line-905"></a>  where
<a name="line-906"></a>    go (-1) a = a
<a name="line-907"></a>    go i a = go (i-1) $ (V.unsafeIndex v1 i) * (V.unsafeIndex v2 i) + a
<a name="line-908"></a>-}</span>
<a name="line-909"></a>
<a name="line-910"></a><a name="first"></a><span class='hs-definition'>first</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span>
<a name="line-911"></a><span class='hs-definition'>first</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span>
<a name="line-912"></a> <span class='hs-keyword'>where</span>
<a name="line-913"></a>  <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>f</span> <span class='hs-varid'>x</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>x</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>go</span> <span class='hs-varid'>xs</span>
<a name="line-914"></a>  <span class='hs-varid'>go</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>error</span> <span class='hs-str'>"first: no element match the condition."</span>
<a name="line-915"></a>
<a name="line-916"></a><a name="strassen"></a><span class='hs-comment'>-- | Strassen's algorithm over square matrices of order @2^n@.</span>
<a name="line-917"></a><span class='hs-definition'>strassen</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Num</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span>
<a name="line-918"></a><span class='hs-comment'>-- Trivial 1x1 multiplication.</span>
<a name="line-919"></a><span class='hs-definition'>strassen</span> <span class='hs-varid'>a</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>M</span> <span class='hs-num'>1</span> <span class='hs-num'>1</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>b</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>M</span> <span class='hs-num'>1</span> <span class='hs-num'>1</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>M</span> <span class='hs-num'>1</span> <span class='hs-num'>1</span> <span class='hs-num'>0</span> <span class='hs-num'>0</span> <span class='hs-num'>1</span> <span class='hs-varop'>$</span> <span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>singleton</span> <span class='hs-varop'>$</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-varop'>!</span> <span class='hs-layout'>(</span><span class='hs-num'>1</span><span class='hs-layout'>,</span><span class='hs-num'>1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>*</span> <span class='hs-layout'>(</span><span class='hs-varid'>b</span> <span class='hs-varop'>!</span> <span class='hs-layout'>(</span><span class='hs-num'>1</span><span class='hs-layout'>,</span><span class='hs-num'>1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-920"></a><span class='hs-comment'>-- General case guesses that the input matrices are square matrices</span>
<a name="line-921"></a><span class='hs-comment'>-- whose order is a power of two.</span>
<a name="line-922"></a><span class='hs-definition'>strassen</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>joinBlocks</span> <span class='hs-layout'>(</span><span class='hs-varid'>c11</span><span class='hs-layout'>,</span><span class='hs-varid'>c12</span><span class='hs-layout'>,</span><span class='hs-varid'>c21</span><span class='hs-layout'>,</span><span class='hs-varid'>c22</span><span class='hs-layout'>)</span>
<a name="line-923"></a> <span class='hs-keyword'>where</span>
<a name="line-924"></a>  <span class='hs-comment'>-- Size of the subproblem is halved.</span>
<a name="line-925"></a>  <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>div</span> <span class='hs-layout'>(</span><span class='hs-varid'>nrows</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-num'>2</span>
<a name="line-926"></a>  <span class='hs-comment'>-- Split of the original problem into smaller subproblems.</span>
<a name="line-927"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>a11</span><span class='hs-layout'>,</span><span class='hs-varid'>a12</span><span class='hs-layout'>,</span><span class='hs-varid'>a21</span><span class='hs-layout'>,</span><span class='hs-varid'>a22</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitBlocks</span> <span class='hs-varid'>n</span> <span class='hs-varid'>n</span> <span class='hs-varid'>a</span>
<a name="line-928"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>b11</span><span class='hs-layout'>,</span><span class='hs-varid'>b12</span><span class='hs-layout'>,</span><span class='hs-varid'>b21</span><span class='hs-layout'>,</span><span class='hs-varid'>b22</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitBlocks</span> <span class='hs-varid'>n</span> <span class='hs-varid'>n</span> <span class='hs-varid'>b</span>
<a name="line-929"></a>  <span class='hs-comment'>-- The seven Strassen's products.</span>
<a name="line-930"></a>  <span class='hs-varid'>p1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>strassen</span> <span class='hs-layout'>(</span><span class='hs-varid'>a11</span> <span class='hs-varop'>+</span> <span class='hs-varid'>a22</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>b11</span> <span class='hs-varop'>+</span> <span class='hs-varid'>b22</span><span class='hs-layout'>)</span>
<a name="line-931"></a>  <span class='hs-varid'>p2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>strassen</span> <span class='hs-layout'>(</span><span class='hs-varid'>a21</span> <span class='hs-varop'>+</span> <span class='hs-varid'>a22</span><span class='hs-layout'>)</span>  <span class='hs-varid'>b11</span>
<a name="line-932"></a>  <span class='hs-varid'>p3</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>strassen</span>  <span class='hs-varid'>a11</span>        <span class='hs-layout'>(</span><span class='hs-varid'>b12</span> <span class='hs-comment'>-</span> <span class='hs-varid'>b22</span><span class='hs-layout'>)</span>
<a name="line-933"></a>  <span class='hs-varid'>p4</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>strassen</span>        <span class='hs-varid'>a22</span>  <span class='hs-layout'>(</span><span class='hs-varid'>b21</span> <span class='hs-comment'>-</span> <span class='hs-varid'>b11</span><span class='hs-layout'>)</span>
<a name="line-934"></a>  <span class='hs-varid'>p5</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>strassen</span> <span class='hs-layout'>(</span><span class='hs-varid'>a11</span> <span class='hs-varop'>+</span> <span class='hs-varid'>a12</span><span class='hs-layout'>)</span>        <span class='hs-varid'>b22</span>
<a name="line-935"></a>  <span class='hs-varid'>p6</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>strassen</span> <span class='hs-layout'>(</span><span class='hs-varid'>a21</span> <span class='hs-comment'>-</span> <span class='hs-varid'>a11</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>b11</span> <span class='hs-varop'>+</span> <span class='hs-varid'>b12</span><span class='hs-layout'>)</span>
<a name="line-936"></a>  <span class='hs-varid'>p7</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>strassen</span> <span class='hs-layout'>(</span><span class='hs-varid'>a12</span> <span class='hs-comment'>-</span> <span class='hs-varid'>a22</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>b21</span> <span class='hs-varop'>+</span> <span class='hs-varid'>b22</span><span class='hs-layout'>)</span>
<a name="line-937"></a>  <span class='hs-comment'>-- Merging blocks</span>
<a name="line-938"></a>  <span class='hs-varid'>c11</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>p1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>p4</span> <span class='hs-comment'>-</span> <span class='hs-varid'>p5</span> <span class='hs-varop'>+</span> <span class='hs-varid'>p7</span>
<a name="line-939"></a>  <span class='hs-varid'>c12</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>p3</span> <span class='hs-varop'>+</span> <span class='hs-varid'>p5</span>
<a name="line-940"></a>  <span class='hs-varid'>c21</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>p2</span> <span class='hs-varop'>+</span> <span class='hs-varid'>p4</span>
<a name="line-941"></a>  <span class='hs-varid'>c22</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>p1</span> <span class='hs-comment'>-</span> <span class='hs-varid'>p2</span> <span class='hs-varop'>+</span> <span class='hs-varid'>p3</span> <span class='hs-varop'>+</span> <span class='hs-varid'>p6</span>
<a name="line-942"></a>
<a name="line-943"></a><a name="multStrassen"></a><span class='hs-comment'>-- | Strassen's matrix multiplication.</span>
<a name="line-944"></a><span class='hs-definition'>multStrassen</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Num</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span>
<a name="line-945"></a><span class='hs-definition'>multStrassen</span> <span class='hs-varid'>a1</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>M</span> <span class='hs-varid'>n</span> <span class='hs-varid'>m</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>a2</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>M</span> <span class='hs-varid'>n'</span> <span class='hs-varid'>m'</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-946"></a>   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>m</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>n'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>error</span> <span class='hs-varop'>$</span> <span class='hs-str'>"Multiplication of "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>sizeStr</span> <span class='hs-varid'>n</span> <span class='hs-varid'>m</span> <span class='hs-varop'>++</span> <span class='hs-str'>" and "</span>
<a name="line-947"></a>                    <span class='hs-varop'>++</span> <span class='hs-varid'>sizeStr</span> <span class='hs-varid'>n'</span> <span class='hs-varid'>m'</span> <span class='hs-varop'>++</span> <span class='hs-str'>" matrices."</span>
<a name="line-948"></a>   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span>
<a name="line-949"></a>       <span class='hs-keyword'>let</span> <span class='hs-varid'>mx</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maximum</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span><span class='hs-varid'>m</span><span class='hs-layout'>,</span><span class='hs-varid'>n'</span><span class='hs-layout'>,</span><span class='hs-varid'>m'</span><span class='hs-keyglyph'>]</span>
<a name="line-950"></a>           <span class='hs-varid'>n2</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>first</span> <span class='hs-layout'>(</span><span class='hs-varop'>&gt;=</span> <span class='hs-varid'>mx</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>fmap</span> <span class='hs-layout'>(</span><span class='hs-num'>2</span><span class='hs-varop'>^</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-num'>0</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>..</span><span class='hs-keyglyph'>]</span>
<a name="line-951"></a>           <span class='hs-varid'>b1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSize</span> <span class='hs-num'>0</span> <span class='hs-varid'>n2</span> <span class='hs-varid'>n2</span> <span class='hs-varid'>a1</span>
<a name="line-952"></a>           <span class='hs-varid'>b2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSize</span> <span class='hs-num'>0</span> <span class='hs-varid'>n2</span> <span class='hs-varid'>n2</span> <span class='hs-varid'>a2</span>
<a name="line-953"></a>       <span class='hs-keyword'>in</span>  <span class='hs-varid'>submatrix</span> <span class='hs-num'>1</span> <span class='hs-varid'>n</span> <span class='hs-num'>1</span> <span class='hs-varid'>m'</span> <span class='hs-varop'>$</span> <span class='hs-varid'>strassen</span> <span class='hs-varid'>b1</span> <span class='hs-varid'>b2</span>
<a name="line-954"></a>
<a name="line-955"></a><a name="strmixFactor"></a><span class='hs-definition'>strmixFactor</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span>
<a name="line-956"></a><span class='hs-definition'>strmixFactor</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>300</span>
<a name="line-957"></a>
<a name="line-958"></a><a name="strassenMixed"></a><span class='hs-comment'>-- | Strassen's mixed algorithm.</span>
<a name="line-959"></a><span class='hs-definition'>strassenMixed</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Num</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span>
<a name="line-960"></a><span class='hs-comment'>{-# SPECIALIZE strassenMixed :: Matrix Double -&gt; Matrix Double -&gt; Matrix Double #-}</span>
<a name="line-961"></a><span class='hs-comment'>{-# SPECIALIZE strassenMixed :: Matrix Int -&gt; Matrix Int -&gt; Matrix Int #-}</span>
<a name="line-962"></a><span class='hs-comment'>{-# SPECIALIZE strassenMixed :: Matrix Rational -&gt; Matrix Rational -&gt; Matrix Rational #-}</span>
<a name="line-963"></a><span class='hs-definition'>strassenMixed</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span>
<a name="line-964"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>r</span> <span class='hs-varop'>&lt;</span> <span class='hs-varid'>strmixFactor</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>multStd__</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span>
<a name="line-965"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>odd</span> <span class='hs-varid'>r</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>r'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>r</span> <span class='hs-varop'>+</span> <span class='hs-num'>1</span>
<a name="line-966"></a>               <span class='hs-varid'>a'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSize</span> <span class='hs-num'>0</span> <span class='hs-varid'>r'</span> <span class='hs-varid'>r'</span> <span class='hs-varid'>a</span>
<a name="line-967"></a>               <span class='hs-varid'>b'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSize</span> <span class='hs-num'>0</span> <span class='hs-varid'>r'</span> <span class='hs-varid'>r'</span> <span class='hs-varid'>b</span>
<a name="line-968"></a>           <span class='hs-keyword'>in</span>  <span class='hs-varid'>submatrix</span> <span class='hs-num'>1</span> <span class='hs-varid'>r</span> <span class='hs-num'>1</span> <span class='hs-varid'>r</span> <span class='hs-varop'>$</span> <span class='hs-varid'>strassenMixed</span> <span class='hs-varid'>a'</span> <span class='hs-varid'>b'</span>
<a name="line-969"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span>
<a name="line-970"></a>      <span class='hs-conid'>M</span> <span class='hs-varid'>r</span> <span class='hs-varid'>r</span> <span class='hs-num'>0</span> <span class='hs-num'>0</span> <span class='hs-varid'>r</span> <span class='hs-varop'>$</span> <span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>create</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-971"></a>         <span class='hs-varid'>v</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>MV</span><span class='hs-varop'>.</span><span class='hs-varid'>unsafeNew</span> <span class='hs-layout'>(</span><span class='hs-varid'>r</span><span class='hs-varop'>*</span><span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-972"></a>         <span class='hs-keyword'>let</span> <span class='hs-varid'>en</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>encode</span> <span class='hs-varid'>r</span>
<a name="line-973"></a>             <span class='hs-varid'>n'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span> <span class='hs-varop'>+</span> <span class='hs-num'>1</span>
<a name="line-974"></a>         <span class='hs-comment'>-- c11 = p1 + p4 - p5 + p7</span>
<a name="line-975"></a>         <span class='hs-varid'>sequence_</span> <span class='hs-keyglyph'>[</span> <span class='hs-conid'>MV</span><span class='hs-varop'>.</span><span class='hs-varid'>write</span> <span class='hs-varid'>v</span> <span class='hs-varid'>k</span> <span class='hs-varop'>$</span>
<a name="line-976"></a>                         <span class='hs-varid'>unsafeGet</span> <span class='hs-varid'>i</span> <span class='hs-varid'>j</span> <span class='hs-varid'>p1</span>
<a name="line-977"></a>                       <span class='hs-varop'>+</span> <span class='hs-varid'>unsafeGet</span> <span class='hs-varid'>i</span> <span class='hs-varid'>j</span> <span class='hs-varid'>p4</span>
<a name="line-978"></a>                       <span class='hs-comment'>-</span> <span class='hs-varid'>unsafeGet</span> <span class='hs-varid'>i</span> <span class='hs-varid'>j</span> <span class='hs-varid'>p5</span>
<a name="line-979"></a>                       <span class='hs-varop'>+</span> <span class='hs-varid'>unsafeGet</span> <span class='hs-varid'>i</span> <span class='hs-varid'>j</span> <span class='hs-varid'>p7</span>
<a name="line-980"></a>                   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>1</span><span class='hs-keyglyph'>..</span><span class='hs-varid'>n</span><span class='hs-keyglyph'>]</span>
<a name="line-981"></a>                   <span class='hs-layout'>,</span> <span class='hs-varid'>j</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>1</span><span class='hs-keyglyph'>..</span><span class='hs-varid'>n</span><span class='hs-keyglyph'>]</span>
<a name="line-982"></a>                   <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>en</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span><span class='hs-varid'>j</span><span class='hs-layout'>)</span>
<a name="line-983"></a>                     <span class='hs-keyglyph'>]</span>
<a name="line-984"></a>         <span class='hs-comment'>-- c12 = p3 + p5</span>
<a name="line-985"></a>         <span class='hs-varid'>sequence_</span> <span class='hs-keyglyph'>[</span> <span class='hs-conid'>MV</span><span class='hs-varop'>.</span><span class='hs-varid'>write</span> <span class='hs-varid'>v</span> <span class='hs-varid'>k</span> <span class='hs-varop'>$</span>
<a name="line-986"></a>                         <span class='hs-varid'>unsafeGet</span> <span class='hs-varid'>i</span> <span class='hs-varid'>j'</span> <span class='hs-varid'>p3</span>
<a name="line-987"></a>                       <span class='hs-varop'>+</span> <span class='hs-varid'>unsafeGet</span> <span class='hs-varid'>i</span> <span class='hs-varid'>j'</span> <span class='hs-varid'>p5</span>
<a name="line-988"></a>                   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>1</span><span class='hs-keyglyph'>..</span><span class='hs-varid'>n</span><span class='hs-keyglyph'>]</span>
<a name="line-989"></a>                   <span class='hs-layout'>,</span> <span class='hs-varid'>j</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>n'</span><span class='hs-keyglyph'>..</span><span class='hs-varid'>r</span><span class='hs-keyglyph'>]</span>
<a name="line-990"></a>                   <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>en</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span><span class='hs-varid'>j</span><span class='hs-layout'>)</span>
<a name="line-991"></a>                   <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>j'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>j</span> <span class='hs-comment'>-</span> <span class='hs-varid'>n</span>
<a name="line-992"></a>                     <span class='hs-keyglyph'>]</span>
<a name="line-993"></a>         <span class='hs-comment'>-- c21 = p2 + p4</span>
<a name="line-994"></a>         <span class='hs-varid'>sequence_</span> <span class='hs-keyglyph'>[</span> <span class='hs-conid'>MV</span><span class='hs-varop'>.</span><span class='hs-varid'>write</span> <span class='hs-varid'>v</span> <span class='hs-varid'>k</span> <span class='hs-varop'>$</span>
<a name="line-995"></a>                         <span class='hs-varid'>unsafeGet</span> <span class='hs-varid'>i'</span> <span class='hs-varid'>j</span> <span class='hs-varid'>p2</span>
<a name="line-996"></a>                       <span class='hs-varop'>+</span> <span class='hs-varid'>unsafeGet</span> <span class='hs-varid'>i'</span> <span class='hs-varid'>j</span> <span class='hs-varid'>p4</span>
<a name="line-997"></a>                   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>n'</span><span class='hs-keyglyph'>..</span><span class='hs-varid'>r</span><span class='hs-keyglyph'>]</span>
<a name="line-998"></a>                   <span class='hs-layout'>,</span> <span class='hs-varid'>j</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>1</span><span class='hs-keyglyph'>..</span><span class='hs-varid'>n</span><span class='hs-keyglyph'>]</span>
<a name="line-999"></a>                   <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>en</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span><span class='hs-varid'>j</span><span class='hs-layout'>)</span>
<a name="line-1000"></a>                   <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>i'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>i</span> <span class='hs-comment'>-</span> <span class='hs-varid'>n</span>
<a name="line-1001"></a>                     <span class='hs-keyglyph'>]</span>
<a name="line-1002"></a>         <span class='hs-comment'>-- c22 = p1 - p2 + p3 + p6</span>
<a name="line-1003"></a>         <span class='hs-varid'>sequence_</span> <span class='hs-keyglyph'>[</span> <span class='hs-conid'>MV</span><span class='hs-varop'>.</span><span class='hs-varid'>write</span> <span class='hs-varid'>v</span> <span class='hs-varid'>k</span> <span class='hs-varop'>$</span>
<a name="line-1004"></a>                         <span class='hs-varid'>unsafeGet</span> <span class='hs-varid'>i'</span> <span class='hs-varid'>j'</span> <span class='hs-varid'>p1</span>
<a name="line-1005"></a>                       <span class='hs-comment'>-</span> <span class='hs-varid'>unsafeGet</span> <span class='hs-varid'>i'</span> <span class='hs-varid'>j'</span> <span class='hs-varid'>p2</span>
<a name="line-1006"></a>                       <span class='hs-varop'>+</span> <span class='hs-varid'>unsafeGet</span> <span class='hs-varid'>i'</span> <span class='hs-varid'>j'</span> <span class='hs-varid'>p3</span>
<a name="line-1007"></a>                       <span class='hs-varop'>+</span> <span class='hs-varid'>unsafeGet</span> <span class='hs-varid'>i'</span> <span class='hs-varid'>j'</span> <span class='hs-varid'>p6</span>
<a name="line-1008"></a>                   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>n'</span><span class='hs-keyglyph'>..</span><span class='hs-varid'>r</span><span class='hs-keyglyph'>]</span>
<a name="line-1009"></a>                   <span class='hs-layout'>,</span> <span class='hs-varid'>j</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>n'</span><span class='hs-keyglyph'>..</span><span class='hs-varid'>r</span><span class='hs-keyglyph'>]</span>
<a name="line-1010"></a>                   <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>en</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span><span class='hs-varid'>j</span><span class='hs-layout'>)</span>
<a name="line-1011"></a>                   <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>i'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>i</span> <span class='hs-comment'>-</span> <span class='hs-varid'>n</span>
<a name="line-1012"></a>                   <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>j'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>j</span> <span class='hs-comment'>-</span> <span class='hs-varid'>n</span>
<a name="line-1013"></a>                     <span class='hs-keyglyph'>]</span>
<a name="line-1014"></a>         <span class='hs-varid'>return</span> <span class='hs-varid'>v</span>
<a name="line-1015"></a> <span class='hs-keyword'>where</span>
<a name="line-1016"></a>  <span class='hs-varid'>r</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nrows</span> <span class='hs-varid'>a</span>
<a name="line-1017"></a>  <span class='hs-comment'>-- Size of the subproblem is halved.</span>
<a name="line-1018"></a>  <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>quot</span> <span class='hs-varid'>r</span> <span class='hs-num'>2</span>
<a name="line-1019"></a>  <span class='hs-comment'>-- Split of the original problem into smaller subproblems.</span>
<a name="line-1020"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>a11</span><span class='hs-layout'>,</span><span class='hs-varid'>a12</span><span class='hs-layout'>,</span><span class='hs-varid'>a21</span><span class='hs-layout'>,</span><span class='hs-varid'>a22</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitBlocks</span> <span class='hs-varid'>n</span> <span class='hs-varid'>n</span> <span class='hs-varid'>a</span>
<a name="line-1021"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>b11</span><span class='hs-layout'>,</span><span class='hs-varid'>b12</span><span class='hs-layout'>,</span><span class='hs-varid'>b21</span><span class='hs-layout'>,</span><span class='hs-varid'>b22</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitBlocks</span> <span class='hs-varid'>n</span> <span class='hs-varid'>n</span> <span class='hs-varid'>b</span>
<a name="line-1022"></a>  <span class='hs-comment'>-- The seven Strassen's products.</span>
<a name="line-1023"></a>  <span class='hs-varid'>p1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>strassenMixed</span> <span class='hs-layout'>(</span><span class='hs-varid'>a11</span> <span class='hs-varop'>+.</span> <span class='hs-varid'>a22</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>b11</span> <span class='hs-varop'>+.</span> <span class='hs-varid'>b22</span><span class='hs-layout'>)</span>
<a name="line-1024"></a>  <span class='hs-varid'>p2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>strassenMixed</span> <span class='hs-layout'>(</span><span class='hs-varid'>a21</span> <span class='hs-varop'>+.</span> <span class='hs-varid'>a22</span><span class='hs-layout'>)</span>  <span class='hs-varid'>b11</span>
<a name="line-1025"></a>  <span class='hs-varid'>p3</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>strassenMixed</span>  <span class='hs-varid'>a11</span>         <span class='hs-layout'>(</span><span class='hs-varid'>b12</span> <span class='hs-varop'>-.</span> <span class='hs-varid'>b22</span><span class='hs-layout'>)</span>
<a name="line-1026"></a>  <span class='hs-varid'>p4</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>strassenMixed</span>         <span class='hs-varid'>a22</span>  <span class='hs-layout'>(</span><span class='hs-varid'>b21</span> <span class='hs-varop'>-.</span> <span class='hs-varid'>b11</span><span class='hs-layout'>)</span>
<a name="line-1027"></a>  <span class='hs-varid'>p5</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>strassenMixed</span> <span class='hs-layout'>(</span><span class='hs-varid'>a11</span> <span class='hs-varop'>+.</span> <span class='hs-varid'>a12</span><span class='hs-layout'>)</span>         <span class='hs-varid'>b22</span>
<a name="line-1028"></a>  <span class='hs-varid'>p6</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>strassenMixed</span> <span class='hs-layout'>(</span><span class='hs-varid'>a21</span> <span class='hs-varop'>-.</span> <span class='hs-varid'>a11</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>b11</span> <span class='hs-varop'>+.</span> <span class='hs-varid'>b12</span><span class='hs-layout'>)</span>
<a name="line-1029"></a>  <span class='hs-varid'>p7</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>strassenMixed</span> <span class='hs-layout'>(</span><span class='hs-varid'>a12</span> <span class='hs-varop'>-.</span> <span class='hs-varid'>a22</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>b21</span> <span class='hs-varop'>+.</span> <span class='hs-varid'>b22</span><span class='hs-layout'>)</span>
<a name="line-1030"></a>
<a name="line-1031"></a><a name="multStrassenMixed"></a><span class='hs-comment'>-- | Mixed Strassen's matrix multiplication.</span>
<a name="line-1032"></a><span class='hs-definition'>multStrassenMixed</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Num</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span>
<a name="line-1033"></a><span class='hs-comment'>{-# INLINE multStrassenMixed #-}</span>
<a name="line-1034"></a><span class='hs-definition'>multStrassenMixed</span> <span class='hs-varid'>a1</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>M</span> <span class='hs-varid'>n</span> <span class='hs-varid'>m</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>a2</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>M</span> <span class='hs-varid'>n'</span> <span class='hs-varid'>m'</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-1035"></a>   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>m</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>n'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>error</span> <span class='hs-varop'>$</span> <span class='hs-str'>"Multiplication of "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>sizeStr</span> <span class='hs-varid'>n</span> <span class='hs-varid'>m</span> <span class='hs-varop'>++</span> <span class='hs-str'>" and "</span>
<a name="line-1036"></a>                    <span class='hs-varop'>++</span> <span class='hs-varid'>sizeStr</span> <span class='hs-varid'>n'</span> <span class='hs-varid'>m'</span> <span class='hs-varop'>++</span> <span class='hs-str'>" matrices."</span>
<a name="line-1037"></a>   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n</span> <span class='hs-varop'>&lt;</span> <span class='hs-varid'>strmixFactor</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>multStd__</span> <span class='hs-varid'>a1</span> <span class='hs-varid'>a2</span>
<a name="line-1038"></a>   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span>
<a name="line-1039"></a>       <span class='hs-keyword'>let</span> <span class='hs-varid'>mx</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maximum</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span><span class='hs-varid'>m</span><span class='hs-layout'>,</span><span class='hs-varid'>n'</span><span class='hs-layout'>,</span><span class='hs-varid'>m'</span><span class='hs-keyglyph'>]</span>
<a name="line-1040"></a>           <span class='hs-varid'>n2</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>even</span> <span class='hs-varid'>mx</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>mx</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>mx</span><span class='hs-varop'>+</span><span class='hs-num'>1</span>
<a name="line-1041"></a>           <span class='hs-varid'>b1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSize</span> <span class='hs-num'>0</span> <span class='hs-varid'>n2</span> <span class='hs-varid'>n2</span> <span class='hs-varid'>a1</span>
<a name="line-1042"></a>           <span class='hs-varid'>b2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSize</span> <span class='hs-num'>0</span> <span class='hs-varid'>n2</span> <span class='hs-varid'>n2</span> <span class='hs-varid'>a2</span>
<a name="line-1043"></a>       <span class='hs-keyword'>in</span>  <span class='hs-varid'>submatrix</span> <span class='hs-num'>1</span> <span class='hs-varid'>n</span> <span class='hs-num'>1</span> <span class='hs-varid'>m'</span> <span class='hs-varop'>$</span> <span class='hs-varid'>strassenMixed</span> <span class='hs-varid'>b1</span> <span class='hs-varid'>b2</span>
<a name="line-1044"></a>
<a name="line-1045"></a><span class='hs-comment'>-------------------------------------------------------</span>
<a name="line-1046"></a><span class='hs-comment'>-------------------------------------------------------</span>
<a name="line-1047"></a><span class='hs-comment'>---- NUMERICAL INSTANCE</span>
<a name="line-1048"></a>
<a name="line-1049"></a><a name="instance%20Num%20(Matrix%20a)"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Num</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Num</span> <span class='hs-layout'>(</span><span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-1050"></a> <span class='hs-varid'>fromInteger</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>M</span> <span class='hs-num'>1</span> <span class='hs-num'>1</span> <span class='hs-num'>0</span> <span class='hs-num'>0</span> <span class='hs-num'>1</span> <span class='hs-varop'>.</span> <span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>singleton</span> <span class='hs-varop'>.</span> <span class='hs-varid'>fromInteger</span>
<a name="line-1051"></a> <span class='hs-varid'>negate</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>negate</span>
<a name="line-1052"></a> <span class='hs-varid'>abs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>abs</span>
<a name="line-1053"></a> <span class='hs-varid'>signum</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>signum</span>
<a name="line-1054"></a>
<a name="line-1055"></a> <span class='hs-comment'>-- Addition of matrices.</span>
<a name="line-1056"></a> <span class='hs-comment'>{-# SPECIALIZE (+) :: Matrix Double -&gt; Matrix Double -&gt; Matrix Double #-}</span>
<a name="line-1057"></a> <span class='hs-comment'>{-# SPECIALIZE (+) :: Matrix Int -&gt; Matrix Int -&gt; Matrix Int #-}</span>
<a name="line-1058"></a> <span class='hs-comment'>{-# SPECIALIZE (+) :: Matrix Rational -&gt; Matrix Rational -&gt; Matrix Rational #-}</span>
<a name="line-1059"></a> <span class='hs-layout'>(</span><span class='hs-varop'>+</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>elementwise</span> <span class='hs-layout'>(</span><span class='hs-varop'>+</span><span class='hs-layout'>)</span>
<a name="line-1060"></a>
<a name="line-1061"></a> <span class='hs-comment'>-- Substraction of matrices.</span>
<a name="line-1062"></a> <span class='hs-comment'>{-# SPECIALIZE (-) :: Matrix Double -&gt; Matrix Double -&gt; Matrix Double #-}</span>
<a name="line-1063"></a> <span class='hs-comment'>{-# SPECIALIZE (-) :: Matrix Int -&gt; Matrix Int -&gt; Matrix Int #-}</span>
<a name="line-1064"></a> <span class='hs-comment'>{-# SPECIALIZE (-) :: Matrix Rational -&gt; Matrix Rational -&gt; Matrix Rational #-}</span>
<a name="line-1065"></a> <span class='hs-layout'>(</span><span class='hs-comment'>-</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>elementwise</span> <span class='hs-layout'>(</span><span class='hs-comment'>-</span><span class='hs-layout'>)</span>
<a name="line-1066"></a>
<a name="line-1067"></a> <span class='hs-comment'>-- Multiplication of matrices.</span>
<a name="line-1068"></a> <span class='hs-comment'>{-# INLINE (*) #-}</span>
<a name="line-1069"></a> <span class='hs-layout'>(</span><span class='hs-varop'>*</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>multStrassenMixed</span>
<a name="line-1070"></a>
<a name="line-1071"></a><span class='hs-comment'>-------------------------------------------------------</span>
<a name="line-1072"></a><span class='hs-comment'>-------------------------------------------------------</span>
<a name="line-1073"></a><span class='hs-comment'>---- TRANSFORMATIONS</span>
<a name="line-1074"></a>
<a name="line-1075"></a><a name="scaleMatrix"></a><span class='hs-comment'>-- | Scale a matrix by a given factor.</span>
<a name="line-1076"></a><span class='hs-comment'>--   Example:</span>
<a name="line-1077"></a><span class='hs-comment'>--</span>
<a name="line-1078"></a><span class='hs-comment'>-- &gt;               ( 1 2 3 )   (  2  4  6 )</span>
<a name="line-1079"></a><span class='hs-comment'>-- &gt;               ( 4 5 6 )   (  8 10 12 )</span>
<a name="line-1080"></a><span class='hs-comment'>-- &gt; scaleMatrix 2 ( 7 8 9 ) = ( 14 16 18 )</span>
<a name="line-1081"></a><span class='hs-definition'>scaleMatrix</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Num</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span>
<a name="line-1082"></a><span class='hs-definition'>scaleMatrix</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-varop'>*</span><span class='hs-layout'>)</span>
<a name="line-1083"></a>
<a name="line-1084"></a><a name="scaleRow"></a><span class='hs-comment'>-- | Scale a row by a given factor.</span>
<a name="line-1085"></a><span class='hs-comment'>--   Example:</span>
<a name="line-1086"></a><span class='hs-comment'>--</span>
<a name="line-1087"></a><span class='hs-comment'>-- &gt;              ( 1 2 3 )   (  1  2  3 )</span>
<a name="line-1088"></a><span class='hs-comment'>-- &gt;              ( 4 5 6 )   (  8 10 12 )</span>
<a name="line-1089"></a><span class='hs-comment'>-- &gt; scaleRow 2 2 ( 7 8 9 ) = (  7  8  9 )</span>
<a name="line-1090"></a><span class='hs-definition'>scaleRow</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Num</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span>
<a name="line-1091"></a><span class='hs-definition'>scaleRow</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapRow</span> <span class='hs-varop'>.</span> <span class='hs-varid'>const</span> <span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-varop'>*</span><span class='hs-layout'>)</span>
<a name="line-1092"></a>
<a name="line-1093"></a><a name="combineRows"></a><span class='hs-comment'>-- | Add to one row a scalar multiple of another row.</span>
<a name="line-1094"></a><span class='hs-comment'>--   Example:</span>
<a name="line-1095"></a><span class='hs-comment'>--</span>
<a name="line-1096"></a><span class='hs-comment'>-- &gt;                   ( 1 2 3 )   (  1  2  3 )</span>
<a name="line-1097"></a><span class='hs-comment'>-- &gt;                   ( 4 5 6 )   (  6  9 12 )</span>
<a name="line-1098"></a><span class='hs-comment'>-- &gt; combineRows 2 2 1 ( 7 8 9 ) = (  7  8  9 )</span>
<a name="line-1099"></a><span class='hs-definition'>combineRows</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Num</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span>
<a name="line-1100"></a><span class='hs-definition'>combineRows</span> <span class='hs-varid'>r1</span> <span class='hs-varid'>l</span> <span class='hs-varid'>r2</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapRow</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>j</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>x</span> <span class='hs-varop'>+</span> <span class='hs-varid'>l</span> <span class='hs-varop'>*</span> <span class='hs-varid'>getElem</span> <span class='hs-varid'>r2</span> <span class='hs-varid'>j</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-varid'>r1</span> <span class='hs-varid'>m</span>
<a name="line-1101"></a>
<a name="line-1102"></a><a name="switchRows"></a><span class='hs-comment'>-- | Switch two rows of a matrix.</span>
<a name="line-1103"></a><span class='hs-comment'>--   Example:</span>
<a name="line-1104"></a><span class='hs-comment'>--</span>
<a name="line-1105"></a><span class='hs-comment'>-- &gt;                ( 1 2 3 )   ( 4 5 6 )</span>
<a name="line-1106"></a><span class='hs-comment'>-- &gt;                ( 4 5 6 )   ( 1 2 3 )</span>
<a name="line-1107"></a><span class='hs-comment'>-- &gt; switchRows 1 2 ( 7 8 9 ) = ( 7 8 9 )</span>
<a name="line-1108"></a><span class='hs-definition'>switchRows</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-comment'>-- ^ Row 1.</span>
<a name="line-1109"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-comment'>-- ^ Row 2.</span>
<a name="line-1110"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-comment'>-- ^ Original matrix.</span>
<a name="line-1111"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-comment'>-- ^ Matrix with rows 1 and 2 switched.</span>
<a name="line-1112"></a><span class='hs-definition'>switchRows</span> <span class='hs-varid'>r1</span> <span class='hs-varid'>r2</span> <span class='hs-layout'>(</span><span class='hs-conid'>M</span> <span class='hs-varid'>n</span> <span class='hs-varid'>m</span> <span class='hs-varid'>ro</span> <span class='hs-varid'>co</span> <span class='hs-varid'>w</span> <span class='hs-varid'>vs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>M</span> <span class='hs-varid'>n</span> <span class='hs-varid'>m</span> <span class='hs-varid'>ro</span> <span class='hs-varid'>co</span> <span class='hs-varid'>w</span> <span class='hs-varop'>$</span> <span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>modify</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>mv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1113"></a>  <span class='hs-varid'>numLoop</span> <span class='hs-num'>1</span> <span class='hs-varid'>m</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>j</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1114"></a>    <span class='hs-conid'>MV</span><span class='hs-varop'>.</span><span class='hs-varid'>swap</span> <span class='hs-varid'>mv</span> <span class='hs-layout'>(</span><span class='hs-varid'>encode</span> <span class='hs-varid'>w</span> <span class='hs-layout'>(</span><span class='hs-varid'>r1</span><span class='hs-varop'>+</span><span class='hs-varid'>ro</span><span class='hs-layout'>,</span><span class='hs-varid'>j</span><span class='hs-varop'>+</span><span class='hs-varid'>co</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>encode</span> <span class='hs-varid'>w</span> <span class='hs-layout'>(</span><span class='hs-varid'>r2</span><span class='hs-varop'>+</span><span class='hs-varid'>ro</span><span class='hs-layout'>,</span><span class='hs-varid'>j</span><span class='hs-varop'>+</span><span class='hs-varid'>co</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>vs</span>
<a name="line-1115"></a>
<a name="line-1116"></a><a name="switchCols"></a><span class='hs-comment'>-- | Switch two coumns of a matrix.</span>
<a name="line-1117"></a><span class='hs-comment'>--   Example:</span>
<a name="line-1118"></a><span class='hs-comment'>--</span>
<a name="line-1119"></a><span class='hs-comment'>-- &gt;                ( 1 2 3 )   ( 2 1 3 )</span>
<a name="line-1120"></a><span class='hs-comment'>-- &gt;                ( 4 5 6 )   ( 5 4 6 )</span>
<a name="line-1121"></a><span class='hs-comment'>-- &gt; switchCols 1 2 ( 7 8 9 ) = ( 8 7 9 )</span>
<a name="line-1122"></a><span class='hs-definition'>switchCols</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-comment'>-- ^ Col 1.</span>
<a name="line-1123"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-comment'>-- ^ Col 2.</span>
<a name="line-1124"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-comment'>-- ^ Original matrix.</span>
<a name="line-1125"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-comment'>-- ^ Matrix with cols 1 and 2 switched.</span>
<a name="line-1126"></a><span class='hs-definition'>switchCols</span> <span class='hs-varid'>c1</span> <span class='hs-varid'>c2</span> <span class='hs-layout'>(</span><span class='hs-conid'>M</span> <span class='hs-varid'>n</span> <span class='hs-varid'>m</span> <span class='hs-varid'>ro</span> <span class='hs-varid'>co</span> <span class='hs-varid'>w</span> <span class='hs-varid'>vs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>M</span> <span class='hs-varid'>n</span> <span class='hs-varid'>m</span> <span class='hs-varid'>ro</span> <span class='hs-varid'>co</span> <span class='hs-varid'>w</span> <span class='hs-varop'>$</span> <span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>modify</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>mv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1127"></a>  <span class='hs-varid'>numLoop</span> <span class='hs-num'>1</span> <span class='hs-varid'>n</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>j</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1128"></a>    <span class='hs-conid'>MV</span><span class='hs-varop'>.</span><span class='hs-varid'>swap</span> <span class='hs-varid'>mv</span> <span class='hs-layout'>(</span><span class='hs-varid'>encode</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-varid'>j</span><span class='hs-varop'>+</span><span class='hs-varid'>ro</span><span class='hs-layout'>,</span><span class='hs-varid'>c1</span><span class='hs-varop'>+</span><span class='hs-varid'>co</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>encode</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-varid'>j</span><span class='hs-varop'>+</span><span class='hs-varid'>ro</span><span class='hs-layout'>,</span><span class='hs-varid'>c2</span><span class='hs-varop'>+</span><span class='hs-varid'>co</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>vs</span>
<a name="line-1129"></a>
<a name="line-1130"></a><span class='hs-comment'>-------------------------------------------------------</span>
<a name="line-1131"></a><span class='hs-comment'>-------------------------------------------------------</span>
<a name="line-1132"></a><span class='hs-comment'>---- DECOMPOSITIONS</span>
<a name="line-1133"></a>
<a name="line-1134"></a><span class='hs-comment'>-- LU DECOMPOSITION</span>
<a name="line-1135"></a>
<a name="line-1136"></a><a name="luDecomp"></a><span class='hs-comment'>-- | Matrix LU decomposition with /partial pivoting/.</span>
<a name="line-1137"></a><span class='hs-comment'>--   The result for a matrix /M/ is given in the format /(U,L,P,d)/ where:</span>
<a name="line-1138"></a><span class='hs-comment'>--</span>
<a name="line-1139"></a><span class='hs-comment'>--   * /U/ is an upper triangular matrix.</span>
<a name="line-1140"></a><span class='hs-comment'>--</span>
<a name="line-1141"></a><span class='hs-comment'>--   * /L/ is an /unit/ lower triangular matrix.</span>
<a name="line-1142"></a><span class='hs-comment'>--</span>
<a name="line-1143"></a><span class='hs-comment'>--   * /P/ is a permutation matrix.</span>
<a name="line-1144"></a><span class='hs-comment'>--</span>
<a name="line-1145"></a><span class='hs-comment'>--   * /d/ is the determinant of /P/.</span>
<a name="line-1146"></a><span class='hs-comment'>--</span>
<a name="line-1147"></a><span class='hs-comment'>--   * /PM = LU/.</span>
<a name="line-1148"></a><span class='hs-comment'>--</span>
<a name="line-1149"></a><span class='hs-comment'>--   These properties are only guaranteed when the input matrix is invertible.</span>
<a name="line-1150"></a><span class='hs-comment'>--   An additional property matches thanks to the strategy followed for pivoting:</span>
<a name="line-1151"></a><span class='hs-comment'>--</span>
<a name="line-1152"></a><span class='hs-comment'>--   * /L_(i,j)/ &lt;= 1, for all /i,j/.</span>
<a name="line-1153"></a><span class='hs-comment'>--</span>
<a name="line-1154"></a><span class='hs-comment'>--   This follows from the maximal property of the selected pivots, which also</span>
<a name="line-1155"></a><span class='hs-comment'>--   leads to a better numerical stability of the algorithm.</span>
<a name="line-1156"></a><span class='hs-comment'>--</span>
<a name="line-1157"></a><span class='hs-comment'>--   Example:</span>
<a name="line-1158"></a><span class='hs-comment'>--</span>
<a name="line-1159"></a><span class='hs-comment'>-- &gt;          ( 1 2 0 )     ( 2 0  2 )   (   1 0 0 )   ( 0 0 1 )</span>
<a name="line-1160"></a><span class='hs-comment'>-- &gt;          ( 0 2 1 )     ( 0 2 -1 )   ( 1/2 1 0 )   ( 1 0 0 )</span>
<a name="line-1161"></a><span class='hs-comment'>-- &gt; luDecomp ( 2 0 2 ) = ( ( 0 0  2 ) , (   0 1 1 ) , ( 0 1 0 ) , 1 )</span>
<a name="line-1162"></a><span class='hs-comment'>--</span>
<a name="line-1163"></a><span class='hs-comment'>--   'Nothing' is returned if no LU decomposition exists.</span>
<a name="line-1164"></a><span class='hs-definition'>luDecomp</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ord</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Fractional</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span><span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span><span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span><span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-1165"></a><span class='hs-definition'>luDecomp</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>recLUDecomp</span> <span class='hs-varid'>a</span> <span class='hs-varid'>i</span> <span class='hs-varid'>i</span> <span class='hs-num'>1</span> <span class='hs-num'>1</span> <span class='hs-varid'>n</span>
<a name="line-1166"></a> <span class='hs-keyword'>where</span>
<a name="line-1167"></a>  <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>identity</span> <span class='hs-varop'>$</span> <span class='hs-varid'>nrows</span> <span class='hs-varid'>a</span>
<a name="line-1168"></a>  <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>min</span> <span class='hs-layout'>(</span><span class='hs-varid'>nrows</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ncols</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-1169"></a>
<a name="line-1170"></a><a name="recLUDecomp"></a><span class='hs-definition'>recLUDecomp</span> <span class='hs-keyglyph'>::</span>  <span class='hs-layout'>(</span><span class='hs-conid'>Ord</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Fractional</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-1171"></a>            <span class='hs-keyglyph'>=&gt;</span>  <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-comment'>-- ^ U</span>
<a name="line-1172"></a>            <span class='hs-keyglyph'>-&gt;</span>  <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-comment'>-- ^ L</span>
<a name="line-1173"></a>            <span class='hs-keyglyph'>-&gt;</span>  <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-comment'>-- ^ P</span>
<a name="line-1174"></a>            <span class='hs-keyglyph'>-&gt;</span>  <span class='hs-varid'>a</span>        <span class='hs-comment'>-- ^ d</span>
<a name="line-1175"></a>            <span class='hs-keyglyph'>-&gt;</span>  <span class='hs-conid'>Int</span>      <span class='hs-comment'>-- ^ Current row</span>
<a name="line-1176"></a>            <span class='hs-keyglyph'>-&gt;</span>  <span class='hs-conid'>Int</span>      <span class='hs-comment'>-- ^ Total rows</span>
<a name="line-1177"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span><span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span><span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span><span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-1178"></a><span class='hs-definition'>recLUDecomp</span> <span class='hs-varid'>u</span> <span class='hs-varid'>l</span> <span class='hs-varid'>p</span> <span class='hs-varid'>d</span> <span class='hs-varid'>k</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span>
<a name="line-1179"></a>    <span class='hs-keyword'>if</span> <span class='hs-varid'>k</span> <span class='hs-varop'>&gt;</span> <span class='hs-varid'>n</span> <span class='hs-keyword'>then</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>u</span><span class='hs-layout'>,</span><span class='hs-varid'>l</span><span class='hs-layout'>,</span><span class='hs-varid'>p</span><span class='hs-layout'>,</span><span class='hs-varid'>d</span><span class='hs-layout'>)</span>
<a name="line-1180"></a>    <span class='hs-keyword'>else</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>ukk</span> <span class='hs-varop'>==</span> <span class='hs-num'>0</span> <span class='hs-keyword'>then</span> <span class='hs-conid'>Nothing</span>
<a name="line-1181"></a>                     <span class='hs-keyword'>else</span> <span class='hs-varid'>recLUDecomp</span> <span class='hs-varid'>u''</span> <span class='hs-varid'>l''</span> <span class='hs-varid'>p'</span> <span class='hs-varid'>d'</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>n</span>
<a name="line-1182"></a> <span class='hs-keyword'>where</span>
<a name="line-1183"></a>  <span class='hs-comment'>-- Pivot strategy: maximum value in absolute value below the current row.</span>
<a name="line-1184"></a>  <span class='hs-varid'>i</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maximumBy</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>x</span> <span class='hs-varid'>y</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>compare</span> <span class='hs-layout'>(</span><span class='hs-varid'>abs</span> <span class='hs-varop'>$</span> <span class='hs-varid'>u</span> <span class='hs-varop'>!</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-layout'>,</span><span class='hs-varid'>k</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>abs</span> <span class='hs-varop'>$</span> <span class='hs-varid'>u</span> <span class='hs-varop'>!</span> <span class='hs-layout'>(</span><span class='hs-varid'>y</span><span class='hs-layout'>,</span><span class='hs-varid'>k</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>..</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>]</span>
<a name="line-1185"></a>  <span class='hs-comment'>-- Switching to place pivot in current row.</span>
<a name="line-1186"></a>  <span class='hs-varid'>u'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>switchRows</span> <span class='hs-varid'>k</span> <span class='hs-varid'>i</span> <span class='hs-varid'>u</span>
<a name="line-1187"></a>  <span class='hs-varid'>l'</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>lw</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcols</span> <span class='hs-varid'>l</span>
<a name="line-1188"></a>           <span class='hs-varid'>en</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>encode</span> <span class='hs-varid'>lw</span>
<a name="line-1189"></a>           <span class='hs-varid'>lro</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rowOffset</span> <span class='hs-varid'>l</span>
<a name="line-1190"></a>           <span class='hs-varid'>lco</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>colOffset</span> <span class='hs-varid'>l</span>
<a name="line-1191"></a>       <span class='hs-keyword'>in</span>  <span class='hs-keyword'>if</span> <span class='hs-varid'>i</span> <span class='hs-varop'>==</span> <span class='hs-varid'>k</span>
<a name="line-1192"></a>              <span class='hs-keyword'>then</span> <span class='hs-varid'>l</span>
<a name="line-1193"></a>              <span class='hs-keyword'>else</span> <span class='hs-conid'>M</span> <span class='hs-layout'>(</span><span class='hs-varid'>nrows</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ncols</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span> <span class='hs-varid'>lro</span> <span class='hs-varid'>lco</span> <span class='hs-varid'>lw</span> <span class='hs-varop'>$</span>
<a name="line-1194"></a>                     <span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>modify</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>mv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>forM_</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>1</span> <span class='hs-keyglyph'>..</span> <span class='hs-varid'>k</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-keyglyph'>]</span> <span class='hs-varop'>$</span> 
<a name="line-1195"></a>                                 <span class='hs-keyglyph'>\</span><span class='hs-varid'>j</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MV</span><span class='hs-varop'>.</span><span class='hs-varid'>swap</span> <span class='hs-varid'>mv</span> <span class='hs-layout'>(</span><span class='hs-varid'>en</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-varop'>+</span><span class='hs-varid'>lro</span><span class='hs-layout'>,</span><span class='hs-varid'>j</span><span class='hs-varop'>+</span><span class='hs-varid'>lco</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1196"></a>                                                  <span class='hs-layout'>(</span><span class='hs-varid'>en</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span><span class='hs-varop'>+</span><span class='hs-varid'>lro</span><span class='hs-layout'>,</span><span class='hs-varid'>j</span><span class='hs-varop'>+</span><span class='hs-varid'>lco</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1197"></a>                                <span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mvect</span> <span class='hs-varid'>l</span>
<a name="line-1198"></a>  <span class='hs-varid'>p'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>switchRows</span> <span class='hs-varid'>k</span> <span class='hs-varid'>i</span> <span class='hs-varid'>p</span>
<a name="line-1199"></a>  <span class='hs-comment'>-- Permutation determinant</span>
<a name="line-1200"></a>  <span class='hs-varid'>d'</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>i</span> <span class='hs-varop'>==</span> <span class='hs-varid'>k</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>d</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>negate</span> <span class='hs-varid'>d</span>
<a name="line-1201"></a>  <span class='hs-comment'>-- Cancel elements below the pivot.</span>
<a name="line-1202"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>u''</span><span class='hs-layout'>,</span><span class='hs-varid'>l''</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>u'</span> <span class='hs-varid'>l'</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-1203"></a>  <span class='hs-varid'>ukk</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>u'</span> <span class='hs-varop'>!</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span><span class='hs-layout'>,</span><span class='hs-varid'>k</span><span class='hs-layout'>)</span>
<a name="line-1204"></a>  <span class='hs-varid'>go</span> <span class='hs-varid'>u_</span> <span class='hs-varid'>l_</span> <span class='hs-varid'>j</span> <span class='hs-keyglyph'>=</span>
<a name="line-1205"></a>    <span class='hs-keyword'>if</span> <span class='hs-varid'>j</span> <span class='hs-varop'>&gt;</span> <span class='hs-varid'>nrows</span> <span class='hs-varid'>u_</span>
<a name="line-1206"></a>    <span class='hs-keyword'>then</span> <span class='hs-layout'>(</span><span class='hs-varid'>u_</span><span class='hs-layout'>,</span><span class='hs-varid'>l_</span><span class='hs-layout'>)</span>
<a name="line-1207"></a>    <span class='hs-keyword'>else</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>u_</span> <span class='hs-varop'>!</span> <span class='hs-layout'>(</span><span class='hs-varid'>j</span><span class='hs-layout'>,</span><span class='hs-varid'>k</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>/</span> <span class='hs-varid'>ukk</span>
<a name="line-1208"></a>         <span class='hs-keyword'>in</span>  <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>combineRows</span> <span class='hs-varid'>j</span> <span class='hs-layout'>(</span><span class='hs-comment'>-</span><span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-varid'>k</span> <span class='hs-varid'>u_</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>setElem</span> <span class='hs-varid'>x</span> <span class='hs-layout'>(</span><span class='hs-varid'>j</span><span class='hs-layout'>,</span><span class='hs-varid'>k</span><span class='hs-layout'>)</span> <span class='hs-varid'>l_</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>j</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-1209"></a>
<a name="line-1210"></a><a name="luDecompUnsafe"></a><span class='hs-comment'>-- | Unsafe version of 'luDecomp'. It fails when the input matrix is singular.</span>
<a name="line-1211"></a><span class='hs-definition'>luDecompUnsafe</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ord</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Fractional</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-1212"></a><span class='hs-definition'>luDecompUnsafe</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>luDecomp</span> <span class='hs-varid'>m</span> <span class='hs-keyword'>of</span>
<a name="line-1213"></a>  <span class='hs-conid'>Just</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>x</span>
<a name="line-1214"></a>  <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>error</span> <span class='hs-str'>"luDecompUnsafe of singular matrix."</span>
<a name="line-1215"></a>
<a name="line-1216"></a><a name="luDecomp'"></a><span class='hs-comment'>-- | Matrix LU decomposition with /complete pivoting/.</span>
<a name="line-1217"></a><span class='hs-comment'>--   The result for a matrix /M/ is given in the format /(U,L,P,Q,d,e)/ where:</span>
<a name="line-1218"></a><span class='hs-comment'>--</span>
<a name="line-1219"></a><span class='hs-comment'>--   * /U/ is an upper triangular matrix.</span>
<a name="line-1220"></a><span class='hs-comment'>--</span>
<a name="line-1221"></a><span class='hs-comment'>--   * /L/ is an /unit/ lower triangular matrix.</span>
<a name="line-1222"></a><span class='hs-comment'>--</span>
<a name="line-1223"></a><span class='hs-comment'>--   * /P,Q/ are permutation matrices.</span>
<a name="line-1224"></a><span class='hs-comment'>--</span>
<a name="line-1225"></a><span class='hs-comment'>--   * /d,e/ are the determinants of /P/ and /Q/ respectively.</span>
<a name="line-1226"></a><span class='hs-comment'>--</span>
<a name="line-1227"></a><span class='hs-comment'>--   * /PMQ = LU/.</span>
<a name="line-1228"></a><span class='hs-comment'>--</span>
<a name="line-1229"></a><span class='hs-comment'>--   These properties are only guaranteed when the input matrix is invertible.</span>
<a name="line-1230"></a><span class='hs-comment'>--   An additional property matches thanks to the strategy followed for pivoting:</span>
<a name="line-1231"></a><span class='hs-comment'>--</span>
<a name="line-1232"></a><span class='hs-comment'>--   * /L_(i,j)/ &lt;= 1, for all /i,j/.</span>
<a name="line-1233"></a><span class='hs-comment'>--</span>
<a name="line-1234"></a><span class='hs-comment'>--   This follows from the maximal property of the selected pivots, which also</span>
<a name="line-1235"></a><span class='hs-comment'>--   leads to a better numerical stability of the algorithm.</span>
<a name="line-1236"></a><span class='hs-comment'>--</span>
<a name="line-1237"></a><span class='hs-comment'>--   Example:</span>
<a name="line-1238"></a><span class='hs-comment'>--</span>
<a name="line-1239"></a><span class='hs-comment'>-- &gt;           ( 1 0 )     ( 2 1 )   (   1    0 0 )   ( 0 0 1 )</span>
<a name="line-1240"></a><span class='hs-comment'>-- &gt;           ( 0 2 )     ( 0 2 )   (   0    1 0 )   ( 0 1 0 )   ( 1 0 )</span>
<a name="line-1241"></a><span class='hs-comment'>-- &gt; luDecomp' ( 2 1 ) = ( ( 0 0 ) , ( 1/2 -1/4 1 ) , ( 1 0 0 ) , ( 0 1 ) , -1 , 1 )</span>
<a name="line-1242"></a><span class='hs-comment'>--</span>
<a name="line-1243"></a><span class='hs-comment'>--   'Nothing' is returned if no LU decomposition exists.</span>
<a name="line-1244"></a><span class='hs-definition'>luDecomp'</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ord</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Fractional</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span><span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span><span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span><span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span><span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-1245"></a><span class='hs-definition'>luDecomp'</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>recLUDecomp'</span> <span class='hs-varid'>a</span> <span class='hs-varid'>i</span> <span class='hs-varid'>i</span> <span class='hs-layout'>(</span><span class='hs-varid'>identity</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ncols</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-num'>1</span> <span class='hs-num'>1</span> <span class='hs-num'>1</span> <span class='hs-varid'>n</span>
<a name="line-1246"></a> <span class='hs-keyword'>where</span>
<a name="line-1247"></a>  <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>identity</span> <span class='hs-varop'>$</span> <span class='hs-varid'>nrows</span> <span class='hs-varid'>a</span>
<a name="line-1248"></a>  <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>min</span> <span class='hs-layout'>(</span><span class='hs-varid'>nrows</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ncols</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-1249"></a>
<a name="line-1250"></a><a name="luDecompUnsafe'"></a><span class='hs-comment'>-- | Unsafe version of 'luDecomp''. It fails when the input matrix is singular.</span>
<a name="line-1251"></a><span class='hs-definition'>luDecompUnsafe'</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ord</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Fractional</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-1252"></a><span class='hs-definition'>luDecompUnsafe'</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>luDecomp'</span> <span class='hs-varid'>m</span> <span class='hs-keyword'>of</span>
<a name="line-1253"></a>  <span class='hs-conid'>Just</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>x</span>
<a name="line-1254"></a>  <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>error</span> <span class='hs-str'>"luDecompUnsafe' of singular matrix."</span>
<a name="line-1255"></a>
<a name="line-1256"></a><a name="recLUDecomp'"></a><span class='hs-definition'>recLUDecomp'</span> <span class='hs-keyglyph'>::</span>  <span class='hs-layout'>(</span><span class='hs-conid'>Ord</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Fractional</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-1257"></a>            <span class='hs-keyglyph'>=&gt;</span>  <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-comment'>-- ^ U</span>
<a name="line-1258"></a>            <span class='hs-keyglyph'>-&gt;</span>  <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-comment'>-- ^ L</span>
<a name="line-1259"></a>            <span class='hs-keyglyph'>-&gt;</span>  <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-comment'>-- ^ P</span>
<a name="line-1260"></a>            <span class='hs-keyglyph'>-&gt;</span>  <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-comment'>-- ^ Q</span>
<a name="line-1261"></a>            <span class='hs-keyglyph'>-&gt;</span>  <span class='hs-varid'>a</span>        <span class='hs-comment'>-- ^ d</span>
<a name="line-1262"></a>            <span class='hs-keyglyph'>-&gt;</span>  <span class='hs-varid'>a</span>        <span class='hs-comment'>-- ^ e</span>
<a name="line-1263"></a>            <span class='hs-keyglyph'>-&gt;</span>  <span class='hs-conid'>Int</span>      <span class='hs-comment'>-- ^ Current row</span>
<a name="line-1264"></a>            <span class='hs-keyglyph'>-&gt;</span>  <span class='hs-conid'>Int</span>      <span class='hs-comment'>-- ^ Total rows</span>
<a name="line-1265"></a>            <span class='hs-keyglyph'>-&gt;</span>  <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span><span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span><span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span><span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span><span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-1266"></a><span class='hs-definition'>recLUDecomp'</span> <span class='hs-varid'>u</span> <span class='hs-varid'>l</span> <span class='hs-varid'>p</span> <span class='hs-varid'>q</span> <span class='hs-varid'>d</span> <span class='hs-varid'>e</span> <span class='hs-varid'>k</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span>
<a name="line-1267"></a>    <span class='hs-keyword'>if</span> <span class='hs-varid'>k</span> <span class='hs-varop'>&gt;</span> <span class='hs-varid'>n</span> <span class='hs-varop'>||</span> <span class='hs-varid'>u''</span> <span class='hs-varop'>!</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span><span class='hs-layout'>,</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span> <span class='hs-varop'>==</span> <span class='hs-num'>0</span>
<a name="line-1268"></a>    <span class='hs-keyword'>then</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>u</span><span class='hs-layout'>,</span><span class='hs-varid'>l</span><span class='hs-layout'>,</span><span class='hs-varid'>p</span><span class='hs-layout'>,</span><span class='hs-varid'>q</span><span class='hs-layout'>,</span><span class='hs-varid'>d</span><span class='hs-layout'>,</span><span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-1269"></a>    <span class='hs-keyword'>else</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>ukk</span> <span class='hs-varop'>==</span> <span class='hs-num'>0</span>
<a name="line-1270"></a>            <span class='hs-keyword'>then</span> <span class='hs-conid'>Nothing</span>
<a name="line-1271"></a>            <span class='hs-keyword'>else</span> <span class='hs-varid'>recLUDecomp'</span> <span class='hs-varid'>u''</span> <span class='hs-varid'>l''</span> <span class='hs-varid'>p'</span> <span class='hs-varid'>q'</span> <span class='hs-varid'>d'</span> <span class='hs-varid'>e'</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>n</span>
<a name="line-1272"></a> <span class='hs-keyword'>where</span>
<a name="line-1273"></a>  <span class='hs-comment'>-- Pivot strategy: maximum value in absolute value below the current row &amp; col.</span>
<a name="line-1274"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span> <span class='hs-varid'>j</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maximumBy</span> <span class='hs-layout'>(</span><span class='hs-varid'>comparing</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>i0</span><span class='hs-layout'>,</span> <span class='hs-varid'>j0</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>abs</span> <span class='hs-varop'>$</span> <span class='hs-varid'>u</span> <span class='hs-varop'>!</span> <span class='hs-layout'>(</span><span class='hs-varid'>i0</span><span class='hs-layout'>,</span><span class='hs-varid'>j0</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1275"></a>           <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>i0</span><span class='hs-layout'>,</span> <span class='hs-varid'>j0</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>i0</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>k</span> <span class='hs-keyglyph'>..</span> <span class='hs-varid'>nrows</span> <span class='hs-varid'>u</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>j0</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>k</span> <span class='hs-keyglyph'>..</span> <span class='hs-varid'>ncols</span> <span class='hs-varid'>u</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>]</span>
<a name="line-1276"></a>  <span class='hs-comment'>-- Switching to place pivot in current row.</span>
<a name="line-1277"></a>  <span class='hs-varid'>u'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>switchCols</span> <span class='hs-varid'>k</span> <span class='hs-varid'>j</span> <span class='hs-varop'>$</span> <span class='hs-varid'>switchRows</span> <span class='hs-varid'>k</span> <span class='hs-varid'>i</span> <span class='hs-varid'>u</span>
<a name="line-1278"></a>  <span class='hs-varid'>l'0</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>switchRows</span> <span class='hs-varid'>k</span> <span class='hs-varid'>i</span> <span class='hs-varid'>l</span>
<a name="line-1279"></a>  <span class='hs-varid'>l'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>switchCols</span> <span class='hs-varid'>k</span> <span class='hs-varid'>i</span> <span class='hs-varid'>l'0</span>
<a name="line-1280"></a>  <span class='hs-varid'>p'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>switchRows</span> <span class='hs-varid'>k</span> <span class='hs-varid'>i</span> <span class='hs-varid'>p</span>
<a name="line-1281"></a>  <span class='hs-varid'>q'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>switchCols</span> <span class='hs-varid'>k</span> <span class='hs-varid'>j</span> <span class='hs-varid'>q</span>
<a name="line-1282"></a>  <span class='hs-comment'>-- Permutation determinant</span>
<a name="line-1283"></a>  <span class='hs-varid'>d'</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>i</span> <span class='hs-varop'>==</span> <span class='hs-varid'>k</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>d</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>negate</span> <span class='hs-varid'>d</span>
<a name="line-1284"></a>  <span class='hs-varid'>e'</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>j</span> <span class='hs-varop'>==</span> <span class='hs-varid'>k</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>e</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>negate</span> <span class='hs-varid'>e</span>
<a name="line-1285"></a>  <span class='hs-comment'>-- Cancel elements below the pivot.</span>
<a name="line-1286"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>u''</span><span class='hs-layout'>,</span><span class='hs-varid'>l''</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>u'</span> <span class='hs-varid'>l'</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-1287"></a>  <span class='hs-varid'>ukk</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>u'</span> <span class='hs-varop'>!</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span><span class='hs-layout'>,</span><span class='hs-varid'>k</span><span class='hs-layout'>)</span>
<a name="line-1288"></a>  <span class='hs-varid'>go</span> <span class='hs-varid'>u_</span> <span class='hs-varid'>l_</span> <span class='hs-varid'>h</span> <span class='hs-keyglyph'>=</span>
<a name="line-1289"></a>    <span class='hs-keyword'>if</span> <span class='hs-varid'>h</span> <span class='hs-varop'>&gt;</span> <span class='hs-varid'>nrows</span> <span class='hs-varid'>u_</span>
<a name="line-1290"></a>    <span class='hs-keyword'>then</span> <span class='hs-layout'>(</span><span class='hs-varid'>u_</span><span class='hs-layout'>,</span><span class='hs-varid'>l_</span><span class='hs-layout'>)</span>
<a name="line-1291"></a>    <span class='hs-keyword'>else</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>u_</span> <span class='hs-varop'>!</span> <span class='hs-layout'>(</span><span class='hs-varid'>h</span><span class='hs-layout'>,</span><span class='hs-varid'>k</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>/</span> <span class='hs-varid'>ukk</span>
<a name="line-1292"></a>         <span class='hs-keyword'>in</span>  <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>combineRows</span> <span class='hs-varid'>h</span> <span class='hs-layout'>(</span><span class='hs-comment'>-</span><span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-varid'>k</span> <span class='hs-varid'>u_</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>setElem</span> <span class='hs-varid'>x</span> <span class='hs-layout'>(</span><span class='hs-varid'>h</span><span class='hs-layout'>,</span><span class='hs-varid'>k</span><span class='hs-layout'>)</span> <span class='hs-varid'>l_</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>h</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-1293"></a>
<a name="line-1294"></a><span class='hs-comment'>-- CHOLESKY DECOMPOSITION</span>
<a name="line-1295"></a>
<a name="line-1296"></a><a name="cholDecomp"></a><span class='hs-comment'>-- | Simple Cholesky decomposition of a symmetric, positive definite matrix.</span>
<a name="line-1297"></a><span class='hs-comment'>--   The result for a matrix /M/ is a lower triangular matrix /L/ such that:</span>
<a name="line-1298"></a><span class='hs-comment'>--</span>
<a name="line-1299"></a><span class='hs-comment'>--   * /M = LL^T/.</span>
<a name="line-1300"></a><span class='hs-comment'>--</span>
<a name="line-1301"></a><span class='hs-comment'>--   Example:</span>
<a name="line-1302"></a><span class='hs-comment'>--</span>
<a name="line-1303"></a><span class='hs-comment'>-- &gt;            (  2 -1  0 )   (  1.41  0     0    )</span>
<a name="line-1304"></a><span class='hs-comment'>-- &gt;            ( -1  2 -1 )   ( -0.70  1.22  0    )</span>
<a name="line-1305"></a><span class='hs-comment'>-- &gt; cholDecomp (  0 -1  2 ) = (  0.00 -0.81  1.15 )</span>
<a name="line-1306"></a><span class='hs-definition'>cholDecomp</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Floating</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span>
<a name="line-1307"></a><span class='hs-definition'>cholDecomp</span> <span class='hs-varid'>a</span>
<a name="line-1308"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>nrows</span> <span class='hs-varid'>a</span> <span class='hs-varop'>==</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ncols</span> <span class='hs-varid'>a</span> <span class='hs-varop'>==</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>sqrt</span> <span class='hs-varid'>a</span>
<a name="line-1309"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>joinBlocks</span> <span class='hs-layout'>(</span><span class='hs-varid'>l11</span><span class='hs-layout'>,</span> <span class='hs-varid'>l12</span><span class='hs-layout'>,</span> <span class='hs-varid'>l21</span><span class='hs-layout'>,</span> <span class='hs-varid'>l22</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-1310"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>a11</span><span class='hs-layout'>,</span> <span class='hs-varid'>a12</span><span class='hs-layout'>,</span> <span class='hs-varid'>a21</span><span class='hs-layout'>,</span> <span class='hs-varid'>a22</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitBlocks</span> <span class='hs-num'>1</span> <span class='hs-num'>1</span> <span class='hs-varid'>a</span>
<a name="line-1311"></a>    <span class='hs-varid'>l11'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sqrt</span> <span class='hs-layout'>(</span><span class='hs-varid'>a11</span> <span class='hs-varop'>!</span> <span class='hs-layout'>(</span><span class='hs-num'>1</span><span class='hs-layout'>,</span><span class='hs-num'>1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1312"></a>    <span class='hs-varid'>l11</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromList</span> <span class='hs-num'>1</span> <span class='hs-num'>1</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>l11'</span><span class='hs-keyglyph'>]</span>
<a name="line-1313"></a>    <span class='hs-varid'>l12</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zero</span> <span class='hs-layout'>(</span><span class='hs-varid'>nrows</span> <span class='hs-varid'>a12</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ncols</span> <span class='hs-varid'>a12</span><span class='hs-layout'>)</span>
<a name="line-1314"></a>    <span class='hs-varid'>l21</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>scaleMatrix</span> <span class='hs-layout'>(</span><span class='hs-num'>1</span><span class='hs-varop'>/</span><span class='hs-varid'>l11'</span><span class='hs-layout'>)</span> <span class='hs-varid'>a21</span>
<a name="line-1315"></a>    <span class='hs-varid'>a22'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>a22</span> <span class='hs-comment'>-</span> <span class='hs-varid'>multStd</span> <span class='hs-varid'>l21</span> <span class='hs-layout'>(</span><span class='hs-varid'>transpose</span> <span class='hs-varid'>l21</span><span class='hs-layout'>)</span>
<a name="line-1316"></a>    <span class='hs-varid'>l22</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cholDecomp</span> <span class='hs-varid'>a22'</span>
<a name="line-1317"></a>
<a name="line-1318"></a><span class='hs-comment'>-------------------------------------------------------</span>
<a name="line-1319"></a><span class='hs-comment'>-------------------------------------------------------</span>
<a name="line-1320"></a><span class='hs-comment'>---- PROPERTIES</span>
<a name="line-1321"></a>
<a name="line-1322"></a><span class='hs-comment'>{-# RULES
<a name="line-1323"></a>"matrix/traceOfSum"
<a name="line-1324"></a>    forall a b. trace (a + b) = trace a + trace b
<a name="line-1325"></a>
<a name="line-1326"></a>"matrix/traceOfScale"
<a name="line-1327"></a>    forall k a. trace (scaleMatrix k a) = k * trace a
<a name="line-1328"></a>  #-}</span>
<a name="line-1329"></a>
<a name="line-1330"></a><a name="trace"></a><span class='hs-comment'>-- | Sum of the elements in the diagonal. See also 'getDiag'.</span>
<a name="line-1331"></a><span class='hs-comment'>--   Example:</span>
<a name="line-1332"></a><span class='hs-comment'>--</span>
<a name="line-1333"></a><span class='hs-comment'>-- &gt;       ( 1 2 3 )</span>
<a name="line-1334"></a><span class='hs-comment'>-- &gt;       ( 4 5 6 )</span>
<a name="line-1335"></a><span class='hs-comment'>-- &gt; trace ( 7 8 9 ) = 15</span>
<a name="line-1336"></a><span class='hs-definition'>trace</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Num</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span>
<a name="line-1337"></a><span class='hs-definition'>trace</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>sum</span> <span class='hs-varop'>.</span> <span class='hs-varid'>getDiag</span>
<a name="line-1338"></a>
<a name="line-1339"></a><a name="diagProd"></a><span class='hs-comment'>-- | Product of the elements in the diagonal. See also 'getDiag'.</span>
<a name="line-1340"></a><span class='hs-comment'>--   Example:</span>
<a name="line-1341"></a><span class='hs-comment'>--</span>
<a name="line-1342"></a><span class='hs-comment'>-- &gt;          ( 1 2 3 )</span>
<a name="line-1343"></a><span class='hs-comment'>-- &gt;          ( 4 5 6 )</span>
<a name="line-1344"></a><span class='hs-comment'>-- &gt; diagProd ( 7 8 9 ) = 45</span>
<a name="line-1345"></a><span class='hs-definition'>diagProd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Num</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span>
<a name="line-1346"></a><span class='hs-definition'>diagProd</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>V</span><span class='hs-varop'>.</span><span class='hs-varid'>product</span> <span class='hs-varop'>.</span> <span class='hs-varid'>getDiag</span>
<a name="line-1347"></a>
<a name="line-1348"></a><span class='hs-comment'>-- DETERMINANT</span>
<a name="line-1349"></a>
<a name="line-1350"></a><span class='hs-comment'>{-# RULES
<a name="line-1351"></a>"matrix/detLaplaceProduct"
<a name="line-1352"></a>    forall a b. detLaplace (a*b) = detLaplace a * detLaplace b
<a name="line-1353"></a>
<a name="line-1354"></a>"matrix/detLUProduct"
<a name="line-1355"></a>    forall a b. detLU (a*b) = detLU a * detLU b
<a name="line-1356"></a>  #-}</span>
<a name="line-1357"></a>
<a name="line-1358"></a><a name="detLaplace"></a><span class='hs-comment'>-- | Matrix determinant using Laplace expansion.</span>
<a name="line-1359"></a><span class='hs-comment'>--   If the elements of the 'Matrix' are instance of 'Ord' and 'Fractional'</span>
<a name="line-1360"></a><span class='hs-comment'>--   consider to use 'detLU' in order to obtain better performance.</span>
<a name="line-1361"></a><span class='hs-comment'>--   Function 'detLaplace' is /extremely/ slow.</span>
<a name="line-1362"></a><span class='hs-definition'>detLaplace</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Num</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span>
<a name="line-1363"></a><span class='hs-definition'>detLaplace</span> <span class='hs-varid'>m</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>M</span> <span class='hs-num'>1</span> <span class='hs-num'>1</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>m</span> <span class='hs-varop'>!</span> <span class='hs-layout'>(</span><span class='hs-num'>1</span><span class='hs-layout'>,</span><span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-1364"></a><span class='hs-definition'>detLaplace</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sum1</span> <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span><span class='hs-varop'>^</span><span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varop'>*</span> <span class='hs-varid'>m</span> <span class='hs-varop'>!</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varop'>*</span> <span class='hs-varid'>detLaplace</span> <span class='hs-layout'>(</span><span class='hs-varid'>minorMatrix</span> <span class='hs-varid'>i</span> <span class='hs-num'>1</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>1</span> <span class='hs-keyglyph'>..</span> <span class='hs-varid'>nrows</span> <span class='hs-varid'>m</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>]</span>
<a name="line-1365"></a>  <span class='hs-keyword'>where</span>
<a name="line-1366"></a>    <span class='hs-varid'>sum1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldl1'</span> <span class='hs-layout'>(</span><span class='hs-varop'>+</span><span class='hs-layout'>)</span>
<a name="line-1367"></a>
<a name="line-1368"></a><a name="detLU"></a><span class='hs-comment'>-- | Matrix determinant using LU decomposition.</span>
<a name="line-1369"></a><span class='hs-comment'>--   It works even when the input matrix is singular.</span>
<a name="line-1370"></a><span class='hs-definition'>detLU</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ord</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>Fractional</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Matrix</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span>
<a name="line-1371"></a><span class='hs-definition'>detLU</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>luDecomp</span> <span class='hs-varid'>m</span> <span class='hs-keyword'>of</span>
<a name="line-1372"></a>  <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>u</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>d</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>d</span> <span class='hs-varop'>*</span> <span class='hs-varid'>diagProd</span> <span class='hs-varid'>u</span>
<a name="line-1373"></a>  <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-num'>0</span>
</pre></body>
</html>
